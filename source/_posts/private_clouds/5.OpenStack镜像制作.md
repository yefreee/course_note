---
title: OpenStack镜像管理与制作（二）
date:  2023-10-06 11:00:09
tags:
---

## 虚拟机镜像制作方法

OpenStack平台所使用的镜像文件是一种虚拟机镜像，我们简称为镜像。而虚拟机镜像本质上是一个包含虚拟磁盘的单个文件，该虚拟磁盘上安装了可引导的操作系统。

上一节课已经介绍了通过下载官方预制的虚拟机镜像，这种途径获取到的镜像文件大都默认禁用SSH密码身份验证，同时包含`cloud-init`来支持SSH密钥对和用户数据的注入。通过密钥实现登录之后可以做进一步的定制，最后通过创建快照重新生成新的虚拟机镜像。

以上这种获取、修改、生成新的镜像的方法容易理解、实现过程简单，适用于需要进行轻度定制的场景。如果需要进行深度的定制或者需要定制特定平台的镜像文件时可以通过更多的途径制作镜像。

其他制作虚拟机镜像的方法：

* 通过工具（Guestfish,guestmount）修改虚拟机镜像
* 通过工具（Diskimage-builder）创建虚拟机镜像
* 手动创建虚拟机镜像

## fedora环境安装

### 使用samba获取fedora安装包

1. 学生机使用的是空白密码的账户，需要修改策略。

    * 按Windows + R键调出运行框，输入“gpedit.msc”命令以打开本地组策略编辑器，依次导航到：计算机配置 > Windows 设置 > 安全设置 > 本地策略 > 安全选项。

    <img src="https://vault.taojie.fun:28089/i/2023/10/09/2023-10-09-1696814955.png" alt="1696814955556.png" title="1696814955556.png" />

    * 在右侧窗格中找到“账户：使用空密码的本地账户只允许进行控制台登录”，然后双击打开，将其设置为“已禁用”，再单击“应用”和“确定”。

    <img src="https://vault.taojie.fun:28089/i/2023/10/09/2023-10-09-1696815014.png" alt="1696815014064.png" title="1696815014064.png" />

2. Windows + E打开文件资源管理器在搜索栏输入`//192.168.3.47`打开后将文件`Fedora-Workstation-Live-x86_64-38-1.6.iso`拉取到本地。

### 系统安装、配置

1. 使用VMware安装fedora系统，内存6G，密码设置时可以统一使用`000000`。

2. 进入桌面后打开fedora的文件共享。

    <img src="https://vault.taojie.fun:28089/i/2023/10/10/2023-10-10-1696913542.png" alt="1696913541159.png" title="1696913541159.png" />

## Guestfish使用

Guestfish是一个用于访问和修改虚拟机磁盘镜像的工具，它提供了一种交互式方式来浏览、修改虚拟机的文件系统。

### Guestfish安装

```shell
# sudo dnf -y install libguestfs-tools
```

### 获取需要修改的系统镜像

1. 在fedora系统中打开终端使用`ip a`获取ip地址。

2. 从samba共享的文件中拉取`WinSCP-5.19.3`，使用第一步中获取到的ip地址和fedora的账户密码登录会话。

    <img src="https://vault.taojie.fun:28089/i/2023/10/10/2023-10-10-1696913436.png" alt="1696913435653.png" title="1696913435653.png" />

3. 将本地D盘的`CentOS-7-x86_64-GenericCloud-2003.qcow2`文件拉取到fedora系统中。

### 镜像定制

* 在fedora桌面上打开终端执行命令替换国内源。

    ```shell
    sudo sed -e 's|^metalink=|#metalink=|g' \
         -e 's|^#baseurl=http://download.example/pub/fedora/linux|baseurl=https://mirrors.tuna.tsinghua.edu.cn/fedora|g' \
         -i.bak \
         /etc/yum.repos.d/fedora.repo \
         /etc/yum.repos.d/fedora-modular.repo \
         /etc/yum.repos.d/fedora-updates.repo \
         /etc/yum.repos.d/fedora-updates-modular.repo
    ```

* 执行执行`sudo dnf install openssl`安装openssl，执行`openssl passwd -1 123123`生成加密的字符串并`复制`用于设置root密码。

    <img src="https://vault.taojie.fun:28089/i/2023/10/09/2023-10-09-1696816865.png" alt="1696816865524.png" title="1696816865524.png" />

* 执行命令安装`libvirt`服务。

    ```shell
    sudo dnf install libvirt
    ```

* 修改libvirt配置，第442和446行。

    <img src="https://vault.taojie.fun:28089/i/2023/10/10/2023-10-10-1696912516.png" alt="1696912515114.png" title="1696912515114.png" />

* 启动libvirt服务。

    ```shell
    sudo systemctl start libvirtd
    ```

#### Guestfish用法示例

>定制内容是设置centos镜像的root和centos账户的直接登录，需要修改`/etc/shadow`和`/etc/cloud/cloud.cfg`两个文件。

1. 需要修改的虚拟机镜像文件名为`CentOS-7-x86_64-GenericCloud-2003.qcow2`，通过以下命令以root身份挂载为读写模式：

    ```shell
    # guestfish --rw -a CentOS-7-x86_64-GenericCloud-2003.qcow2

    Welcome to Guestfish, the libguestfs filesystem interactive shell for
    editing virtual machine filesystems.

    Type: 'help' for help on commands
    'man' to read the manual
    'quit' to quit the shell

    ><fs>
    ```

    >此时进入Guestfish的会话，提示符为`><fs>`

    <img src="https://vault.taojie.fun:28089/i/2023/10/09/2023-10-09-1696816715.png" alt="1696816715465.png" title="1696816715465.png" />

2. 首先在Guestfish提示符下使用`run`命令启动一个虚拟机才能执行其他操作，该虚拟机将用于执行所有文件操作。

    ```shell
    ><fs> run
    ```

3. 通过list-filesystems命令查看文件系统。

    ```shell
    ><fs> list-filesystems
    ```

    >作业1：上传显示的镜像分区信息。

4. 挂载包含根目录的分区并修改文件`/etc/shadow`用来给root账户设置密码。

    ```shell
    ><fs> mount /dev/sda1 /
    ```

    ```shell
    ><fs> vi /etc/shadow
    ```

    >在文件的第一行的第一、二个冒号中间插入之前复制的所生成的root密码。

    <img src="https://vault.taojie.fun:28089/i/2023/10/09/2023-10-09-1696817359.png" alt="1696817359200.png" title="1696817359200.png" />

5. 修改`/etc/cloud/cloud.cfg`文件。

    在第58行下添加`plain_text_passwd: '000000'`字段用来给centos用户设置初始密码`000000`。

    <img src="https://vault.taojie.fun:28089/i/2023/10/09/2023-10-09-1696817530.png" alt="1696817529748.png" title="1696817529748.png" />

6. 修改`/etc/rc.d/rc.local`文件，设置开机自启任务。

    ```shell
    yum install -y wget
    wget --no-check-certificate http://search.cpan.org/CPAN/authors/id/K/KB/KBAUCOM/Term-Animation-2.4.tar.gz -O /root/Term-Animation-2.4.tar.gz
    tar xf /root/Term-Animation-2.4.tar.gz -C /root
    cd /root/Term-Animation-2.4/

    yum install -y epel-release
    sed -i "s/#baseurl/baseurl/" /etc/yum.repos.d/epel.repo
    sed -i "s/metalink/#metalink/" /etc/yum.repos.d/epel.repo
    yum install -y perl-Curses
    yum install -y perl-ExtUtils-CBuilder perl-ExtUtils-MakeMaker
    cd /root/Term-Animation-2.4/  && perl Makefile.PL
    make
    make install

    wget --no-check-certificate http://www.robobunny.com/projects/asciiquarium/asciiquarium.tar.gz -O /root/asciiquarium.tar.gz
    tar -zxvf /root/asciiquarium.tar.gz -C /root
    cp /root/asciiquarium_1.1/asciiquarium /usr/local/bin
    chmod +x /usr/local/bin/asciiquarium
    ```

7. 执行脚本赋权。

    ```shell
    ><fs> chmod 777 /etc/rc.d/rc.local
    ```

8. 修改`/root/.bashrc`文件，设置bash自启动命令，添加以下命令。

    ```shell
    asciiquarium
    ```

9. 退出guestfish视图

    ```shell
    ><fs> exit
    ```

### 验证定制结果

1. 通过WinSCP将修改好的`CentOS-7-x86_64-GenericCloud-2003.qcow2`传输回本地的Windows。

2. 关闭fedora虚拟机、打开`控制节点`和`计算节点`，登录`192.168.10.20`，上传镜像到OpenStack、参考[创建虚拟机实例](https://abc.taojie.fun/2023/09/20/private_clouds/4.openstack%E9%95%9C%E5%83%8F%E7%AE%A1%E7%90%86/#%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%AE%9E%E4%BE%8B)创建Centos实例并使用root和centos账户登录，验证登录结果。

>作业2:上传登录后的截图

## Guestmount使用

`Guestmount`是一个用于挂载虚拟机磁盘镜像的工具，它允许在宿主机上将虚拟机磁盘镜像挂载为宿主机文件系统的一部分，从而可以直接访问和修改虚拟机镜像中的文件。Guestmount可以在不启动虚拟机的情况下进行操作，提供了对镜像中文件的读写访问权限。通过Guestmount，可以像操作本地文件系统一样，使用标准的文件操作命令（例如cp、mv、rm 等）

* Guestmount用法示例

    1. 假设需要修改的虚拟机镜像文件名为`centos63_desktop.img`，从该文件中挂载根分区到`/mnt`目录。

        ```shell
        # guestmount -a centos63_desktop.qcow2 -m /dev/vg_centosbase/lv_root --rw /mnt
        ```

    2. 当预先不知道具体的挂载点时可以通过选项`-i`自动决定所用的挂载点。

        ```shell
        # guestmount -a centos63_desktop.qcow2 -i --rw /mnt
        ```

    3. 修改完成后卸载挂载点。

        ```shell
        # umount /mnt
        ```

## Diskimage-builder使用

Diskimage-builder（DIB）是一个用于创建定制化操作系统磁盘镜像的工具。它是一个开源项目，旨在帮助开发者和系统管理员构建适合特定用途的操作系统镜像，例如用于虚拟机、容器、云平台等环境。

1. Diskimage-builder安装。

    ```shell
    # dnf install diskimage-builder
    ```

2. 创建一个通用的Ubuntu虚拟磁盘镜像。

    ```shell
    # disk-image-create ubuntu vm
    ```

3. 还可以通过设置命令行选项或者环境变量实现其他镜像的构造。

    ```shell
    # disk-image-create -a armhf ubuntu vm
    ```

4. 除此之外还可以通过YAML文件描述需要构造的镜像。

    ```yaml
    # 元素列表，表示构建镜像时要包含的元素
    elements:
    - centos7-minimal
    - install-packages

    # 镜像类型，指定生成的镜像格式
    image_types:
    - qcow2
    - raw

    # 操作系统发行版和版本
    release: centos7

    # 构建参数和配置
    properties:
    # 用户名和密码
    user: myuser
    password: mypassword
    ```

## 手动定制虚拟磁盘镜像

除了可以通过上述的工具在已有的虚拟磁盘文件的基础上进行修改以外还可以手动定制虚拟磁盘镜像，这个过程需要通过ISO CD文件安装操作系统后通过图形控制台远程配置虚拟机完成定制。主要分为以下几步：

1. 通过`kvm+qemu`方案安装操作系统虚拟机。

2. 通过`virt-viewer`连接虚拟机后实现进一步配置、定制。

3. 上传定制好的系统镜像到OpenStack平台完成验证。

### 操作系统虚拟机安装

#### 准备工作

1. 在安装系统之前需要获取系统安装包、VirtIO驱动，从samba服务器上拉取文件`cn_windows_server_2012_r2_with_update_x64_dvd_6052725.iso`和`virtio-win-0.1.185.iso`。

2. 创建大小为20G的qcow2格式的虚拟磁盘文件。

    ```shell
    [fedora@fedora ~]$ qemu-img create -f qcow2 ws2012.qcow2 20G
    Formatting 'ws2012.qcow2', fmt=qcow2 cluster_size=65536 extended_l2=off compression_type=zlib size=21474836480 lazy_refcounts=off refcount_bits=16
    ```

3. 安装虚拟化相关的软件包。

    ```shell
    # virt-install 是一个命令行工具，用于在虚拟化环境中创建和安装虚拟机
    # virt-manager是一个虚拟机管理工具
    # virt_viewer是一个用于查看虚拟机图形界面的工具
    [fedora@fedora ~]$ sudo dnf install -y qemu-kvm libvirt virt-install virt-manager virt-viewer
    ```

### windows-server系统安装

1. 执行virt-install命令启动Win-server操作系统。

    ```shell
    virt-install --connect qemu:///system \
    --name ws2012 --ram 2048 --vcpus 2 \
    --network network=default,model=virtio \
    --disk path=ws2012.qcow2,format=qcow2,device=disk,bus=virtio \
    --cdrom cn_windows_server_2012_r2_with_update_x64_dvd_6052725.iso \
    --disk path=virtio-win.iso,device=cdrom \
    --vnc --os-type windows --os-variant win2k12 \
    --boot cdrom,menu=on
    ```

2. 在图形终端中执行`virt-manager`打开虚拟机控制同。通过控制台登录启动的windows server虚拟机完成安装。

    > 系统密钥：NB4WH-BBBYV-3MPPC-9RCMV-46XCB

    <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696731826.png" alt="1696731825728.png" title="1696731825728.png" />

    > 安装系统时选择第二个带GUI桌面的标准版，安装方式选择第二个。

    <img src="https://vault.taojie.fun:28089/i/2023/10/09/2023-10-09-1696826963.png" alt="1696826962933.png" title="1696826962933.png" />

    <img src="https://vault.taojie.fun:28089/i/2023/10/09/2023-10-09-1696827045.png" alt="1696827044800.png" title="1696827044800.png" />

3. 选择`加载驱动程序`->`浏览`从以下路径加载scsi和网络驱动。

    > E:\virtio-win-0.1XX\viostor\2k12\amd64
    >  E:\NETKVM\2k12\amd64

    <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696737650.png" alt="1696737648562.png" title="1696737648562.png" />

4. 选择`驱动器0`、点下一步安装系统。

5. 系统安装完成后在虚拟机管理器中点击查看 -> 详情 -> 引导选项，选中VirtIO磁盘。

    <img src="https://vault.taojie.fun:28089/i/2023/10/09/2023-10-09-1696821264.png" alt="1696821263632.png" title="1696821263632.png" />

6. 重启虚拟机，在以下启动界面按ESC后选择第二个分区启动系统。

    <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696738960.png" alt="1696738959698.png" title="1696738959698.png" />

    <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696738975.png" alt="1696738974281.png" title="1696738974281.png" />

7. 进入系统后按下图配置允许远程登录、配置防火墙规则。

    <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696739234.png" alt="1696739233738.png" title="1696739233738.png" />

    <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696739246.png" alt="1696739245196.png" title="1696739245196.png" />

8. 启动命令行执行以下命令安装VirtIO驱动。

    ```powershell
    CD \
    C:\pnputil -i -a D:\viostor\2k12r2\amd64\*.INF
    ```

9. 设置PowerShell的执行策略为不受限制。

    ```powershell
    C:\powershell
    C:\Set-ExecutionPolicy Unrestricted
    ```

10. 下载Cloudbase-Init并安装。

    ```powershell
    C:\Invoke-WebRequest -UseBasicParsing https://cloudbase.it/downloads/CloudbaseInitSetup_Stable_ x64.msi -OutFile cloudbaseinit.msi
    C:\.\cloudbaseinit.msi
    ```

11. 启动安装向导后设置初始化选项、完成安装。

    <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696739848.png" alt="1696739847088.png" title="1696739847088.png" />

    <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696739861.png" alt="1696739859425.png" title="1696739859425.png" />

    <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696739904.png" alt="1696739903072.png" title="1696739903072.png" />

    <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696739923.png" alt="1696739922332.png" title="1696739922332.png" />

### 验证定制结果

将生成的`ws2012.qcow2`传到`控制节点`上、上传到OpenStack后启动实例。

```shell
scp ws2012.qcow2 root@192.168.10.10:/root
```

> 作业三：windows实例启动后截图上传。
