---
title: OpenStack镜像管理与制作（二）
date:  2023-10-06 11:00:09
tags:
---

## 虚拟机镜像制作方法

OpenStack平台所使用的镜像文件是一种虚拟机镜像，我们简称为镜像。而虚拟机镜像本质上是一个包含虚拟磁盘的单个文件，该虚拟磁盘上安装了可引导的操作系统。

上一节课已经介绍了通过下载官方预制的虚拟机镜像，这种途径获取到的镜像文件大都默认禁用SSH密码身份验证，同时包含`cloud-init`来支持SSH密钥对和用户数据的注入。通过密钥实现登录之后可以做进一步的定制，最后通过创建快照重新生成新的虚拟机镜像。

以上这种获取、修改、生成新的镜像的方法容易理解、实现过程简单，适用于需要进行轻度定制的场景。如果需要进行深度的定制或者需要定制特定平台的镜像文件时可以通过更多的途径制作镜像。

其他制作虚拟机镜像的方法：

* 通过工具（Guestfish,guestmount）修改虚拟机镜像
* 通过工具（Diskimage-builder）创建虚拟机镜像
* 手动创建虚拟机镜像

## fedora环境安装

1. 用浏览器下载fedora镜像

2. 使用VMware安装fedora系统，内存4G。

3. 进入桌面后打开fedora的远程连接。

    <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696740814.png" alt="1696740813374.png" title="1696740813374.png" />

4. 打开fedora终端下载以下资源。

    ```shell
    wget https://download.cirros-cloud.net/0.5.1/cirros-0.5.1-x86_64-disk.img &
    wget https://go.microsoft.com/fwlink/p/?LinkID=2195443&clcid=0x804&culture=zh-cn&country=CN -O winserver-2012.iso &
    wget https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso &
    ```

## Guestfish使用

Guestfish是一个用于访问和修改虚拟机磁盘镜像的工具，它提供了一种交互式方式来浏览、修改虚拟机的文件系统。

1. Guestfish安装

   ```shell
   # sudo dnf -y install libguestfs-tools
   ```

2. Guestfish用法示例

   1. 假设需要修改的虚拟机镜像文件名为`centos63_desktop.img`，通过以下命令以root身份挂载为读写模式：

        ```shell
        # guestfish --rw -a centos63_desktop.img

        Welcome to Guestfish, the libguestfs filesystem interactive shell for
        editing virtual machine filesystems.

        Type: 'help' for help on commands
        'man' to read the manual
        'quit' to quit the shell

        ><fs>
        ```

        > 此时进入Guestfish的会话，提示符为`><fs>`

   2. 首先在Guestfish提示符下使用`run`命令启动一个虚拟机才能执行其他操作，该虚拟机将用于执行所有文件操作。

        ```shell
        ><fs> run
        ```

   3. 通过list-filesystems命令查看文件系统。

        ```shell
        ><fs> list-filesystems
        /dev/vda1: ext4
        /dev/vg_centosbase/lv_root: ext4
        /dev/vg_centosbase/lv_swap: swap
        ```

   4. 挂载包含根分区的逻辑卷并修改文件。

        ```shell
        ><fs> mount /dev/vg_centosbase/lv_root /
        ```

        ```shell
        ><fs> rm /etc/udev/rules.d/70-persistent-net.rules
        ```

        ```shell
        ><fs> edit /etc/sysconfig/network-scripts/ifcfg-eth0
        ```

        ```shell
        ><fs> exit
        ```

## Guestmount使用

`Guestmount`是一个用于挂载虚拟机磁盘镜像的工具，它允许在宿主机上将虚拟机磁盘镜像挂载为宿主机文件系统的一部分，从而可以直接访问和修改虚拟机镜像中的文件。Guestmount可以在不启动虚拟机的情况下进行操作，提供了对镜像中文件的读写访问权限。通过Guestmount，可以像操作本地文件系统一样，使用标准的文件操作命令（例如cp、mv、rm 等）

* Guestmount用法示例

    1. 假设需要修改的虚拟机镜像文件名为`centos63_desktop.img`，从该文件中挂载根分区到`/mnt`目录。

        ```shell
        # guestmount -a centos63_desktop.qcow2 -m /dev/vg_centosbase/lv_root --rw /mnt
        ```

    2. 当预先不知道具体的挂载点时可以通过选项`-i`自动决定所用的挂载点。

        ```shell
        # guestmount -a centos63_desktop.qcow2 -i --rw /mnt
        ```

    3. 修改完成后卸载挂载点。

        ```shell
        # umount /mnt
        ```

## Diskimage-builder使用

Diskimage-builder（DIB）是一个用于创建定制化操作系统磁盘镜像的工具。它是一个开源项目，旨在帮助开发者和系统管理员构建适合特定用途的操作系统镜像，例如用于虚拟机、容器、云平台等环境。

1. Diskimage-builder安装。

    ```shell
    # dnf install diskimage-builder
    ```

2. 创建一个通用的Ubuntu虚拟磁盘镜像。

    ```shell
    # disk-image-create ubuntu vm
    ```

3. 还可以通过设置命令行选项或者环境变量实现其他镜像的构造。

    ```shell
    # disk-image-create -a armhf ubuntu vm
    ```

4. 除此之外还可以通过YAML文件描述需要构造的镜像。

    ```yaml
    # 元素列表，表示构建镜像时要包含的元素
    elements:
    - centos7-minimal
    - install-packages

    # 镜像类型，指定生成的镜像格式
    image_types:
    - qcow2
    - raw

    # 操作系统发行版和版本
    release: centos7

    # 构建参数和配置
    properties:
    # 用户名和密码
    user: myuser
    password: mypassword
    ```

## 手动定制虚拟磁盘镜像

除了可以通过上述的工具在已有的虚拟磁盘文件的基础上进行修改以外还可以手动定制虚拟磁盘镜像，这个过程需要通过ISO CD文件安装操作系统后通过图形控制台远程配置虚拟机完成定制。主要分为以下几步：

1. 通过`kvm+qemu`方案安装操作系统虚拟机。

2. 通过`virt-viewer`连接虚拟机后实现进一步配置、定制。

3. 上传定制好的系统镜像到OpenStack平台完成验证。

### 操作系统虚拟机安装

#### 准备工作

1. 在安装系统之前需要获取系统安装包、VirtIO驱动，上面步骤已经提前下载好。

    ```shell
    # 下载Windows Server 2012的软件安装包
    [fedora@fedora ~]$ wget https://go.microsoft.com/fwlink/p/?LinkID=2195443&clcid=0x804&culture=zh-cn&country=CN -O winserver-2012.iso &
    ```

    ```shell
    # 下载适用的VirtIO驱动文件
    [fedora@fedora ~]$ wget https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso &
    ```

2. 创建大小为15G的qcow2格式的虚拟磁盘文件。

    ```shell
    [fedora@fedora ~]$ qemu-img create -f qcow2 ws2012.qcow2 15G
    Formatting 'ws2012.qcow2', fmt=qcow2 size=16106127360 cluster_size=65536 lazy_refcounts=off refcount_bits=16
    ```

3. 安装虚拟化相关的软件包。

    ```shell
    # virt-install 是一个命令行工具，用于在虚拟化环境中创建和安装虚拟机
    # virt-manager是一个虚拟机管理工具
    # virt_viewer是一个用于查看虚拟机图形界面的工具
    [fedora@fedora ~]$ sudo dnf install -y qemu-kvm libvirt virt-install virt-manager virt-viewer
    ```

4. 执行virt-install命令启动Win-server操作系统。

    ```shell
    virt-install --connect qemu:///system \
    --name ws2012 --ram 2048 --vcpus 2 \
    --network network=default,model=virtio \
    --disk path=ws2012.qcow2,format=qcow2,device=disk,bus=virtio \
    --cdrom winserver-2012.iso \
    --disk path=virtio-win.iso,device=cdrom \
    --vnc --os-type windows --os-variant win2k12 \
    --boot cdrom,menu=on
    ```

5. 通过virt-viewer控制台登录启动的windows server虚拟机完成安装。

    <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696731826.png" alt="1696731825728.png" title="1696731825728.png" />

    > 安装系统时选择第二个带GUI桌面的标准版。
    <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696731966.png" alt="1696731965295.png" title="1696731965295.png" />

    <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696737341.png" alt="1696737340360.png" title="1696737340360.png" />

6. 选择`Load driver`加载scsi驱动。

    > E:\virtio-win-0.1XX\viostor\2k12\amd64
    >  E:\NETKVM\2k12\amd64

    <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696737650.png" alt="1696737648562.png" title="1696737648562.png" />

7. 重启虚拟机，在以下启动界面按ESC后选择第二个分区启动系统。

    <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696738960.png" alt="1696738959698.png" title="1696738959698.png" />

    <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696738975.png" alt="1696738974281.png" title="1696738974281.png" />

8. 进入系统后按下图配置允许远程登录、配置防火墙规则。

    <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696739234.png" alt="1696739233738.png" title="1696739233738.png" />

    <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696739246.png" alt="1696739245196.png" title="1696739245196.png" />

9. 启动命令行执行以下命令安装VirtIO驱动。

    ```powershell
    CD \
    C:\pnputil -i -a D:\viostor\2k12r2\amd64\*.INF
    ```

10. 设置PowerShell的执行策略为不受限制。

    ```powershell
    C:\powershell
    C:\Set-ExecutionPolicy Unrestricted
    ```

11. 下载Cloudbase-Init并安装。

    ```powershell
    C:\Invoke-WebRequest -UseBasicParsing https://cloudbase.it/downloads/CloudbaseInitSetup_Stable_ x64.msi -OutFile cloudbaseinit.msi
    C:\.\cloudbaseinit.msi
    ```

12. 启动安装向导后设置初始化选项、完成安装。

    <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696739848.png" alt="1696739847088.png" title="1696739847088.png" />

    <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696739861.png" alt="1696739859425.png" title="1696739859425.png" />

    <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696739904.png" alt="1696739903072.png" title="1696739903072.png" />

    <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696739923.png" alt="1696739922332.png" title="1696739922332.png" />

13. 将生成的`ws2012.qcow2`传到`控制节点`上、上传到OpenStack后启动实例。

    ```shell
    scp ws2012.qcow2 root@192.168.10.10:/root
    ```
