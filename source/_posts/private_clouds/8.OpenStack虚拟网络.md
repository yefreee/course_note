---
title: OpenStack虚拟网络
date:  2023-10-28 19:18:37
tags:
---

## OpenStack虚拟网络结构

Neutron是一个用Python写的分布式软件项目，用来实现OpenStack中的虚拟网络服务，实现软件定义网络。

<img src="https://vault.taojie.fun:28089/i/2023/10/30/2023-10-30-1698634048.png" alt="1698634048202.png" title="1698634048202.png" />

OpenStack 提供了几种不同类型的网络，以满足不同的网络需求。以下是一些常见的 OpenStack 网络类型：

按照网络的实现原理：

1. Flat Network（扁平网络）：这是最简单的网络类型，所有虚拟机实例共享同一个扁平的网络。在这种网络中，虚拟机实例通过虚拟交换机直接连接到物理网络。一般适用于简单的测试环境或不需要网络隔离的场景。

    >Linux Bridge直接与物联网卡相连
    >每个Flat独占一个物理网卡

    <img src="https://vault.taojie.fun:28089/i/2023/10/30/2023-10-30-1698634701.png" alt="1698634700994.png" title="1698634700994.png" />

2. VLAN Network（VLAN 网络）：VLAN 网络通过使用 VLAN 标签对虚拟机实例进行隔离。在这种网络中，物理网络上的不同 VLAN 标签对应不同的虚拟网络。虚拟机实例通过虚拟交换机连接到特定的 VLAN 网络，实现网络隔离。

    >在基于linux bridge的vlan网络中，eht1物理网卡上创建了两个vlan接口，1.1连接到qbr1网桥，1.2连接到了qbr2网桥。在这种情况下vm通过eth1.1或者eth1.2发送到eth1的包会被打上各自的vlan id。此时vm2和vm3属于同一个network所以是互通的，vm与vm2和vm3不通。
    <img src="https://vault.taojie.fun:28089/i/2023/10/30/2023-10-30-1698634722.png" alt="1698634722145.png" title="1698634722145.png" />

3. VXLAN Network（VXLAN 网络）：VXLAN 网络使用 VXLAN 封装技术在底层物理网络上创建逻辑隧道，以实现虚拟机实例之间的隔离和通信。VXLAN 网络可以扩展到更大的规模，并提供更多的虚拟网络隔离。

4. GRE Network（GRE 网络）：GRE 网络使用通用路由封装（Generic Routing Encapsulation）协议在底层物理网络上创建隧道，以实现虚拟机实例之间的隔离和通信。GRE 网络可以在不同物理网络之间建立逻辑连接。

按照网络的从属关系可以分为以下两类：

1. Provider Network（提供者网络）：提供者网络是指与外部网络或互联网连接的网络。它可以是物理网络中的一个 VLAN 或直接连接到外部网络。提供者网络通常用于连接虚拟机实例到互联网或外部资源。

    <img src="https://vault.taojie.fun:28089/i/2023/10/30/2023-10-30-1698642331.png" alt="1698642331350.png" title="1698642331350.png" />

    <img src="https://vault.taojie.fun:28089/i/2023/10/30/2023-10-30-1698642247.png" alt="1698642246577.png" title="1698642246577.png" />

2. Self-Service Network（自服务网络）：自服务网络是为虚拟机实例创建的私有网络。它可以通过路由器与提供者网络连接，使虚拟机实例能够访问外部网络。自服务网络通常用于为用户提供独立的、可管理的网络环境。

    <img src="https://vault.taojie.fun:28089/i/2023/10/30/2023-10-30-1698642266.png" alt="1698642265910.png" title="1698642265910.png" />

    <img src="https://vault.taojie.fun:28089/i/2023/10/30/2023-10-30-1698642316.png" alt="1698642315973.png" title="1698642315973.png" />

## Neutron服务部署

### 基础配置

1. 开启网卡的混杂模式。

    ```shell
    [root@controller ~]# ifconfig ens34 promisc
    [root@compute ~]# ifconfig ens34 promisc
    ```

### 控制节点服务配置

1. 安装网络组件。

    ```shell
    [root@controller ~]# yum -y install openstack-neutron openstack-neutron-ml2  openstack-neutron-linuxbridge ebtables
    ```

2. 创建数据库。

    ```shell
    MariaDB [(none)]> CREATE DATABASE neutron;
    MariaDB [(none)]> GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'localhost' IDENTIFIED BY '000000';
    MariaDB [(none)]> GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'%' IDENTIFIED BY '000000';
    ```

3. 加载admin用户的环境脚本。

4. 创建Neutron服务的用户、分配角色、创建服务。

    ```shell
    [root@controller ~]# openstack user create --domain default --password 000000 neutron
    [root@controller ~]# openstack role add --project project --user neutron admin
    [root@controller ~]# openstack service create --name neutron network
    [root@controller ~]# openstack endpoint create --region RegionOne  network public http://controller:9696
    [root@controller ~]# openstack endpoint create --region RegionOne  network internal http://controller:9696
    [root@controller ~]# openstack endpoint create --region RegionOne  network admin http://controller:9696
    ```

5. 备份配置文件`/etc/neutron/neutron.conf`、`/etc/neutron/plugins/ml2/ml2_config.ini`、`/etc/neutron/plugins/ml2/linuxbridge_agent.ini`、`/etc/neutron/dhcp-agent.ini`。

6. 使用`grep -Ev '^$|#'`命令将配置文件中的注释行和空行删除。

7. 配置`/etc/neutron/neutron.conf`。

    ```shell
    [DEFAULT]
    core_plugin = ml2
    service_plugins = router
    transport_url = rabbit://rabbitmq:000000@controller
    auth_strategy = keystone
    notify_nova_on_port_status_changes = true
    notify_nova_on_port_data_changes = true
    allow_overlapping_ips = true
    [cors]
    [database]
    connection = mysql+pymysql://neutron:000000@controller/neutron
    [keystone_authtoken]
    auth_url = http://controller:5000
    memcached_servers = controller:11211
    auth_type = password
    project_domain_name = Default
    user_domain_name = Default
    project_name = project
    username = neutron
    password = 000000
    [oslo_concurrency]
    lock_path = /var/lib/neutron/tmp
    [nova]
    auth_url = http://controller:5000
    auth_type = password
    project_domain_name = default
    user_domain_name = default
    project_name = project
    username = nova
    password = 000000
    region_name = RegionOne
    server_proxyclient_address = 192.168.10.10
    ```

8. 配置`/etc/neutron/plugins/ml2/linuxbridge_agent.ini`。

    ```shell
    [DEFAULT]
    [linux_bridge]
    physical_interface_mappings = provider:ens34

    [vxlan]
    enable_vxlan = true
    local_ip = 192.168.10.10
    l2_population = true

    [securitygroup]
    enable_security_group = true
    firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver
    ```

9. 配置`/etc/neutron/plugins/ml2/ml2_conf.ini`。

    ```shell
    [DEFAULT]
    [ml2]
    type_drivers = flat,vlan,vxlan
    tenant_network_types = vxlan
    mechanism_drivers = linuxbridge,l2population
    extension_drivers = port_security

    [ml2_type_flat]
    flat_networks = provider

    [ml2_type_vxlan]
    vni_ranges = 1:1000

    [securitygroup]
    enable_ipset = true
    ```

10. 配置`/etc/neutron/dhcp-agent.ini`。

    ```shell
    [DEFAULT]
    interface_driver = linuxbridge
    dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq
    enable_isolated_metadata = true
    ```

11. 配置`/etc/neutron/metadata_agent.ini`[DEFAULT]字段。

    ```shell
    [DEFAULT]
    nova_metadata_host = controller
    metadata_proxy_shared_secret = METADATA_SECRET
    ```

12. 配置`/etc/nova/nova.conf`。

    ```shell
    [neutron]
    auth_url = http://controller:5000
    auth_type = password
    project_domain_name = default
    user_domain_name = default
    region_name = RegionOne
    project_name = project
    username = neutron
    password = 000000
    service_metadata_proxy = true
    metadata_proxy_shared_secret = METADATA_SECRET
    ```

13. 初始化数据库。

    ```shell
    [root@controller ~]# su -s /bin/sh -c "neutron-db-manage --config-file /etc/neutron/neutron.conf --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head"
    ```

14. 重启nova，启动控制节点的Neutron服务。

    ```shell
    [root@controller ~]# systemctl restart openstack-nova-api
    ```

    ```shell
    [root@controller ~]# systemctl enable neutron-server neutron-linuxbridge-agent neutron-dhcp-agent neutron-metadata-agent neutron-l3-agent
    [root@controller ~]# systemctl start neutron-server neutron-linuxbridge-agent neutron-dhcp-agent neutron-metadata-agent neutron-l3-agent
    ```

15. 查看服务运行状态。

    ```shell
    [root@controller ~]# systemctl status neutron-server
    ```

### 计算节点服务配置

1. 安装所需软件包。

    ```shell
    [root@controller ~]# yum -y install openstack-neutron-linuxbridge ebtables ipset
    ```

2. 备份`/etc/neutron/neutron.conf`、`/etc/neutron/plugins/ml2/linuxbridge_agent.ini`。

3. 使用`grep -Ev '^$|#'`处理配置文件的空行和注释行。

4. 编辑`/etc/neutron/neutron.conf`配置文件。

    ```shell
    [DEFAULT]
    transport_url = rabbit://rabbitmq:000000@controller:5672
    auth_strategy = keystone

    [cors]
    [database]

    [keystone_authtoken]
    auth_url = http://controller:5000
    memcached_servers = controller:11211
    auth_type = password
    project_domain_name = default
    user_domain_name = default
    project_name = project
    username = neutron
    password = 000000
    [oslo_concurrency]
    lock_path = /var/lib/neutron/tmp
    ```

5. 编辑`/etc/neutron/plugins/ml2/linuxbridge_agent.ini`。

    ```shell
    [DEFAULT]
    [linux_bridge]
    physical_interface_mappings = provider:ens34

    [vxlan]
    enable_vxlan = false

    [securitygroup]
    enable_security_group = true
    firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver
    ```

6. 修改Nova配置文件`/etc/nova/nova.conf`。

    [DEFAULT]部分增加两行

    ```shell
    vif_plugging_is_fatal = false
    vif_plugging_timeout = 0
    ```

    [neutron]增加

    ```shell
    auth_url = http://controller:5000
    auth_type = password
    project_domain_name = default
    user_domain_name = default
    region_name = RegionOne
    project_name = project
    username = neutron
    password = 000000
    ```

7. 启动neutron服务。

    ```shell
    [root@compute ~]#  systemctl restart openstack-nova-compute
    [root@compute ~]#  systemctl enable neutron-linuxbridge-agent
    [root@compute ~]#  systemctl start neutron-linuxbridge-agent
    ```

8. 检测Neutron状态。

    ```shell
    [root@controller ~]# neutron-status upgrade check
    ```

    >作业1：显示neutron状态后截图
