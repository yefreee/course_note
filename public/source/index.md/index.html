<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.17.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title">
<meta property="og:url" content="http://example.com/source/index.md/index.html">
<meta property="og:site_name">
<meta property="og:locale" content="zh_CN">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/source/index.md/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"source/index.md/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title></title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title"></h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">29</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/16/private_clouds/13.OpenStack%E8%BF%90%E7%BB%B4%E6%A1%88%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/12/16/private_clouds/13.OpenStack%E8%BF%90%E7%BB%B4%E6%A1%88%E4%BE%8B/" class="post-title-link" itemprop="url">OpenStack运维案例</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-12-16 14:19:59" itemprop="dateCreated datePublished" datetime="2023-12-16T14:19:59+08:00">2023-12-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-12-18 10:39:47" itemprop="dateModified" datetime="2023-12-18T10:39:47+08:00">2023-12-18</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="案例一：开放镜像权限"><a href="#案例一：开放镜像权限" class="headerlink" title="案例一：开放镜像权限"></a>案例一：开放镜像权限</h2><h3 id="案例描述"><a href="#案例描述" class="headerlink" title="案例描述"></a>案例描述</h3><p>某OpenStack云平台有两个租户，A租户与B租户，分别属于两个部门，该公司对镜像的管理比较严格，镜像都由管理员进行上传和权限管理。</p>
<p>该公司有一个镜像，需要共享给A租户使用，对B租户不可见，实现这种方式最简单的方式，是由A租户中的用户自行上传镜像，这样A租户里面的用户可以看见该镜像，而B租户中的用户看不见。但是现在镜像不能由普通用户去上传，只能通过管理员进行操作。</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>通过管理员上传该镜像，并使用相关命令开放给A租户。</p>
<h3 id="案例实施"><a href="#案例实施" class="headerlink" title="案例实施"></a>案例实施</h3><ol>
<li><p>openstack Horizon登录，以及命令行环境下的认证。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># source /etc/keystone/admin-openrc.sh</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>使用Horizon图形和命令行的方式分别创建项目projectA和projectB、用户userA和userB。</p>
<p> Horizon图形创建项目：</p>
 <img src="https://vault.taojie.fun:28089/i/2023/12/18/2023-12-18-1702856058.png" alt="1702856058602.png" title="1702856058602.png" />

<p> Horizon图形创建用户：</p>
 <img src="https://vault.taojie.fun:28089/i/2023/12/18/2023-12-18-1702856127.png" alt="1702856127136.png" title="1702856127136.png" />

<p> OpenStack Cli工具创建项目：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack project create --domain xiandian projectB</span>
+-------------+----------------------------------+
<span class="token operator">|</span> Field       <span class="token operator">|</span> Value                            <span class="token operator">|</span>
+-------------+----------------------------------+
<span class="token operator">|</span> description <span class="token operator">|</span>                                  <span class="token operator">|</span>
<span class="token operator">|</span> domain_id   <span class="token operator">|</span> 9321f21a94ef4f85993e92a228892418 <span class="token operator">|</span>
<span class="token operator">|</span> enabled     <span class="token operator">|</span> True                             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token function">id</span>          <span class="token operator">|</span> 691c3f10dd3442d388b3a0c8c6d98ef9 <span class="token operator">|</span>
<span class="token operator">|</span> is_domain   <span class="token operator">|</span> False                            <span class="token operator">|</span>
<span class="token operator">|</span> name        <span class="token operator">|</span> projectB                         <span class="token operator">|</span>
<span class="token operator">|</span> parent_id   <span class="token operator">|</span> 9321f21a94ef4f85993e92a228892418 <span class="token operator">|</span>
+-------------+----------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> OpenStack Cli工具创建用户：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack user create --domain xiandian --project projectB --password 000000 userB</span>
+--------------------+----------------------------------+
<span class="token operator">|</span> Field              <span class="token operator">|</span> Value                            <span class="token operator">|</span>
+--------------------+----------------------------------+
<span class="token operator">|</span> default_project_id <span class="token operator">|</span> 691c3f10dd3442d388b3a0c8c6d98ef9 <span class="token operator">|</span>
<span class="token operator">|</span> domain_id          <span class="token operator">|</span> 9321f21a94ef4f85993e92a228892418 <span class="token operator">|</span>
<span class="token operator">|</span> enabled            <span class="token operator">|</span> True                             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token function">id</span>                 <span class="token operator">|</span> fbe7fe015baa49fe9854c76f446be330 <span class="token operator">|</span>
<span class="token operator">|</span> name               <span class="token operator">|</span> userB                            <span class="token operator">|</span>
+--------------------+----------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> OpenStack Cli工具授予用户角色：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack role add --project projectB --user userB user</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> 创建完成后通过图形界面验证，projectA项目下有成员userA。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/12/18/2023-12-18-1702856747.png" alt="1702856747284.png" title="1702856747284.png" />

<p> 创建完成后通过命令行验证，projectB项目下有成员userB。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack role assignment list --project projectB</span>
+----------------------------------+----------------------------------+-------+----------------------------------+--------+-----------+
<span class="token operator">|</span> Role                             <span class="token operator">|</span> User                             <span class="token operator">|</span> Group <span class="token operator">|</span> Project                          <span class="token operator">|</span> Domain <span class="token operator">|</span> Inherited <span class="token operator">|</span>
+----------------------------------+----------------------------------+-------+----------------------------------+--------+-----------+
<span class="token operator">|</span> 6280f11c992f4b94a9d04e349150a14f <span class="token operator">|</span> fbe7fe015baa49fe9854c76f446be330 <span class="token operator">|</span>       <span class="token operator">|</span> 691c3f10dd3442d388b3a0c8c6d98ef9 <span class="token operator">|</span>        <span class="token operator">|</span> False     <span class="token operator">|</span>
+----------------------------------+----------------------------------+-------+----------------------------------+--------+-----------+
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack user list</span>
+----------------------------------+-------------------+
<span class="token operator">|</span> ID                               <span class="token operator">|</span> Name              <span class="token operator">|</span>
+----------------------------------+-------------------+
<span class="token operator">|</span> 08e8c7f2ae044cda95935cf78d0e679c <span class="token operator">|</span> demo              <span class="token operator">|</span>
<span class="token operator">|</span> 0befa70f767848e39df8224107b71858 <span class="token operator">|</span> admin             <span class="token operator">|</span>
<span class="token operator">|</span> 0f980d5fefa6448a9c52f5c0ae5813a5 <span class="token operator">|</span> ceilometer        <span class="token operator">|</span>
<span class="token operator">|</span> 1bd5ab1614274bf4bf62bd8bdfac32f2 <span class="token operator">|</span> nova              <span class="token operator">|</span>
<span class="token operator">|</span> 25e931e21026434bb73f5ebd92646671 <span class="token operator">|</span> heat_domain_admin <span class="token operator">|</span>
<span class="token operator">|</span> 461e8dbbbada466b8d6fe7998c28f7fd <span class="token operator">|</span> glance            <span class="token operator">|</span>
<span class="token operator">|</span> 4c6eaa79772b4964abd69972531255a9 <span class="token operator">|</span> neutron           <span class="token operator">|</span>
<span class="token operator">|</span> 6b7634fa0b9242599d1f349722f103bf <span class="token operator">|</span> heat              <span class="token operator">|</span>
<span class="token operator">|</span> 7e0a30881708428a912fb28ad00e8eed <span class="token operator">|</span> userA             <span class="token operator">|</span>
<span class="token operator">|</span> c701f9c0e49c4a5ab485328afff0ae1a <span class="token operator">|</span> aodh              <span class="token operator">|</span>
<span class="token operator">|</span> c9670cb3d60349e69fc019360a61aef4 <span class="token operator">|</span> cinder            <span class="token operator">|</span>
<span class="token operator">|</span> e57fa54fe8724ab89e619df0ee46153d <span class="token operator">|</span> swift             <span class="token operator">|</span>
<span class="token operator">|</span> fbe7fe015baa49fe9854c76f446be330 <span class="token operator">|</span> userB             <span class="token operator">|</span>
+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>Horizon图形中在管理员菜单中上传<code>两次</code>镜像cirros，分别设置镜像不同的公有属性。</p>
</li>
<li><p>此时的镜像不公开，无论是projectA和projectB下的用户都不能看到。</p>
</li>
<li><p>设置cirros镜像对projectA公开。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack image add project cirros projectA</span>
+------------+--------------------------------------+
<span class="token operator">|</span> Field      <span class="token operator">|</span> Value                                <span class="token operator">|</span>
+------------+--------------------------------------+
<span class="token operator">|</span> created_at <span class="token operator">|</span> <span class="token number">2023</span>-12-18T07:55:27Z                 <span class="token operator">|</span>
<span class="token operator">|</span> image_id   <span class="token operator">|</span> d09bd414-6f37-4531-966f-80d7493d1ae5 <span class="token operator">|</span>
<span class="token operator">|</span> member_id  <span class="token operator">|</span> 2454a718118b4e208a1ab08e1fbd7650     <span class="token operator">|</span>
<span class="token operator">|</span> schema     <span class="token operator">|</span> /v2/schemas/member                   <span class="token operator">|</span>
<span class="token operator">|</span> status     <span class="token operator">|</span> pending                              <span class="token operator">|</span>
<span class="token operator">|</span> updated_at <span class="token operator">|</span> <span class="token number">2023</span>-12-18T07:55:27Z                 <span class="token operator">|</span>
+------------+--------------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>切换userA和userB查看各用户对不同镜像的可见性。</p>
<blockquote>
<p>作业1：查看用户userA在Horizon图形界面下的镜像列表。</p>
</blockquote>
</li>
</ol>
<h2 id="案例二：利用Heat编排wordpress"><a href="#案例二：利用Heat编排wordpress" class="headerlink" title="案例二：利用Heat编排wordpress"></a>案例二：利用Heat编排wordpress</h2><h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">heat_template_version</span><span class="token punctuation">:</span> <span class="token datetime number">2013-05-23</span>

<span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token punctuation">></span><span class="token scalar string">
  Heat WordPress template to support F20, using only Heat OpenStack-native
  resource types, and without the requirement for heat-cfntools in the image.
  WordPress is web software you can use to create a beautiful website or blog.
  This template installs a single-instance WordPress deployment using a local
  MySQL database to store the data.  </span>

<span class="token key atrule">parameters</span><span class="token punctuation">:</span>

  <span class="token key atrule">key_name</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> string
    <span class="token key atrule">description</span><span class="token punctuation">:</span> Name of a KeyPair to enable SSH access to the instance
  <span class="token key atrule">instance_type</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> string
    <span class="token key atrule">description</span><span class="token punctuation">:</span> Instance type for WordPress server
    <span class="token key atrule">default</span><span class="token punctuation">:</span> m1.small
  <span class="token key atrule">image_id</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> string
    <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token punctuation">></span><span class="token scalar string">
      Name or ID of the image to use for the WordPress server.
      Recommended values are fedora-20.i386 or fedora-20.x86_64;
      get them from http://cloud.fedoraproject.org/fedora-20.i386.qcow2
      or http://cloud.fedoraproject.org/fedora-20.x86_64.qcow2 .      </span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span> fedora<span class="token punctuation">-</span>20.x86_64

  <span class="token key atrule">db_name</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> string
    <span class="token key atrule">description</span><span class="token punctuation">:</span> WordPress database name
    <span class="token key atrule">default</span><span class="token punctuation">:</span> wordpress
    <span class="token key atrule">constraints</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">length</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">min</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token key atrule">max</span><span class="token punctuation">:</span> <span class="token number">64</span> <span class="token punctuation">&#125;</span>
        <span class="token key atrule">description</span><span class="token punctuation">:</span> db_name must be between 1 and 64 characters
      <span class="token punctuation">-</span> <span class="token key atrule">allowed_pattern</span><span class="token punctuation">:</span> <span class="token string">'[a-zA-Z][a-zA-Z0-9]*'</span>
        <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token punctuation">></span><span class="token scalar string">
          db_name must begin with a letter and contain only alphanumeric
          characters          </span>
  <span class="token key atrule">db_username</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> string
    <span class="token key atrule">description</span><span class="token punctuation">:</span> The WordPress database admin account username
    <span class="token key atrule">default</span><span class="token punctuation">:</span> admin
    <span class="token key atrule">hidden</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">constraints</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">length</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">min</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token key atrule">max</span><span class="token punctuation">:</span> <span class="token number">16</span> <span class="token punctuation">&#125;</span>
        <span class="token key atrule">description</span><span class="token punctuation">:</span> db_username must be between 1 and 16 characters
      <span class="token punctuation">-</span> <span class="token key atrule">allowed_pattern</span><span class="token punctuation">:</span> <span class="token string">'[a-zA-Z][a-zA-Z0-9]*'</span>
        <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token punctuation">></span><span class="token scalar string">
          db_username must begin with a letter and contain only alphanumeric
          characters          </span>
  <span class="token key atrule">db_password</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> string
    <span class="token key atrule">description</span><span class="token punctuation">:</span> The WordPress database admin account password
    <span class="token key atrule">default</span><span class="token punctuation">:</span> admin
    <span class="token key atrule">hidden</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">constraints</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">length</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">min</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token key atrule">max</span><span class="token punctuation">:</span> <span class="token number">41</span> <span class="token punctuation">&#125;</span>
        <span class="token key atrule">description</span><span class="token punctuation">:</span> db_password must be between 1 and 41 characters
      <span class="token punctuation">-</span> <span class="token key atrule">allowed_pattern</span><span class="token punctuation">:</span> <span class="token string">'[a-zA-Z0-9]*'</span>
        <span class="token key atrule">description</span><span class="token punctuation">:</span> db_password must contain only alphanumeric characters
  <span class="token key atrule">db_root_password</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> string
    <span class="token key atrule">description</span><span class="token punctuation">:</span> Root password for MySQL
    <span class="token key atrule">default</span><span class="token punctuation">:</span> admin
    <span class="token key atrule">hidden</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">constraints</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">length</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">min</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token key atrule">max</span><span class="token punctuation">:</span> <span class="token number">41</span> <span class="token punctuation">&#125;</span>
        <span class="token key atrule">description</span><span class="token punctuation">:</span> db_root_password must be between 1 and 41 characters
      <span class="token punctuation">-</span> <span class="token key atrule">allowed_pattern</span><span class="token punctuation">:</span> <span class="token string">'[a-zA-Z0-9]*'</span>
        <span class="token key atrule">description</span><span class="token punctuation">:</span> db_root_password must contain only alphanumeric characters

<span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token key atrule">wordpress_instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> OS<span class="token punctuation">:</span><span class="token punctuation">:</span>Nova<span class="token punctuation">:</span><span class="token punctuation">:</span>Server
    <span class="token key atrule">properties</span><span class="token punctuation">:</span>
      <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">get_param</span><span class="token punctuation">:</span> image_id <span class="token punctuation">&#125;</span>
      <span class="token key atrule">flavor</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">get_param</span><span class="token punctuation">:</span> instance_type <span class="token punctuation">&#125;</span>
      <span class="token key atrule">key_name</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">get_param</span><span class="token punctuation">:</span> key_name <span class="token punctuation">&#125;</span>
      <span class="token key atrule">user_data</span><span class="token punctuation">:</span>
        <span class="token key atrule">str_replace</span><span class="token punctuation">:</span>
          <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            #!/bin/bash -v</span>

            yum <span class="token punctuation">-</span>y install mariadb mariadb<span class="token punctuation">-</span>server httpd wordpress
            touch /var/log/mariadb/mariadb.log
            chown mysql.mysql /var/log/mariadb/mariadb.log
            systemctl start mariadb.service

            <span class="token comment"># Setup MySQL root password and create a user</span>
            mysqladmin <span class="token punctuation">-</span>u root password db_rootpassword
            cat &lt;&lt; EOF <span class="token punctuation">|</span> mysql <span class="token punctuation">-</span>u root <span class="token punctuation">-</span><span class="token punctuation">-</span>password=db_rootpassword
            CREATE DATABASE db_name;
            GRANT ALL PRIVILEGES ON db_name.* TO "db_user"@"localhost"
            IDENTIFIED BY "db_password";
            FLUSH PRIVILEGES;
            EXIT
            EOF

            sed <span class="token punctuation">-</span>i "/Deny from All/d" /etc/httpd/conf.d/wordpress.conf
            sed <span class="token punctuation">-</span>i "s/Require local/Require all granted/" /etc/httpd/conf.d/wordpress.conf
            sed <span class="token punctuation">-</span>i s/database_name_here/db_name/ /etc/wordpress/wp<span class="token punctuation">-</span>config.php
            sed <span class="token punctuation">-</span>i s/username_here/db_user/ /etc/wordpress/wp<span class="token punctuation">-</span>config.php
            sed <span class="token punctuation">-</span>i s/password_here/db_password/ /etc/wordpress/wp<span class="token punctuation">-</span>config.php

            systemctl start httpd.service            
          <span class="token key atrule">params</span><span class="token punctuation">:</span>
            <span class="token key atrule">db_rootpassword</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">get_param</span><span class="token punctuation">:</span> db_root_password <span class="token punctuation">&#125;</span>
            <span class="token key atrule">db_name</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">get_param</span><span class="token punctuation">:</span> db_name <span class="token punctuation">&#125;</span>
            <span class="token key atrule">db_user</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">get_param</span><span class="token punctuation">:</span> db_username <span class="token punctuation">&#125;</span>
            <span class="token key atrule">db_password</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">get_param</span><span class="token punctuation">:</span> db_password <span class="token punctuation">&#125;</span>

<span class="token key atrule">outputs</span><span class="token punctuation">:</span>
  <span class="token key atrule">WebsiteURL</span><span class="token punctuation">:</span>
    <span class="token key atrule">description</span><span class="token punctuation">:</span> URL for Wordpress wiki
    <span class="token key atrule">value</span><span class="token punctuation">:</span>
      <span class="token key atrule">str_replace</span><span class="token punctuation">:</span>
        <span class="token key atrule">template</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//host/wordpress
        <span class="token key atrule">params</span><span class="token punctuation">:</span>
          <span class="token key atrule">host</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">get_attr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>wordpress_instance<span class="token punctuation">,</span> first_address<span class="token punctuation">]</span> <span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="堆栈创建"><a href="#堆栈创建" class="headerlink" title="堆栈创建"></a>堆栈创建</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack stack create -t demo.yaml --parameter key_name=test_key --parameter instance_type=m1.small --parameter image_id=fe</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack stack event list demo-struct</span>
<span class="token number">2023</span>-12-16 <span class="token number">20</span>:50:40 <span class="token punctuation">[</span>demo-struct<span class="token punctuation">]</span>: CREATE_IN_PROGRESS  Stack CREATE started
<span class="token number">2023</span>-12-16 <span class="token number">20</span>:50:40 <span class="token punctuation">[</span>wordpress_instance<span class="token punctuation">]</span>: CREATE_IN_PROGRESS  state changed
<span class="token number">2023</span>-12-16 <span class="token number">20</span>:50:47 <span class="token punctuation">[</span>wordpress_instance<span class="token punctuation">]</span>: CREATE_COMPLETE  state changed
<span class="token number">2023</span>-12-16 <span class="token number">20</span>:50:47 <span class="token punctuation">[</span>demo-struct<span class="token punctuation">]</span>: CREATE_COMPLETE  Stack CREATE completed successfully
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack stack show demo-struct</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="案例三：配置NFS作为glance后端存储"><a href="#案例三：配置NFS作为glance后端存储" class="headerlink" title="案例三：配置NFS作为glance后端存储"></a>案例三：配置NFS作为glance后端存储</h2><ol>
<li><p>glance默认是本地存储，路径<code>/var/lib/glance/images</code>，现在要把该路径设置为nfs的共享目录。</p>
</li>
<li><p>实验环境是nfs的服务端客户端为同一台主机，且已安装好nfs服务，下面对nfs进行配置。</p>
</li>
<li><p>在nfs服务端上的配置文件<code>/etc/exports</code>中插入以下代码：</p>
 <pre class="line-numbers language-text" data-language="text"><code class="language-text">/mnt/test 192.168.100.0/24(rw,no_root_squash,no_all_squash,sync,anonuid=501,anongid=501)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> 配置说明：</p>
<p> &lt;目录路径&gt; &lt;可访问主机&gt;(选项)</p>
<ul>
<li><code>&lt;目录路径&gt;</code>：表示要共享的目录的路径。可以是绝对路径或相对路径。</li>
<li><code>&lt;可访问主机&gt;</code>：表示允许访问该共享目录的主机或网络地址。可以是单个IP地址、IP地址范围、子网掩码或主机名。</li>
<li><code>(选项)</code>：表示可选的共享选项，用于配置访问权限、权限验证等。</li>
</ul>
</li>
<li><p>nfs服务重启、验证。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart rpcbind</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart nfs</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># showmount -e 192.168.100.10</span>
Export list <span class="token keyword">for</span> <span class="token number">192.168</span>.100.10:
/mnt/test <span class="token number">192.168</span>.100.0/24<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>nfs客户端使用。</p>
<p> 客户端软件包检查：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># rpm -qa |grep nfs-utils</span>
nfs-utils-1.3.0-0.21.el7_2.1.x86_64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p> 目录挂载：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># mount -t nfs 192.168.100.10:/mnt/test /var/lib/glance/images/</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># df -h</span>
Filesystem                Size  Used Avail Use% Mounted on
/dev/mapper/centos-root    35G   11G   25G  <span class="token number">32</span>% /
devtmpfs                  <span class="token number">3</span>.9G     <span class="token number">0</span>  <span class="token number">3</span>.9G   <span class="token number">0</span>% /dev
tmpfs                     <span class="token number">3</span>.9G  <span class="token number">4</span>.0K  <span class="token number">3</span>.9G   <span class="token number">1</span>% /dev/shm
tmpfs                     <span class="token number">3</span>.9G  <span class="token number">8</span>.7M  <span class="token number">3</span>.9G   <span class="token number">1</span>% /run
tmpfs                     <span class="token number">3</span>.9G     <span class="token number">0</span>  <span class="token number">3</span>.9G   <span class="token number">0</span>% /sys/fs/cgroup
/dev/sda1                 197M  111M   87M  <span class="token number">57</span>% /boot
/dev/loop0                <span class="token number">5</span>.0G   33M  <span class="token number">5</span>.0G   <span class="token number">1</span>% /swift/node
tmpfs                     781M     <span class="token number">0</span>  781M   <span class="token number">0</span>% /run/user/0
<span class="token number">192.168</span>.100.10:/mnt/test   35G   11G   25G  <span class="token number">32</span>% /var/lib/glance/images<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>权限配置。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># cd /var/lib/glance</span>
<span class="token punctuation">[</span>root@controller glance<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@controller glance<span class="token punctuation">]</span><span class="token comment"># chown glance:glance images</span>
<span class="token punctuation">[</span>root@controller glance<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">0</span>
drwxr-xr-x. <span class="token number">2</span> glance glance <span class="token number">6</span> Dec <span class="token number">18</span> 03:14 images<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>在Horizon图形中上传镜像，然后验证nfs共享目录的存储情况。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller glance<span class="token punctuation">]</span><span class="token comment"># ll /mnt/test</span>
total <span class="token number">12960</span>
-rw-r-----. <span class="token number">1</span> glance glance <span class="token number">13267968</span> Dec <span class="token number">18</span> 03:20 505dfbda-f821-4762-954b-5cea3554291d<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>作业2：上传镜像后验证nfs共享目录的存储情况，截图上传。</p>
</blockquote>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/09/private_clouds/12.OpenStack%E8%AE%A1%E9%87%8F%E6%9C%8D%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/12/09/private_clouds/12.OpenStack%E8%AE%A1%E9%87%8F%E6%9C%8D%E5%8A%A1/" class="post-title-link" itemprop="url">OpenStack计量服务-Ceilometer</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-12-09 13:35:01" itemprop="dateCreated datePublished" datetime="2023-12-09T13:35:01+08:00">2023-12-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-12-12 11:06:43" itemprop="dateModified" datetime="2023-12-12T11:06:43+08:00">2023-12-12</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Ceilometer-计量服务-简介"><a href="#Ceilometer-计量服务-简介" class="headerlink" title="Ceilometer(计量服务)简介"></a>Ceilometer(计量服务)简介</h2><p>Ceilometer属于OpenStack项目中的一个组件，是在Telemetry服务基础上发展而来，主要用作收集、监控和处理OpenStack资源的指标数据。它可以收集虚拟机、卷、网络等资源的性能指标，如CPU利用率、内存使用量、网络流量等。这些指标数据可以用于监控和分析OpenStack环境的性能、资源利用情况以及故障排除。</p>
<p>Ceilometer通过与OpenStack其他组件集成，如Nova（计算服务）、Cinder（块存储服务）、Neutron（网络服务）等，能够获取各个组件的指标数据，并将其存储在数据库中供后续查询和分析。</p>
<p>Ceilometer还提供了报警和事件处理机制，可以根据设定的阈值或规则触发报警并采取相应的操作。这样，管理员可以根据指标数据的变化情况及时采取措施，维护和优化OpenStack环境。</p>
<h3 id="Ceilometer架构"><a href="#Ceilometer架构" class="headerlink" title="Ceilometer架构"></a>Ceilometer架构</h3><img src="https://vault.taojie.fun:28089/i/2023/12/11/2023-12-11-1702252909.png" alt="1702252910007.png" title="1702252910007.png" />

<img src="https://vault.taojie.fun:28089/i/2023/12/10/2023-12-10-1702200511.png" alt="1702200509691.png" title="1702200509691.png" />

<h3 id="数据采集"><a href="#数据采集" class="headerlink" title="数据采集"></a>数据采集</h3><img src="https://vault.taojie.fun:28089/i/2023/12/11/2023-12-11-1702253165.png" alt="1702253165613.png" title="1702253165613.png" />

<p>Ceilometer有两个核心服务，也是它采集数据的两种方式：</p>
<ol>
<li><p>polling agent:</p>
<ol>
<li><p>Compute agent （ceilometer-agent-compute）运行在每个 compute 节点上，以轮询的方式通过调用 Image 的 driver 来获取资源使用统计数据。</p>
</li>
<li><p>Central agent （ceilometer-agent-central）运行在 management server 上，以轮询的方式通过调用 OpenStack 各个组件（包括 Nova、Cinder、Glance、Neutron、Swift 等）的 API 收集资源使用统计数据。</p>
</li>
</ol>
 <img src="https://vault.taojie.fun:28089/i/2023/12/10/2023-12-10-1702204525.png" alt="1702204523484.png" title="1702204523484.png" />
</li>
<li><p>notification agent: 运行在一个或者多个management server上的数据收集程序，监听消息队列上的通知，将他们转换成时间和样本、应用管道操作。核心是通知守护进程（agent-notification），它监视消息队列中其他 OpenStack 组件（例如 Nova、Glance、Cinder、Neutron、Swift、Keystone 和 Heat）发送的数据以及 Ceilometer 内部通信。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/12/10/2023-12-10-1702204499.png" alt="1702204497853.png" title="1702204497853.png" /></li>
</ol>
<p>对于采集的数据类型也有两种：</p>
<ol>
<li><p>Sample（样本）：Sample是指标数据的基本单位，用于表示一次指标的测量值。每个Sample包含了指标的名称、值、时间戳、资源标识符等信息。Ceilometer通过收集来自不同OpenStack组件的指标数据，生成一系列的Sample。这些Sample可以表示CPU利用率、内存使用量、网络流量等不同类型的指标数据。Sample通常与时间序列数据库（如Gnocchi）一起使用，用于存储和查询指标数据。</p>
</li>
<li><p>Event（事件）：Event用于表示OpenStack环境中的发生的事件。事件可以是资源的创建、修改、删除，或者其他与资源状态变化相关的操作。每个Event包含了事件的类型、资源标识符、时间戳、事件数据等信息。Ceilometer的Panko组件负责收集和存储这些事件数据，并与指标数据进行关联。通过事件数据，管理员可以了解资源的创建、状态变化等操作，以便进行监控、审计和故障排除等工作。</p>
</li>
</ol>
<h3 id="数据处理"><a href="#数据处理" class="headerlink" title="数据处理"></a>数据处理</h3><p>Pipelines是Ceilometer中数据处理的机制，描述了一组<code>sources</code>（数据来源）和<code>sinks</code>（数据分发）之间的关系，Metes 数据依次经过（零个或者多个） Transformer 和 （一个或者多个）Publisher 处理，最后达到（一个或者多个）Receiver。其中Recivers 包括 Ceilometer Collector 和 外部系统。</p>
<img src="https://vault.taojie.fun:28089/i/2023/12/11/2023-12-11-1702252965.png" alt="1702252966065.png" title="1702252966065.png" />

<p>对于采集到的数据Ceilometer可以通过多个pipelines以多个形式进行发布，该功能由<code>notification agents</code>完成。</p>
<p>以下是常见的可以用来发布数据的方式：</p>
<ol>
<li><p>gnocchi:发布samples&#x2F;events到Gnocchi Api中。</p>
</li>
<li><p>notifier:基于通知的发布器，将sample推送到可由外部系统使用的消息队列。</p>
</li>
<li><p>http&#x2F;https:通过REST API发布数据。</p>
</li>
<li><p>file:发布数据到指定地址和名字的文件中。</p>
</li>
</ol>
<blockquote>
<p>Gnocchi是一个开源的时间序列数据库项目，专门用于存储和分析大规模的时间序列数据。它最初作为OpenStack项目的一部分，用于存储和查询Ceilometer（Telemetry）收集的指标数据，但现在已经成为一个独立的项目，可以与多个数据源和应用程序集成。</p>
</blockquote>
<h3 id="Ceilometer命令"><a href="#Ceilometer命令" class="headerlink" title="Ceilometer命令"></a>Ceilometer命令</h3><img src="https://vault.taojie.fun:28089/i/2023/12/11/2023-12-11-1702252414.png" alt="1702252415032.png" title="1702252415032.png" />

<h2 id="Ceilometer实验"><a href="#Ceilometer实验" class="headerlink" title="Ceilometer实验"></a>Ceilometer实验</h2><h3 id="作业与实验环境"><a href="#作业与实验环境" class="headerlink" title="作业与实验环境"></a>作业与实验环境</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://wxstc.fanya.chaoxing.com/portal">超星网址</a><br>虚拟机<code>openstack-allinone</code>，账户<code>root</code>，密码<code>000000</code></p>
</blockquote>
<ol>
<li><p>VmWare需要修改网络设置，在编辑-&gt;虚拟网络编辑器中将Vmnet1网卡的子网由原来的<code>192.168.10.0</code>改为<code>192.168.100.0</code>。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/12/03/2023-12-03-1701610473.png" alt="1701610472777.png" title="1701610472777.png" />
</li>
<li><p>后续实验需要启动实例，Horizon登录地址<code>192.168.100.10/dashboard</code>，使用域<code>xiandian</code>、用户名<code>admin</code>、密码<code>000000</code>登录之后<code>上传</code>本地<code>D盘</code>的cirros镜像到OpenStack平台。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/12/04/2023-12-04-1701650466.png" alt="1701650465473.png" title="1701650465473.png" />
</li>
<li><p>执行脚本完成身份认证。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># source /etc/keystone/admin-openrc.sh</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>自行创建<code>镜像</code>、<code>网络</code>、<code>实例</code>。</p>
</li>
</ol>
<blockquote>
<p>作业1：创建实例后截图上传。</p>
</blockquote>
<h3 id="meters-yaml查看"><a href="#meters-yaml查看" class="headerlink" title="meters.yaml查看"></a>meters.yaml查看</h3><p>关于Ceilmoeter需要采集的数据（指标）都定义在<code>/etc/ceilometer/meters.yaml</code>中，管理员可以对其进行修改。</p>
<p>示例：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"image.size"</span>
   <span class="token key atrule">event_type</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token string">"image.upload"</span>
     <span class="token punctuation">-</span> <span class="token string">"image.delete"</span>
     <span class="token punctuation">-</span> <span class="token string">"image.update"</span>
   <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"gauge"</span>
   <span class="token key atrule">unit</span><span class="token punctuation">:</span> B
   <span class="token key atrule">volume</span><span class="token punctuation">:</span> $.payload.size
   <span class="token key atrule">resource_id</span><span class="token punctuation">:</span> $.payload.id
   <span class="token key atrule">project_id</span><span class="token punctuation">:</span> $.payload.owner<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>name: “image.size”：指标的名称，这里是镜像大小。</li>
<li>event_type: […]：指定与该指标相关的事件类型，包括图像上传（image.upload）、图像删除（image.delete）和图像更新（image.update）。当这些事件发生时，将收集与指标相关的数据。</li>
<li>type: “gauge”：指标的类型，这里是度量值（gauge）。度量值是一种表示可变的、不连续的指标类型，可以是整数或浮点数。</li>
<li>unit: B：指标的单位，这里表示字节（B）。</li>
<li>volume: $.payload.size：指标的值来源于事件的有效负载（payload）中的 size 字段。每当事件发生时，Ceilometer会提取有效负载中的 size 字段的值，并将其作为指标的值。</li>
<li>resource_id: $.payload.id：指标所属资源的标识符，这里使用事件的有效负载中的 id 字段作为资源标识符。</li>
<li>project_id: $.payload.owner：指标所属项目的标识符，这里使用事件的有效负载中的 owner 字段作为项目标识符。</li>
</ol>
<h3 id="pipeline-yaml修改"><a href="#pipeline-yaml修改" class="headerlink" title="pipeline.yaml修改"></a>pipeline.yaml修改</h3><ol>
<li><p>可使用配置文件<code>/etc/ceilometer/pipeline.yaml</code>配置对<code>meters</code>的处理，示例：</p>
 <pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">sources</span><span class="token punctuation">:</span> A source is a producer of samples
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cpu_source
    <span class="token key atrule">interval</span><span class="token punctuation">:</span> <span class="token number">600</span>
    <span class="token key atrule">meters</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">"cpu"</span>
    <span class="token key atrule">sinks</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> cpu_sink

<span class="token key atrule">sinks</span><span class="token punctuation">:</span> A sink on the other hand is a chain of handlers of samples
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cpu_sink
    <span class="token key atrule">transformers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"rate_of_change"</span>
        <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
                <span class="token key atrule">target</span><span class="token punctuation">:</span>
                    <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"cpu_util"</span>
                    <span class="token key atrule">unit</span><span class="token punctuation">:</span> <span class="token string">"%"</span>
                    <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"gauge"</span>
                    <span class="token key atrule">scale</span><span class="token punctuation">:</span> <span class="token string">"100.0 / (10**9 * (resource_metadata.cpu_number or1))"</span>
    <span class="token key atrule">publishers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> notifier<span class="token punctuation">:</span>//<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> 这段代码定义了 cpu meter 的 ：</p>
<ol>
<li><p>interval: 600：Poller 获取 cpu samples 的间隔为 10 分钟</p>
</li>
<li><p>cpu meter 的 transformer 为 “rate_of_change”</p>
</li>
<li><p>cpu meter 的 publisher 为 notifier:&#x2F;&#x2F;，它使用默认的配置经过 AMQP 使用 oslo.messaging 发出数据</p>
</li>
</ol>
</li>
<li><p>修改cpu meter的采样间隔为1分钟，并且添加<code>- file:///var/log/ceilometer/ceilometer-file-publisher</code>到publishers字段，增加一个发布方式。</p>
<p> 示例：</p>
 <pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">sources</span><span class="token punctuation">:</span> A source is a producer of samples
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cpu_source
    <span class="token key atrule">interval</span><span class="token punctuation">:</span> <span class="token number">60</span>
    <span class="token key atrule">meters</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">"cpu"</span>
    <span class="token key atrule">sinks</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> cpu_sink

<span class="token key atrule">sinks</span><span class="token punctuation">:</span> A sink on the other hand is a chain of handlers of samples
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cpu_sink
    <span class="token key atrule">transformers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"rate_of_change"</span>
        <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
                <span class="token key atrule">target</span><span class="token punctuation">:</span>
                    <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"cpu_util"</span>
                    <span class="token key atrule">unit</span><span class="token punctuation">:</span> <span class="token string">"%"</span>
                    <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"gauge"</span>
                    <span class="token key atrule">scale</span><span class="token punctuation">:</span> <span class="token string">"100.0 / (10**9 * (resource_metadata.cpu_number or1))"</span>
    <span class="token key atrule">publishers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> notifier<span class="token punctuation">:</span>//
        <span class="token punctuation">-</span> file<span class="token punctuation">:</span>///var/log/ceilometer/ceilometer<span class="token punctuation">-</span>file<span class="token punctuation">-</span>publisher<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>重启Ceilometer相关服务后查看发布的文件内容。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller<span class="token punctuation">]</span><span class="token comment"># systemctl restart openstack-ceilometer*</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># cat /var/log/ceilometer/ceilometer-file-publisher |head -1</span>
<span class="token punctuation">&#123;</span><span class="token string">'user_id'</span><span class="token builtin class-name">:</span> u<span class="token string">'0befa70f767848e39df8224107b71858'</span>, <span class="token string">'name'</span><span class="token builtin class-name">:</span> <span class="token string">'cpu_util'</span>, <span class="token string">'resource_id'</span><span class="token builtin class-name">:</span> u<span class="token string">'dcfb5539-454c-4d1a-9dc2-f39a3a64cb34'</span>, <span class="token string">'timestamp'</span><span class="token builtin class-name">:</span> u<span class="token string">'2023-12-10T23:43:22.566393'</span>, <span class="token string">'resource_metadata'</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>u<span class="token string">'status'</span><span class="token builtin class-name">:</span> u<span class="token string">'active'</span>, u<span class="token string">'cpu_number'</span><span class="token builtin class-name">:</span> <span class="token number">1</span>, u<span class="token string">'state'</span><span class="token builtin class-name">:</span> u<span class="token string">'active'</span>, u<span class="token string">'ramdisk_id'</span><span class="token builtin class-name">:</span> None, u<span class="token string">'display_name'</span><span class="token builtin class-name">:</span> u<span class="token string">'te'</span>, u<span class="token string">'name'</span><span class="token builtin class-name">:</span> u<span class="token string">'instance-00000009'</span>, u<span class="token string">'disk_gb'</span><span class="token builtin class-name">:</span> <span class="token number">1</span>, u<span class="token string">'instance_host'</span><span class="token builtin class-name">:</span> u<span class="token string">'controller'</span>, u<span class="token string">'kernel_id'</span><span class="token builtin class-name">:</span> None, u<span class="token string">'instance_id'</span><span class="token builtin class-name">:</span> u<span class="token string">'dcfb5539-454c-4d1a-9dc2-f39a3a64cb34'</span>, u<span class="token string">'image'</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>u<span class="token string">'id'</span><span class="token builtin class-name">:</span> u<span class="token string">'c65fc953-344c-46dc-8e3a-4a452fac4ffd'</span>, u<span class="token string">'links'</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>u<span class="token string">'href'</span><span class="token builtin class-name">:</span> u<span class="token string">'http://controller:8774/c88f5a1b7619420dadb4309743e53f1a/images/c65fc953-344c-46dc-8e3a-4a452fac4ffd'</span>, u<span class="token string">'rel'</span><span class="token builtin class-name">:</span> u<span class="token string">'bookmark'</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span>, u<span class="token string">'name'</span><span class="token builtin class-name">:</span> u<span class="token string">'cirros'</span><span class="token punctuation">&#125;</span>, u<span class="token string">'ephemeral_gb'</span><span class="token builtin class-name">:</span> <span class="token number">0</span>, u<span class="token string">'vcpus'</span><span class="token builtin class-name">:</span> <span class="token number">1</span>, u<span class="token string">'memory_mb'</span><span class="token builtin class-name">:</span> <span class="token number">512</span>, u<span class="token string">'instance_type'</span><span class="token builtin class-name">:</span> u<span class="token string">'m1.tiny'</span>, u<span class="token string">'host'</span><span class="token builtin class-name">:</span> u<span class="token string">'e3d6b1115b110b721fd922d3e5c497f2c86621b692ddccdbee24320b'</span>, u<span class="token string">'root_gb'</span><span class="token builtin class-name">:</span> <span class="token number">1</span>, u<span class="token string">'image_ref'</span><span class="token builtin class-name">:</span> u<span class="token string">'c65fc953-344c-46dc-8e3a-4a452fac4ffd'</span>, u<span class="token string">'flavor'</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>u<span class="token string">'name'</span><span class="token builtin class-name">:</span> u<span class="token string">'m1.tiny'</span>, u<span class="token string">'links'</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>u<span class="token string">'href'</span><span class="token builtin class-name">:</span> u<span class="token string">'http://controller:8774/c88f5a1b7619420dadb4309743e53f1a/flavors/1'</span>, u<span class="token string">'rel'</span><span class="token builtin class-name">:</span> u<span class="token string">'bookmark'</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span>, u<span class="token string">'ram'</span><span class="token builtin class-name">:</span> <span class="token number">512</span>, u<span class="token string">'ephemeral'</span><span class="token builtin class-name">:</span> <span class="token number">0</span>, u<span class="token string">'vcpus'</span><span class="token builtin class-name">:</span> <span class="token number">1</span>, u<span class="token string">'disk'</span><span class="token builtin class-name">:</span> <span class="token number">1</span>, u<span class="token string">'id'</span><span class="token builtin class-name">:</span> u<span class="token string">'1'</span><span class="token punctuation">&#125;</span>, u<span class="token string">'OS-EXT-AZ:availability_zone'</span><span class="token builtin class-name">:</span> u<span class="token string">'nova'</span>, u<span class="token string">'image_ref_url'</span><span class="token builtin class-name">:</span> u<span class="token string">'http://controller:8774/c88f5a1b7619420dadb4309743e53f1a/images/c65fc953-344c-46dc-8e3a-4a452fac4ffd'</span><span class="token punctuation">&#125;</span>, <span class="token string">'volume'</span><span class="token builtin class-name">:</span> <span class="token number">0.0</span>, <span class="token string">'source'</span><span class="token builtin class-name">:</span> <span class="token string">'openstack'</span>, <span class="token string">'project_id'</span><span class="token builtin class-name">:</span> u<span class="token string">'f9ff39ba9daa4e5a8fee1fc50e2d2b34'</span>, <span class="token string">'type'</span><span class="token builtin class-name">:</span> <span class="token string">'gauge'</span>, <span class="token string">'id'</span><span class="token builtin class-name">:</span> <span class="token string">'e79bd3d4-97b5-11ee-b203-000c29d6d36c'</span>, <span class="token string">'unit'</span><span class="token builtin class-name">:</span> <span class="token string">'%'</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<blockquote>
<p>作业2：查看到发布到文件的数据后截图上传。</p>
</blockquote>
</li>
</ol>
<h3 id="数据读取"><a href="#数据读取" class="headerlink" title="数据读取"></a>数据读取</h3><ol>
<li><p>通过命令读取计量和样本。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># ceilometer meter-list |head -10</span>
+---------------------------------+------------+-----------+-----------------------------------------------------------------------+----------------------------------+----------------------------------+
<span class="token operator">|</span> Name                            <span class="token operator">|</span> Type       <span class="token operator">|</span> Unit      <span class="token operator">|</span> Resource ID                                                           <span class="token operator">|</span> User ID                          <span class="token operator">|</span> Project ID                       <span class="token operator">|</span>
+---------------------------------+------------+-----------+-----------------------------------------------------------------------+----------------------------------+----------------------------------+
<span class="token operator">|</span> compute.instance.booting.time   <span class="token operator">|</span> gauge      <span class="token operator">|</span> sec       <span class="token operator">|</span> 2324c631-cf3e-49eb-a8e2-be384341e4ac                                  <span class="token operator">|</span> 0befa70f767848e39df8224107b71858 <span class="token operator">|</span> f9ff39ba9daa4e5a8fee1fc50e2d2b34 <span class="token operator">|</span>
<span class="token operator">|</span> compute.instance.booting.time   <span class="token operator">|</span> gauge      <span class="token operator">|</span> sec       <span class="token operator">|</span> 26b3b242-3704-4d37-88bc-d9cf8a5b0080                                  <span class="token operator">|</span> 0befa70f767848e39df8224107b71858 <span class="token operator">|</span> f9ff39ba9daa4e5a8fee1fc50e2d2b34 <span class="token operator">|</span>
<span class="token operator">|</span> compute.instance.booting.time   <span class="token operator">|</span> gauge      <span class="token operator">|</span> sec       <span class="token operator">|</span> e1e52ae3-1f3e-4d62-bc21-d8b19055ab5c                                  <span class="token operator">|</span> 0befa70f767848e39df8224107b71858 <span class="token operator">|</span> f9ff39ba9daa4e5a8fee1fc50e2d2b34 <span class="token operator">|</span>
<span class="token operator">|</span> cpu                             <span class="token operator">|</span> cumulative <span class="token operator">|</span> ns        <span class="token operator">|</span> 2324c631-cf3e-49eb-a8e2-be384341e4ac                                  <span class="token operator">|</span> 0befa70f767848e39df8224107b71858 <span class="token operator">|</span> f9ff39ba9daa4e5a8fee1fc50e2d2b34 <span class="token operator">|</span>
<span class="token operator">|</span> cpu                             <span class="token operator">|</span> cumulative <span class="token operator">|</span> ns        <span class="token operator">|</span> e1e52ae3-1f3e-4d62-bc21-d8b19055ab5c                                  <span class="token operator">|</span> 0befa70f767848e39df8224107b71858 <span class="token operator">|</span> f9ff39ba9daa4e5a8fee1fc50e2d2b34 <span class="token operator">|</span>
<span class="token operator">|</span> cpu.delta                       <span class="token operator">|</span> delta      <span class="token operator">|</span> ns        <span class="token operator">|</span> e1e52ae3-1f3e-4d62-bc21-d8b19055ab5c                                  <span class="token operator">|</span> 0befa70f767848e39df8224107b71858 <span class="token operator">|</span> f9ff39ba9daa4e5a8fee1fc50e2d2b34 <span class="token operator">|</span>
<span class="token operator">|</span> cpu_util                        <span class="token operator">|</span> gauge      <span class="token operator">|</span> %         <span class="token operator">|</span> e1e52ae3-1f3e-4d62-bc21-d8b19055ab5c                                  <span class="token operator">|</span> 0befa70f767848e39df8224107b71858 <span class="token operator">|</span> f9ff39ba9daa4e5a8fee1fc50e2d2b34 <span class="token operator">|</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># ceilometer sample-list -m cpu_util | head -10</span>
+--------------------------------------+----------+-------+----------------+------+----------------------------+
<span class="token operator">|</span> Resource ID                          <span class="token operator">|</span> Name     <span class="token operator">|</span> Type  <span class="token operator">|</span> Volume         <span class="token operator">|</span> Unit <span class="token operator">|</span> Timestamp                  <span class="token operator">|</span>
+--------------------------------------+----------+-------+----------------+------+----------------------------+
<span class="token operator">|</span> dcfb5539-454c-4d1a-9dc2-f39a3a64cb34 <span class="token operator">|</span> cpu_util <span class="token operator">|</span> gauge <span class="token operator">|</span> <span class="token number">3.34969394963</span>  <span class="token operator">|</span> %    <span class="token operator">|</span> <span class="token number">2023</span>-12-11T10:49:36.856000 <span class="token operator">|</span>
<span class="token operator">|</span> dcfb5539-454c-4d1a-9dc2-f39a3a64cb34 <span class="token operator">|</span> cpu_util <span class="token operator">|</span> gauge <span class="token operator">|</span> <span class="token number">3.41829637437</span>  <span class="token operator">|</span> %    <span class="token operator">|</span> <span class="token number">2023</span>-12-11T10:48:36.851000 <span class="token operator">|</span>
<span class="token operator">|</span> dcfb5539-454c-4d1a-9dc2-f39a3a64cb34 <span class="token operator">|</span> cpu_util <span class="token operator">|</span> gauge <span class="token operator">|</span> <span class="token number">3.50940950027</span>  <span class="token operator">|</span> %    <span class="token operator">|</span> <span class="token number">2023</span>-12-11T10:47:37.172000 <span class="token operator">|</span>
<span class="token operator">|</span> dcfb5539-454c-4d1a-9dc2-f39a3a64cb34 <span class="token operator">|</span> cpu_util <span class="token operator">|</span> gauge <span class="token operator">|</span> <span class="token number">3.53780765348</span>  <span class="token operator">|</span> %    <span class="token operator">|</span> <span class="token number">2023</span>-12-11T10:46:37.048000 <span class="token operator">|</span>
<span class="token operator">|</span> dcfb5539-454c-4d1a-9dc2-f39a3a64cb34 <span class="token operator">|</span> cpu_util <span class="token operator">|</span> gauge <span class="token operator">|</span> <span class="token number">3.50009759439</span>  <span class="token operator">|</span> %    <span class="token operator">|</span> <span class="token number">2023</span>-12-11T10:45:36.841000 <span class="token operator">|</span>
<span class="token operator">|</span> dcfb5539-454c-4d1a-9dc2-f39a3a64cb34 <span class="token operator">|</span> cpu_util <span class="token operator">|</span> gauge <span class="token operator">|</span> <span class="token number">3.46708312113</span>  <span class="token operator">|</span> %    <span class="token operator">|</span> <span class="token number">2023</span>-12-11T10:44:36.843000 <span class="token operator">|</span>
<span class="token operator">|</span> dcfb5539-454c-4d1a-9dc2-f39a3a64cb34 <span class="token operator">|</span> cpu_util <span class="token operator">|</span> gauge <span class="token operator">|</span> <span class="token number">3.31595080815</span>  <span class="token operator">|</span> %    <span class="token operator">|</span> <span class="token number">2023</span>-12-11T10:43:36.850000 <span class="token operator">|</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>通过api读取计量和样本。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 获取令牌Token</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack token issue</span>
<span class="token comment"># 导出令牌到环境变量</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># export OS_TOKEN=gAAAAABlduo9h-PcRjEUSOgCRqzg06x6JzWSEMWWm2hFZqbbvh6zdR12vTzYP9HNRhk99fKbK0hDsYz6nVCZmDuqXJHGMaPWUutYxZ38t0jKwbvYDiVtzhAUK12ws6mVzXbjAIVThIv8QZZ_kuvaWhRf0EIp9JNZE0XTAHF_htTb1-v9LqX6aCg</span>
<span class="token comment"># 发起请求读取计量列表</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># curl -X GET -H "X-Auth-Token: $OS_TOKEN" "http://localhost:8777/v2/meters" |python -m json.tool |less</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 发起请求读取样本列表</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># curl -X GET -H "X-Auth-Token: $OS_TOKEN" "http://localhost:8777/v2/samples" |python -m json.tool |less</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<blockquote>
<p>作业3：通过api读取到样本后截图上传。</p>
</blockquote>
</li>
</ol>
<h3 id="Alarms告警规则"><a href="#Alarms告警规则" class="headerlink" title="Alarms告警规则"></a>Alarms告警规则</h3><p>使用 CLI 创建一个名为 “cpu_high” 的 Threshold Alarm “当连续 3 个 10 分钟内 某 instance 的 cpu_util 值超过70 的时候产告警，并其内容被写入日志文件”：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ceilometer alarm-threshold-create <span class="token parameter variable">--name</span> cpu_high <span class="token parameter variable">--description</span> <span class="token string">'instance running hot'</span>  --meter-name cpu_util  <span class="token parameter variable">--threshold</span> <span class="token number">70.0</span> --comparison-operator gt  <span class="token parameter variable">--statistic</span> avg <span class="token parameter variable">--period</span> <span class="token number">600</span> --evaluation-periods <span class="token number">3</span> --alarm-action <span class="token string">'log://'</span> <span class="token parameter variable">--query</span> <span class="token assign-left variable">resource_id</span><span class="token operator">=</span>INSTANCE_ID<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>name: 告警名称<br>meter-name：meter 名称<br>threshold: 阈值<br>comparison_operator: 这个参数确定了怎么和阈值进行比较，有6个可选：lt, le, eq, ne, ge, gt，默认是eq<br>statistic: 这个参数确定了使用什么数据去和 threshold 比较，有5种可选：max, min, avg, sum, count，默认是avg<br>period: 这个参数其实有两个作用，一个是确定了获取该监控指标的监控数据的时间范围，和下面的 evaluation_periods 配合使用，另外一个作用就是它确定了两个点之间的时间间隔，默认是60s<br>evaluation_periods: 表示连续的监控间隔数目。和 period 参数相乘，可以确定获取监控数据的时间范围，默认是1。<br>alarm-action：告警产生后的反应。<br>query: 该参数一般用于过滤到监控指标下的某个资源，默认是[]</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/11/30/private_clouds/11.OpenStack%E7%BC%96%E6%8E%92%E6%9C%8D%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/11/30/private_clouds/11.OpenStack%E7%BC%96%E6%8E%92%E6%9C%8D%E5%8A%A1/" class="post-title-link" itemprop="url">OpenStack编排服务</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-11-30 20:34:35" itemprop="dateCreated datePublished" datetime="2023-11-30T20:34:35+08:00">2023-11-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-12-04 14:43:44" itemprop="dateModified" datetime="2023-12-04T14:43:44+08:00">2023-12-04</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Heat-编排服务-简介"><a href="#Heat-编排服务-简介" class="headerlink" title="Heat(编排服务)简介"></a>Heat(编排服务)简介</h2><p>Heat是一个使用声明性模板格式，通过OpenStack 原生 REST API 编排复合云应用程序的服务。</p>
<p>Heat模板指定了资源之间的关系（例如，某个卷连接到某个实例）。这样，Heat 就可以调用 OpenStack API，以正确的顺序创建所有基础设施，从而完全启动应用程序。开发人员能够在程序中使用模板以实现资源的自动化部署。</p>
<h3 id="Heat特点"><a href="#Heat特点" class="headerlink" title="Heat特点"></a>Heat特点</h3><ol>
<li><p>标准化和可重复性：使用 Heat 可以将基础设施和应用程序的配置标准化为模板。这样可以在不同的环境中重复使用这些模板，从而确保配置的一致性和可重复性。无论是在开发、测试还是生产环境中，都可以使用相同的模板进行部署，提高了部署的可靠性和可维护性。</p>
</li>
<li><p>简化复杂性：在云环境中，应用程序通常由多个互相关联的资源组成，如虚拟机、网络、存储等。使用 Heat，您可以定义这些资源之间的依赖关系和配置规则，以确保它们按正确的顺序启动和配置。这样可以简化复杂的资源编排过程，减少手动操作和错误，并提供更一致的部署结果。</p>
</li>
<li><p>弹性和可伸缩性：Heat 允许根据需求动态调整资源的数量和规模。通过定义资源组和循环可以实现资源的弹性扩展和收缩，以适应应用程序的变化和负载的波动。这提供了更高的弹性和可伸缩性，使得应用程序可以根据需求自动调整资源。</p>
</li>
<li><p>可视化和审计：Heat 提供了堆栈拓扑图的可视化功能，可以直观地展示资源之间的关系和依赖。这对于理解和审核基础设施的配置非常有帮助。同时，Heat 还提供了审计功能，可以记录堆栈的操作和资源状态的变化，用于跟踪和审计的目的。</p>
</li>
</ol>
<h3 id="Heat基本概念"><a href="#Heat基本概念" class="headerlink" title="Heat基本概念"></a>Heat基本概念</h3><ol>
<li><p>堆栈（stack）：管理资源的集合。单个模板中定义的实例化资源的集合，是 Heat 管理应用程序的逻辑单元，往往对应一个应用程序。</p>
</li>
<li><p>模板（template）：如何使用代码定义和描述堆栈。描述了所有组件资源以及组件资源之间的关系，是 Heat 的核心。</p>
</li>
<li><p>资源（resource）：将在编排期间创建或修改的对象。资源可以是网络、路由器、子网、实例、卷、浮动IP、安全组等。</p>
</li>
</ol>
<h3 id="Heat架构"><a href="#Heat架构" class="headerlink" title="Heat架构"></a>Heat架构</h3><img src="https://vault.taojie.fun:28089/i/2023/12/04/2023-12-04-1701649020.png" alt="1701649019123.png" title="1701649019123.png" />

<ol>
<li><p>heat command-line client：CLI通过与 heat-api 通信，来调用 API 实现相关功能。终端开发者可以直接使用编排 REST API。</p>
</li>
<li><p>heat-api：实现 OpenStack 原生支持的 REST API。该组件通过把 API 请求经由 AMQP 传送给 Heat engine 来处理 API 请求。</p>
</li>
<li><p>heat-engine：执行模板内容，最终完成应用系统的创建和部署，并把执行结果返回给 API 调用者。</p>
</li>
</ol>
<h3 id="Heat命令"><a href="#Heat命令" class="headerlink" title="Heat命令"></a>Heat命令</h3><img src="https://vault.taojie.fun:28089/i/2023/12/04/2023-12-04-1701649472.png" alt="1701649471789.png" title="1701649471789.png" />

<h2 id="Heat实验"><a href="#Heat实验" class="headerlink" title="Heat实验"></a>Heat实验</h2><h3 id="作业与实验环境"><a href="#作业与实验环境" class="headerlink" title="作业与实验环境"></a>作业与实验环境</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://wxstc.fanya.chaoxing.com/portal">超星网址</a><br>虚拟机<code>openstack-allinone</code>，账户<code>root</code>，密码<code>000000</code></p>
</blockquote>
<ol>
<li><p>VmWare需要修改网络设置，在编辑-&gt;虚拟网络编辑器中将Vmnet1网卡的子网由原来的<code>192.168.10.0</code>改为<code>192.168.100.0</code>。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/12/03/2023-12-03-1701610473.png" alt="1701610472777.png" title="1701610472777.png" />
</li>
<li><p>后续实验需要启动实例，Horizon登录地址<code>192.168.100.10/dashboard</code>，使用域<code>xiandian</code>、用户名<code>admin</code>、密码<code>000000</code>登录之后<code>上传</code>本地<code>D盘</code>的cirros镜像到OpenStack平台。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/12/04/2023-12-04-1701650466.png" alt="1701650465473.png" title="1701650465473.png" />
</li>
<li><p>执行脚本完成身份认证。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># source /etc/keystone/admin-openrc.sh</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
<h3 id="通过模板启动一个堆栈"><a href="#通过模板启动一个堆栈" class="headerlink" title="通过模板启动一个堆栈"></a>通过模板启动一个堆栈</h3><ol>
<li><p>将以下模板文件保存到<code>demo.yaml</code>文件中：</p>
 <pre class="line-numbers language-YAML" data-language="YAML"><code class="language-YAML">heat_template_version: 2015-04-30

description: Simple template to deploy a single compute instance

resources:
  my_instance:
    type: OS::Nova::Server
    properties:
      image: cirros
      flavor: m1.small<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>通过模板文件启动一个名为<code>demo-struct</code>的堆栈：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack stack create -t demo.yaml demo-struct</span>
+---------------------+-----------------------------------------------------+
<span class="token operator">|</span> Field               <span class="token operator">|</span> Value                                               <span class="token operator">|</span>
+---------------------+-----------------------------------------------------+
<span class="token operator">|</span> <span class="token function">id</span>                  <span class="token operator">|</span> d76d18cc-e637-42f3-b4be-cbcaafd9740a                <span class="token operator">|</span>
<span class="token operator">|</span> stack_name          <span class="token operator">|</span> demo-struct                                         <span class="token operator">|</span>
<span class="token operator">|</span> description         <span class="token operator">|</span> Simple template to deploy a single compute instance <span class="token operator">|</span>
<span class="token operator">|</span> creation_time       <span class="token operator">|</span> <span class="token number">2023</span>-12-01T08:47:36                                 <span class="token operator">|</span>
<span class="token operator">|</span> updated_time        <span class="token operator">|</span> None                                                <span class="token operator">|</span>
<span class="token operator">|</span> stack_status        <span class="token operator">|</span> CREATE_IN_PROGRESS                                  <span class="token operator">|</span>
<span class="token operator">|</span> stack_status_reason <span class="token operator">|</span> Stack CREATE started                                <span class="token operator">|</span>
+---------------------+-----------------------------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>查看Horizon上的实例运行状态：</p>
 <img src="https://vault.taojie.fun:28089/i/2023/12/04/2023-12-04-1701651162.png" alt="1701651161368.png" title="1701651161368.png" />

<p> 或者通过OpenStack命令查看实例列表：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack server list</span>

+--------------------------------------+--------------------------------------+--------+---------------------+
<span class="token operator">|</span> ID                                   <span class="token operator">|</span> Name                                 <span class="token operator">|</span> Status <span class="token operator">|</span> Networks            <span class="token operator">|</span>
+--------------------------------------+--------------------------------------+--------+---------------------+
<span class="token operator">|</span> 2324c631-cf3e-49eb-a8e2-be384341e4ac <span class="token operator">|</span> demo-struct-my_instance-clk6vt6fuwe4 <span class="token operator">|</span> ACTIVE <span class="token operator">|</span>                     <span class="token operator">|</span>
+--------------------------------------+--------------------------------------+--------+---------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>作业1：查看实例的运行状态后截图上传。</p>
</blockquote>
</li>
<li><p>删除堆栈：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack stack delete demo-struct</span>
Are you sure you want to delete this stack<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span>? y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="模板文件基本构成"><a href="#模板文件基本构成" class="headerlink" title="模板文件基本构成"></a>模板文件基本构成</h3><p>参考上文的模板文件：</p>
<pre class="line-numbers language-YAML" data-language="YAML"><code class="language-YAML">heat_template_version: 2015-04-30

description: Simple template to deploy a single compute instance

resources:
  my_instance:
    type: OS::Nova::Server
    properties:
      image: cirros
      flavor: m1.small<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>heat_template_version: 每个模板文件必须要包含的键，值是具体的版本号，比如<code>2013-05-23</code>，参考<a target="_blank" rel="noopener" href="https://docs.openstack.org/heat/latest/template_guide/hot_spec.html#hot-spec-template-version">Heat template version list</a>获取版本号。</p>
</li>
<li><p>description: 可选的键，用来描述模板所执行操作，支持多行文本。</p>
</li>
<li><p>resorces: 必须要包含的键，至少需要定义一个resource，上述例子中定义了一个实例资源并包含了若干个属性。</p>
</li>
</ul>
<h3 id="模板文件的输入参数"><a href="#模板文件的输入参数" class="headerlink" title="模板文件的输入参数"></a>模板文件的输入参数</h3><p>模板文件中的<code>parameters</code>段允许用户在构建的过程中自定义模板。比如用户可以提供<code>镜像ID</code>和<code>实例类型</code>来构建堆栈，通过输入参数可以使得模板更容易重用。</p>
<ol>
<li><p>以下是一个引入数据参数的模板示例，参考修改上文的<code>demo.yaml</code>文件：</p>
 <pre class="line-numbers language-YAML" data-language="YAML"><code class="language-YAML">heat_template_version: 2015-04-30

description: Simple template to deploy a single compute instance

parameters:
  image_id:
    type: string
    label: Image ID
    description: Image to be used for compute instance
  flavor:
    type: string
    label: Instance Type
    description: Type of instance (flavor) to be used

resources:
  my_instance:
    type: OS::Nova::Server
    properties:
      image: &#123; get_param: image_id &#125;
      flavor: &#123; get_param: flavor &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> 模板中涉及到的两个参数必须在构建堆栈的过程中提供，<code>get_param</code>内建函数检索用户所提供的值并用于相关属性。</p>
</li>
<li><p>通过传递参数来构建堆栈:</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack stack create -t demo.yaml demo-struct --parameter image_id=cirros --parameter flavor=m1.small</span>
+---------------------+-----------------------------------------------------+
<span class="token operator">|</span> Field               <span class="token operator">|</span> Value                                               <span class="token operator">|</span>
+---------------------+-----------------------------------------------------+
<span class="token operator">|</span> <span class="token function">id</span>                  <span class="token operator">|</span> f3ab8bbe-f769-495f-88db-46a6a373aa22                <span class="token operator">|</span>
<span class="token operator">|</span> stack_name          <span class="token operator">|</span> demo-struct                                         <span class="token operator">|</span>
<span class="token operator">|</span> description         <span class="token operator">|</span> Simple template to deploy a single compute instance <span class="token operator">|</span>
<span class="token operator">|</span> creation_time       <span class="token operator">|</span> <span class="token number">2023</span>-12-04T09:24:14                                 <span class="token operator">|</span>
<span class="token operator">|</span> updated_time        <span class="token operator">|</span> None                                                <span class="token operator">|</span>
<span class="token operator">|</span> stack_status        <span class="token operator">|</span> CREATE_IN_PROGRESS                                  <span class="token operator">|</span>
<span class="token operator">|</span> stack_status_reason <span class="token operator">|</span>                                                     <span class="token operator">|</span>
+---------------------+-----------------------------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>给模板设置默认参数，默认参数可以当用户没有提供参数时用来构建堆栈。</p>
<p> 参考代码片段修改<code>demo.yaml</code>文件：</p>
 <pre class="line-numbers language-YAML" data-language="YAML"><code class="language-YAML">parameters:
  flavor:
    type: string
    label: Instance Type
    description: Flavor to be used
    default: m1.small<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> 当模板中没有设置默认参数时，用户必须提供所有参数，否则堆栈就会创建失败。</p>
</li>
<li><p>修改完以上片段后只提供image属性来启动一个堆栈。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack stack create -t demo.yaml demo-struct --parameter image_id=cirros</span>
+---------------------+-----------------------------------------------------+
<span class="token operator">|</span> Field               <span class="token operator">|</span> Value                                               <span class="token operator">|</span>
+---------------------+-----------------------------------------------------+
<span class="token operator">|</span> <span class="token function">id</span>                  <span class="token operator">|</span> 1765bf8d-f792-4ac7-b842-664773fa79c1                <span class="token operator">|</span>
<span class="token operator">|</span> stack_name          <span class="token operator">|</span> demo-struct                                         <span class="token operator">|</span>
<span class="token operator">|</span> description         <span class="token operator">|</span> Simple template to deploy a single compute instance <span class="token operator">|</span>
<span class="token operator">|</span> creation_time       <span class="token operator">|</span> <span class="token number">2023</span>-12-04T09:38:36                                 <span class="token operator">|</span>
<span class="token operator">|</span> updated_time        <span class="token operator">|</span> None                                                <span class="token operator">|</span>
<span class="token operator">|</span> stack_status        <span class="token operator">|</span> CREATE_IN_PROGRESS                                  <span class="token operator">|</span>
<span class="token operator">|</span> stack_status_reason <span class="token operator">|</span> Stack CREATE started                                <span class="token operator">|</span>
+---------------------+-----------------------------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>作业2：使用默认参数的方式启动堆栈后上传截图。</p>
</blockquote>
</li>
<li><p>对于用户输入的参数可以进行限制。</p>
<p> 可以通过在<code>parameters</code>段中添加<code>constraints</code>属性并定义一个列表来限制用户输入的参数，参考以下片段修改<code>demo.yaml</code>:</p>
 <pre class="line-numbers language-YAML" data-language="YAML"><code class="language-YAML">parameters:
    flavor:
        type: string
        label: Instance Type
        description: Type of instance (flavor) to be used
        constraints:
        - allowed_values: [ m1.medium, m1.large, m1.xlarge ]
          description: Value must be one of m1.medium, m1.large or m1.xlarge.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> 除了直接对参数的值做限制以外还可以使用多个条件进行限制，下面是一个限制指定创建数据库密码的参数的示例：</p>
 <pre class="line-numbers language-YAML" data-language="YAML"><code class="language-YAML">parameters:
    database_password:
        type: string
        label: Database Password
        description: Password to be used for database
        hidden: true
        constraints:
        - length: &#123; min: 6, max: 8 &#125;
          description: Password length must be between 6 and 8 characters.
        - allowed_pattern: &quot;[a-zA-Z0-9]+&quot;
          description: Password must consist of characters and numbers only.
        - allowed_pattern: &quot;[A-Z]+[a-zA-Z0-9]*&quot;
          description: Password must start with an uppercase character.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="编写一个模板文件"><a href="#编写一个模板文件" class="headerlink" title="编写一个模板文件"></a>编写一个模板文件</h3><p>参考以下代码编写一个模板文件，实现从卷启动实例。</p>
<pre class="line-numbers language-YAML" data-language="YAML"><code class="language-YAML">resources:
  bootable_volume:
    type: OS::Cinder::Volume
    properties:
      size: 10
      image: ubuntu-trusty-x86_64

  instance:
    type: OS::Nova::Server
    properties:
      flavor: m1.small
      networks:
        - network: private
      block_device_mapping:
        - device_name: vda
          volume_id: &#123; get_resource: bootable_volume &#125;
          delete_on_termination: false<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>作业3：进入实例的控制台后截图上传。</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/11/15/private_clouds/10.OpenStack%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86-Swift/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/11/15/private_clouds/10.OpenStack%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86-Swift/" class="post-title-link" itemprop="url">OpenStack存储管理-Swift</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-11-15 16:21:22" itemprop="dateCreated datePublished" datetime="2023-11-15T16:21:22+08:00">2023-11-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-12-12 11:06:08" itemprop="dateModified" datetime="2023-12-12T11:06:08+08:00">2023-12-12</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Swift相关概念"><a href="#Swift相关概念" class="headerlink" title="Swift相关概念"></a>Swift相关概念</h2><p>Swift是一个分布式对象存储系统，属于OpenStack的一个核心组件之一。作为对象存储它可以为大规模的数据存储提供高可用性、可扩展性和数据安全性。它允许用户将大量的数据存储在云上，并且可以随时访问、检索和管理这些数据。在openstack中，Swift也可以作为Glance的后端存储，负责存储镜像文件。</p>
<h3 id="块存储、对象存储、文件存储"><a href="#块存储、对象存储、文件存储" class="headerlink" title="块存储、对象存储、文件存储"></a>块存储、对象存储、文件存储</h3><p>这三者的本质差别是使用数据的“用户”不同：块存储的用户是可以读写块设备的软件系统，例如传统的文件系统、数据库；文件存储的用户是自然人；对象存储的用户则是其它计算机软件。</p>
<h3 id="Swift特点"><a href="#Swift特点" class="headerlink" title="Swift特点"></a>Swift特点</h3><ol>
<li><p>高可用性：Swift采用了多副本、冗余和分布式架构，以确保数据的高可用性和可靠性。当一个存储节点发生故障时，系统可以自动地将数据复制到其他节点上，以保证数据的完整性和可用性。</p>
</li>
<li><p>可扩展性：Swift可以轻松地扩展到数千台服务器，支持PB级别的数据存储，同时也支持水平和垂直扩展，以应对日益增长的数据需求。</p>
</li>
<li><p>强安全性：Swift提供了多种安全机制，包括认证、授权、访问控制、加密等，以保护用户的数据免受恶意攻击和非法访问。</p>
</li>
<li><p>高性能：Swift采用了分布式存储和负载均衡技术，以确保数据的快速访问和高效传输。同时，Swift还支持多种数据访问协议，如RESTful API、Swift API、S3 API等，以满足不同用户的需求。</p>
</li>
<li><p>易用性：Swift提供了简单、易用的API和Web界面。</p>
</li>
</ol>
<h3 id="Swift架构"><a href="#Swift架构" class="headerlink" title="Swift架构"></a>Swift架构</h3><img src="https://vault.taojie.fun:28089/i/2023/11/18/2023-11-18-1700271777.png" alt="1700271777569.png" title="1700271777569.png" />

<h4 id="Swift对象的层次模型"><a href="#Swift对象的层次模型" class="headerlink" title="Swift对象的层次模型"></a>Swift对象的层次模型</h4><img src="https://vault.taojie.fun:28089/i/2023/11/16/2023-11-16-1700110449.png" alt="1700110449415.png" title="1700110449415.png" />

<ol>
<li><p>Swift 采用层次数据模型，共设三层逻辑结构：Account&#x2F;Container&#x2F;Object（即账户&#x2F;容器&#x2F;对象），每层节点数均没有限制，可以任意扩展。</p>
</li>
<li><p>账户和个人账户不是一个概念，可理解为租户，用来做顶层的隔离机制，可以被多个个人账户所共同使用。</p>
</li>
<li><p>容器代表封装一组对象，类似文件夹或目录（容器不能像文件夹一样嵌套）；叶子节点代表对象（对象由元数据和内容两部分组成）。</p>
</li>
</ol>
<img src="https://vault.taojie.fun:28089/i/2023/11/18/2023-11-18-1700272354.png" alt="1700272354216.png" title="1700272354216.png" />

<h4 id="数据一致性"><a href="#数据一致性" class="headerlink" title="数据一致性"></a>数据一致性</h4><ol>
<li><p>Replicator(复制器) – 复制的目的是在网络中断或硬盘故障等临时错误情况下保持系统状态一致。复制过程将本地数据与每个远程副本进行比较，以确保它们都包含最新版本。</p>
</li>
<li><p>Updater(更新器) – 有时，容器或账户数据无法立即更新。这通常发生在故障情况或高负载期间。如果更新失败，更新会在本地文件系统上排队，更新器将处理失败的更新。</p>
</li>
<li><p>Auditor(审计器) – 审计器会抓取本地服务器，检查对象、容器和账户的完整性。如果发现损坏，文件将被隔离，复制器将从另一个副本替换坏文件。</p>
</li>
</ol>
<h2 id="Swift实验"><a href="#Swift实验" class="headerlink" title="Swift实验"></a>Swift实验</h2><h3 id="作业与实验环境"><a href="#作业与实验环境" class="headerlink" title="作业与实验环境"></a>作业与实验环境</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://wxstc.fanya.chaoxing.com/portal">超星网址</a><br>虚拟机<code>openstack-allinone</code>，账户<code>root</code>，密码<code>000000</code></p>
</blockquote>
<p>VmWare需要修改网络设置，在编辑-&gt;虚拟网络编辑器中将Vmnet1网卡的子网由原来的<code>192.168.10.0</code>改为<code>192.168.100.0</code>。</p>
<img src="https://vault.taojie.fun:28089/i/2023/12/03/2023-12-03-1701610473.png" alt="1701610472777.png" title="1701610472777.png" />

<h3 id="Swift命令行使用"><a href="#Swift命令行使用" class="headerlink" title="Swift命令行使用"></a>Swift命令行使用</h3><ol>
<li><p>查看系统中正在运行的swift相关的服务。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># systemctl -l |grep "swift"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

 <img src="https://vault.taojie.fun:28089/i/2023/11/18/2023-11-18-1700273105.png" alt="1700273105539.png" title="1700273105539.png" />
</li>
<li><p>执行脚本完成身份认证。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># source /etc/keystone/admin-openrc.sh</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>swift命令行工具的名称是<code>swift</code>，可通过<code>swift post</code>命令创建容器。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># swift post test_container</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>使用<code>swift list</code>命令插件当前用户下所创建的容器。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># swift list</span>
test_container<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>创建一个文件并把它上传到容器<code>test_container</code>中。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># touch test.txt</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># swift upload test_container test.txt</span>
test.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>同样使用<code>swift list</code> + <code>容器名</code>可以列出指定容器内所包含的对象。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># swift list test_container</span>
test.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>使用<code>swift download</code>命令将对象从存储中下载到本地。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># swift download test_container test.txt</span>
test.txt <span class="token punctuation">[</span>auth <span class="token number">0</span>.694s, headers <span class="token number">1</span>.014s, total <span class="token number">1</span>.015s, <span class="token number">0.000</span> MB/s<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>查看当前存储情况。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># swift stat</span>
                        Account: AUTH_f9ff39ba9daa4e5a8fee1fc50e2d2b34
                    Containers: <span class="token number">1</span>
                        Objects: <span class="token number">1</span>
                        Bytes: <span class="token number">0</span>
Containers <span class="token keyword">in</span> policy <span class="token string">"policy-0"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>
Objects <span class="token keyword">in</span> policy <span class="token string">"policy-0"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>
    Bytes <span class="token keyword">in</span> policy <span class="token string">"policy-0"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>
    X-Account-Project-Domain-Id: 9321f21a94ef4f85993e92a228892418
                    X-Timestamp: <span class="token number">1700303560.27498</span>
                    X-Trans-Id: txa1c625c0e1f845b883322-006558a140
                Content-Type: text/plain<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
                Accept-Ranges: bytes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>作业1：使用命令查看当前的存储情况后截图。</p>
</blockquote>
</li>
<li><p>使用<code>swift delete</code>删除容器中的对象。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># swift delete test_container test.txt</span>
test.txt
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># swift list test_container</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="Swift-Api使用"><a href="#Swift-Api使用" class="headerlink" title="Swift Api使用"></a>Swift Api使用</h3><ol>
<li><p>使用<code>swift auth</code>获取swift服务的地址和token(令牌)。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># swift auth</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">OS_STORAGE_URL</span><span class="token operator">=</span>http://controller:8080/v1/AUTH_f9ff39ba9daa4e5a8fee1fc50e2d2b34
<span class="token builtin class-name">export</span> <span class="token assign-left variable">OS_AUTH_TOKEN</span><span class="token operator">=</span>gAAAAABlWKPJhp_TU9OxT6j7jzESq5oyxTE25nk_0Idy0BfaNv75-rMwXtUEfRNqBES5IJ0dV3k-BjejVSta5rpEctCWpeyxTYSmqwRYTB6En1yr678mNgQzwJUJKY2CFKnS28K1UX_lOrI1T0zzgeTtYucrV3sYPX9cR9vfeIsnZkcnEAaxFbYwLKgltlZ8kOeqIikD-_Ka<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>执行上述命令将url和获取到的token导出为环境变量。</p>
</li>
<li><p>使用<code>curl</code>工具通过<code>GET</code>请求方式查看当前的容器列表。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># curl -X GET -H "X-Auth-Token: $OS_AUTH_TOKEN" $OS_STORAGE_URL</span>
test_container<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>通过<code>PUT</code>请求，上传文件到对象存储并命名为<code>test.txt</code>，然后查看容器内的对象列表。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># curl -X PUT -H "X-Auth-Token: $OS_AUTH_TOKEN" --data-binary "/root/test.txt" $OS_STORAGE_URL/test_container/test.txt</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># curl -X GET -H "X-Auth-Token: $OS_AUTH_TOKEN" $OS_STORAGE_URL/test_container</span>
test.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<blockquote>
<p>作业2：通过api请求查看到容器内的对象列表后截图上传。</p>
</blockquote>
<h3 id="Horizon界面使用对象存储"><a href="#Horizon界面使用对象存储" class="headerlink" title="Horizon界面使用对象存储"></a>Horizon界面使用对象存储</h3><p>Horizon登录地址<code>192.168.100.10/dashboard</code>，使用域<code>xiandian</code>、用户名<code>admin</code>、密码<code>000000</code>登录。</p>
<p>在项目-&gt;对象存储菜单内可以上传、删除文件，也可以对容器进行管理。</p>
<img src="https://vault.taojie.fun:28089/i/2023/11/19/2023-11-19-1700395312.png" alt="1700395313493.png" title="1700395313493.png" />

<h3 id="配置Swift作为Glance后端存储"><a href="#配置Swift作为Glance后端存储" class="headerlink" title="配置Swift作为Glance后端存储"></a>配置Swift作为Glance后端存储</h3><p>Glance的后端存储默认为本地e文件系统，这个实验是将Glance的后端存储配置为Swift对象存储，上传到OpenStack平台的镜像文件会被保存在对象存储中。</p>
<ol>
<li><p>修改Glance的配置文件<code>/etc/glance/glance-api.conf</code>。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>glance_store<span class="token punctuation">]</span>
<span class="token comment"># 添加swift存储</span>
stores <span class="token operator">=</span> file,http,swift
<span class="token comment"># 默认使用swift存储</span>
default_store <span class="token operator">=</span> swift<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 设置多项目存储以及项目授权</span>
swift_store_multi_tenant <span class="token operator">=</span> <span class="token boolean">true</span>
swift_store_admin_tenants <span class="token operator">=</span> admin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 设置允许创建容器</span>
swift_store_create_container_on_put <span class="token operator">=</span> <span class="token boolean">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>重启Glance相关服务。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart openstack-glance*</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>登录Horizon控制台上传镜像并验证对象存储内的镜像文件。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/11/20/2023-11-20-1700464992.png" alt="1700464991941.png" title="1700464991941.png" />

 <img src="https://vault.taojie.fun:28089/i/2023/11/20/2023-11-20-1700465024.png" alt="1700465024334.png" title="1700465024334.png" /></li>
</ol>
<blockquote>
<p>作业3：上传镜像文件后能在容器菜单内看到上传的镜像后截图。</p>
</blockquote>
<h3 id="Swift-ACL-访问控制"><a href="#Swift-ACL-访问控制" class="headerlink" title="Swift ACL(访问控制)"></a>Swift ACL(访问控制)</h3><p>通常，要创建、读取和修改容器和对象，必须是帐户的所有者。但是，所有者可以使用访问控制列表 (ACL) 向其他用户授予访问权限。</p>
<p>ACL 有两种类型：</p>
<ul>
<li><p>Container ACLs(容器 ACL)：这些是在容器上指定的，并且仅适用于该容器和容器中的对象。</p>
</li>
<li><p>Account ACLs(帐户 ACL)：这些是在帐户级别指定的，并适用于帐户中的所有容器和对象。</p>
</li>
</ul>
<p>容器 ACL 存储在 <code>X-Container-Write</code> 和 <code>X-Container-Read</code> 元数据中。</p>
<ul>
<li><p>X-Container-Write 授予对容器内的对象执行 PUT、POST 和 DELETE 操作的能力。</p>
</li>
<li><p>X-Container-Read 授予对容器内的对象执行 GET 和 HEAD 操作的能力。</p>
</li>
</ul>
<p>容器 ACL 使用”V1” ACL 语法，它是逗号分隔的元素字符串，如下例所示：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">.r:*,.rlistings,7ec59e87c6584c348b563254aae4c221:*<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>常见的ACL元素：</p>
<ul>
<li><p>.r:*：任何用户都可以访问对象。请求中不需要令牌。</p>
</li>
<li><p>.r:<referrer>：引用者被授予对对象的访问权限。 Referrer 由请求中的 Referer 请求头标识。不需要令牌。</p>
</li>
<li><p>.rlistings：任何用户都可以对容器执行 HEAD 或 GET 操作，前提是该用户还具有对象的读取访问权限（例如，还具有 .r:* 或 .r:<referrer>。不需要令牌。</p>
</li>
</ul>
<ol>
<li><p>容器ACL示例1：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 以下内容允许任何人列出 www 容器中的对象并下载对象。用户不需要在请求中包含令牌。</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># swift post test_container --read-acl ".r:*,.rlistings"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看容器的元数据信息</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># swift stat test_container</span>
        Account: AUTH_f9ff39ba9daa4e5a8fee1fc50e2d2b34
    Container: test_container
        Objects: <span class="token number">1</span>
        Bytes: <span class="token number">16338944</span>
        Read ACL: .r:*,.rlistings
    Write ACL: f9ff39ba9daa4e5a8fee1fc50e2d2b34:*
        Sync To:
        Sync Key:
Accept-Ranges: bytes
    X-Trans-Id: txe1e7e2f4469447688ca85-00655cd5e2
X-Storage-Policy: Policy-0
    X-Timestamp: <span class="token number">1700517288.39236</span>
    Content-Type: text/plain<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> 在admin用户下将demo用户添加到admin项目成员中。<br> 退出当前的admin用户，使用demo用户登录、切换项目至admin、查看容器<code>test_container</code>的信息。</p>
<blockquote>
<p>作业4：使用demo用户能够看到容器信息后截图。</p>
</blockquote>
</li>
<li><p>容器ACL示例2：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 以下内容允许 77b8f82565f14814bece56e50c4c240f 项目的任何成员上传和下载对象或列出 www 容器的内容。请求中必须包含范围为 77b8f82565f14814bece56e50c4c240f 项目的令牌：</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># swift post test_container --read-acl "77b8f82565f14814bece56e50c4c240f:*" \</span>
            --write-acl <span class="token string">"77b8f82565f14814bece56e50c4c240f:*"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/11/08/private_clouds/9.OpenStack%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86-Cinder/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/11/08/private_clouds/9.OpenStack%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86-Cinder/" class="post-title-link" itemprop="url">OpenStack存储管理-Cinder</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-11-08 13:37:36" itemprop="dateCreated datePublished" datetime="2023-11-08T13:37:36+08:00">2023-11-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-11-28 12:58:29" itemprop="dateModified" datetime="2023-11-28T12:58:29+08:00">2023-11-28</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="作业与实验环境"><a href="#作业与实验环境" class="headerlink" title="作业与实验环境"></a>作业与实验环境</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://wxstc.fanya.chaoxing.com/portal">超星网址</a><br><code>快照管理</code>：控制节点和计算节点选择均是默认的<code>项目12</code></p>
</blockquote>
<h2 id="LVM相关概念"><a href="#LVM相关概念" class="headerlink" title="LVM相关概念"></a>LVM相关概念</h2><h3 id="LVM架构"><a href="#LVM架构" class="headerlink" title="LVM架构"></a>LVM架构</h3><img src="https://vault.taojie.fun:28089/i/2023/11/12/2023-11-12-1699759786.png" alt="1699759786593.png" title="1699759786593.png" />

<h3 id="LVM基本概念"><a href="#LVM基本概念" class="headerlink" title="LVM基本概念"></a>LVM基本概念</h3><ul>
<li><p>LVM(Logical Volume Manager):</p>
<p>  LVM是Linux环境下对磁盘分区进行管理的一种机制，LVM是建立在硬盘和分区之上的一个逻辑层，来提高磁盘分区管理的灵活性。通过LVM系统管理员可以轻松管理磁盘分区，如：将若干个磁盘分区连接为一个整块的卷组 （volumegroup），形成一个存储池。管理员可以在卷组上随意创建逻辑卷组（logicalvolumes），并进一步在逻辑卷组上创建文件系 统。管理员通过LVM可以方便的调整存储卷组的大小，并且可以对磁盘存储按照组的方式进行命名、管理和分配，例如按照使用用途进行定义，而不是使用物理磁盘名”sda”和”sdb”。而且当系统添加了新的磁盘，通过LVM管理员就不必将磁盘的文件移动到新的磁盘上以充分利用新的存储空间，而是直接扩展文件系统跨越磁盘即可。</p>
</li>
<li><p>物理卷（Physical Volume，PV）</p>
<p>  物理卷是逻辑卷管理（LVM）中的概念，物理卷就是指磁盘、磁盘分区或从逻辑上与磁盘分区具有同样功能的设备(如RAID)，是LVM的基本存储逻辑块，但和基本的物理存储介质（如分区、磁盘等）比较，却包含有与LVM相关的管理参数。</p>
</li>
<li><p>物理块（Physical Extent，PE）</p>
<p>  每一个物理卷PV被划分为称为PE的基本单元，具有唯一编号的PE是可以被LVM寻址的最小单元。PE的大小是可配置的，默认为4MB。所以物理卷（PV）由大小等同的基本单元PE组成</p>
</li>
<li><p>卷组（Volume Group，VG）</p>
<p>  卷组是一个逻辑概念，它是由一个或多个物理卷组成的存储池。可以把卷组想象为一块逻辑硬盘，在卷组上创建一个或多个LV（逻辑卷）。</p>
</li>
<li><p>逻辑卷（Logical Volume，LV）</p>
<p>  逻辑卷是在卷组上创建的逻辑存储卷，它们提供了一种更灵活和可管理的方法来管理存储空间。逻辑卷可以具有自己的文件系统，并可以被格式化、挂载和管理，就像物理磁盘一样。逻辑卷可以根据需求进行动态调整大小，因此可以更方便地管理存储空间。</p>
</li>
</ul>
<img src="https://vault.taojie.fun:28089/i/2023/11/12/2023-11-12-1699759852.png" alt="1699759851924.png" title="1699759851924.png" />

<h3 id="LVM常用命令"><a href="#LVM常用命令" class="headerlink" title="LVM常用命令"></a>LVM常用命令</h3><ul>
<li><p>pvcreate：创建一个新的物理卷。示例：pvcreate &#x2F;dev&#x2F;sdb1。</p>
</li>
<li><p>pvdisplay：显示一个或多个物理卷的详细信息。</p>
</li>
<li><p>vgcreate：创建一个新的卷组。示例：vgcreate myvg &#x2F;dev&#x2F;sdb1。</p>
</li>
<li><p>vgdisplay：显示一个或多个卷组的详细信息。</p>
</li>
<li><p>vgextend：将一个或多个物理卷添加到现有卷组。示例：vgextend myvg &#x2F;dev&#x2F;sdc1。</p>
</li>
<li><p>lvcreate：在卷组中创建一个新的逻辑卷。示例：lvcreate -L 10G -n mylv myvg。</p>
</li>
<li><p>lvdisplay：显示一个或多个逻辑卷的详细信息。</p>
</li>
<li><p>lvextend：增加逻辑卷的大小。示例：lvextend -L +5G &#x2F;dev&#x2F;myvg&#x2F;mylv。</p>
</li>
</ul>
<h3 id="LVM逻辑卷扩展"><a href="#LVM逻辑卷扩展" class="headerlink" title="LVM逻辑卷扩展"></a>LVM逻辑卷扩展</h3><ol>
<li><p>查看计算节点的物理卷和卷组的信息。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># pvdisplay</span>
--- Physical volume ---
PV Name               <span class="token punctuation">[</span>unknown<span class="token punctuation">]</span>
VG Name               centos
PV Size               <span class="token number">97.46</span> GiB / not usable <span class="token number">4.00</span> MiB
Allocatable           <span class="token function">yes</span>
PE Size               <span class="token number">4.00</span> MiB
Total PE              <span class="token number">24949</span>
Free PE               <span class="token number">1</span>
Allocated PE          <span class="token number">24948</span>
PV UUID               3THuGY-5NLo-b3Nc-PehS-Nosp-fQT0-swRkgK

--- Physical volume ---
PV Name               /dev/sdb
VG Name               cinder-volumes
PV Size               <span class="token number">20.00</span> GiB / not usable <span class="token number">4.00</span> MiB
Allocatable           <span class="token function">yes</span>
PE Size               <span class="token number">4.00</span> MiB
Total PE              <span class="token number">5119</span>
Free PE               <span class="token number">245</span>
Allocated PE          <span class="token number">4874</span>
PV UUID               vSDAxW-GzVr-ldTC-qE25-ug1y-mfVT-6cfTJv
<span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># vgdisplay cinder-volumes</span>
    --- Volume group ---
VG Name               cinder-volumes
System ID
Format                lvm2
Metadata Areas        <span class="token number">1</span>
Metadata Sequence No  <span class="token number">4</span>
VG Access             read/write
VG Status             resizable
MAX LV                <span class="token number">0</span>
Cur LV                <span class="token number">1</span>
Open LV               <span class="token number">0</span>
Max PV                <span class="token number">0</span>
Cur PV                <span class="token number">1</span>
Act PV                <span class="token number">1</span>
VG Size               <span class="token operator">&lt;</span><span class="token number">20.00</span> GiB
PE Size               <span class="token number">4.00</span> MiB
Total PE              <span class="token number">5119</span>
Alloc PE / Size       <span class="token number">4874</span> / <span class="token operator">&lt;</span><span class="token number">19.04</span> GiB
Free  PE / Size       <span class="token number">245</span> / <span class="token number">980.00</span> MiB
VG UUID               254qGq-XDu8-Tq4S-xaBI-cInk-op3B-YmtOqw<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>查看逻辑卷信息。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># lvdisplay</span>
--- Logical volume ---
LV Name                cinder-volumes-pool
VG Name                cinder-volumes
LV UUID                B8WmC3-3BYJ-Gh0s-qdCI-WdLm-CDOK-rOEhNf
LV Write Access        read/write
LV Creation host, <span class="token function">time</span> compute, <span class="token number">2022</span>-05-01 02:31:17 <span class="token parameter variable">-0400</span>
LV Pool metadata       cinder-volumes-pool_tmeta
LV Pool data           cinder-volumes-pool_tdata
LV Status              available
<span class="token comment"># open                 0</span>
LV Size                <span class="token number">19.00</span> GiB
Allocated pool data    <span class="token number">0.00</span>%
Allocated metadata     <span class="token number">10.55</span>%
Current LE             <span class="token number">4864</span>
Segments               <span class="token number">1</span>
Allocation             inherit
Read ahead sectors     auto
- currently <span class="token builtin class-name">set</span> to     <span class="token number">8192</span>
Block device           <span class="token number">253</span>:4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>增加虚拟机硬盘。</p>
<blockquote>
<p>这一步在计算节点关机状态下添加硬盘。</p>
</blockquote>
 <img src="https://vault.taojie.fun:28089/i/2023/11/13/2023-11-13-1699841172.png" alt="1699841171866.png" title="1699841171866.png" />

 <img src="https://vault.taojie.fun:28089/i/2023/11/13/2023-11-13-1699841208.png" alt="1699841208005.png" title="1699841208005.png" />

 <img src="https://vault.taojie.fun:28089/i/2023/11/13/2023-11-13-1699841122.png" alt="1699841121338.png" title="1699841121338.png" />

<blockquote>
<p>添加硬盘后启动系统，<code>lsblk</code>命令查看新添加的硬盘<code>/dev/sdc</code>。</p>
</blockquote>
</li>
<li><p>设置LVM过滤。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1.修改lvm.conf第130行不过滤/dev/sdc</span>
<span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/lvm/lvm.conf</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p> 将原文：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">filter <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">"a/sdb/"</span>,<span class="token string">"r/.*/"</span> <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> 修改为：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">filter <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">"a/sdb/"</span>,<span class="token string">"a/sdc/"</span>,<span class="token string">"r/.*/"</span> <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>为<code>/dev/sdc</code>创建物理卷。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># pvcreate /dev/sdc</span>
WARNING: Device <span class="token keyword">for</span> PV 3THuGY-5NLo-b3Nc-PehS-Nosp-fQT0-swRkgK not found or rejected by a filter.
WARNING: Device <span class="token keyword">for</span> PV 3THuGY-5NLo-b3Nc-PehS-Nosp-fQT0-swRkgK not found or rejected by a filter.
WARNING: Device <span class="token keyword">for</span> PV 3THuGY-5NLo-b3Nc-PehS-Nosp-fQT0-swRkgK not found or rejected by a filter.
Couldn<span class="token string">'t find device with uuid 3THuGY-5NLo-b3Nc-PehS-Nosp-fQT0-swRkgK.
WARNING: Couldn'</span>t <span class="token function">find</span> all devices <span class="token keyword">for</span> LV centos/root <span class="token keyword">while</span> checking used and assumed devices.
WARNING: Couldn't <span class="token function">find</span> all devices <span class="token keyword">for</span> LV centos/swap <span class="token keyword">while</span> checking used and assumed devices.
Physical volume <span class="token string">"/dev/sdc"</span> successfully created.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>将物理卷添加到原有的卷组中。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># vgextend cinder-volumes /dev/sdc</span>
WARNING: Device <span class="token keyword">for</span> PV 3THuGY-5NLo-b3Nc-PehS-Nosp-fQT0-swRkgK not found or rejected by a filter.
WARNING: Device <span class="token keyword">for</span> PV 3THuGY-5NLo-b3Nc-PehS-Nosp-fQT0-swRkgK not found or rejected by a filter.
Couldn<span class="token string">'t find device with uuid 3THuGY-5NLo-b3Nc-PehS-Nosp-fQT0-swRkgK.
WARNING: Couldn'</span>t <span class="token function">find</span> all devices <span class="token keyword">for</span> LV centos/root <span class="token keyword">while</span> checking used and assumed devices.
WARNING: Couldn't <span class="token function">find</span> all devices <span class="token keyword">for</span> LV centos/swap <span class="token keyword">while</span> checking used and assumed devices.
Volume group <span class="token string">"cinder-volumes"</span> successfully extended<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> 查看扩展后的卷组信息，扩展后卷组大小为40G。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># vgdisplay cinder-volumes</span>
--- Volume group ---
VG Name               cinder-volumes
System ID
Format                lvm2
Metadata Areas        <span class="token number">2</span>
Metadata Sequence No  <span class="token number">5</span>
VG Access             read/write
VG Status             resizable
MAX LV                <span class="token number">0</span>
Cur LV                <span class="token number">1</span>
Open LV               <span class="token number">0</span>
Max PV                <span class="token number">0</span>
Cur PV                <span class="token number">2</span>
Act PV                <span class="token number">2</span>
VG Size               <span class="token number">39.99</span> GiB
PE Size               <span class="token number">4.00</span> MiB
Total PE              <span class="token number">10238</span>
Alloc PE / Size       <span class="token number">4874</span> / <span class="token operator">&lt;</span><span class="token number">19.04</span> GiB
Free  PE / Size       <span class="token number">5364</span> / <span class="token number">20.95</span> GiB
VG UUID               254qGq-XDu8-Tq4S-xaBI-cInk-op3B-YmtOqw<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>作业1：查看扩展后的卷组信息，截图上传。</p>
</blockquote>
</li>
</ol>
<h2 id="Cinder块存储服务"><a href="#Cinder块存储服务" class="headerlink" title="Cinder块存储服务"></a>Cinder块存储服务</h2><p>Cinder 是 OpenStack 中的块存储服务组件，用于提供持久化的块级存储。Cinder向用户提供基于数据块的存储设备访问服务，以卷的形式提供给虚拟机实例挂载，为实例提供额外的存储空间。用户可以自主创建、管理和分配块存储卷，并将这些卷连接到虚拟机实例，以供其使用。</p>
<ol>
<li><p>列出卷的信息、查看卷的详细信息。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack volume list          # 1.查看当前的卷信息</span>
+--------------------------------------+---------+-----------------+------+-------------+
<span class="token operator">|</span> ID                                   <span class="token operator">|</span> Name    <span class="token operator">|</span> Status          <span class="token operator">|</span> Size <span class="token operator">|</span> Attached to <span class="token operator">|</span>
+--------------------------------------+---------+-----------------+------+-------------+
<span class="token operator">|</span> b1c5b9d3-499f-4293-870b-817be71c902f <span class="token operator">|</span> <span class="token builtin class-name">test</span>    <span class="token operator">|</span> available       <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>             <span class="token operator">|</span>
<span class="token operator">|</span> 25d8550f-5c82-4355-b4cd-3eeef2a4cdf2 <span class="token operator">|</span> volume1 <span class="token operator">|</span> available       <span class="token operator">|</span>    <span class="token number">8</span> <span class="token operator">|</span>             <span class="token operator">|</span>
+--------------------------------------+---------+-----------------+------+-------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack volume show volume1</span>
+--------------------------------+--------------------------------------+
<span class="token operator">|</span> Field                          <span class="token operator">|</span> Value                                <span class="token operator">|</span>
+--------------------------------+--------------------------------------+
<span class="token operator">|</span> attachments                    <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>                                   <span class="token operator">|</span>
<span class="token operator">|</span> availability_zone              <span class="token operator">|</span> nova                                 <span class="token operator">|</span>
<span class="token operator">|</span> bootable                       <span class="token operator">|</span> <span class="token boolean">false</span>                                <span class="token operator">|</span>
<span class="token operator">|</span> consistencygroup_id            <span class="token operator">|</span> None                                 <span class="token operator">|</span>
<span class="token operator">|</span> created_at                     <span class="token operator">|</span> <span class="token number">2022</span>-05-01T16:22:34.000000           <span class="token operator">|</span>
<span class="token operator">|</span> description                    <span class="token operator">|</span> None                                 <span class="token operator">|</span>
<span class="token operator">|</span> encrypted                      <span class="token operator">|</span> False                                <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token function">id</span>                             <span class="token operator">|</span> 25d8550f-5c82-4355-b4cd-3eeef2a4cdf2 <span class="token operator">|</span>
<span class="token operator">|</span> migration_status               <span class="token operator">|</span> None                                 <span class="token operator">|</span>
<span class="token operator">|</span> multiattach                    <span class="token operator">|</span> False                                <span class="token operator">|</span>
<span class="token operator">|</span> name                           <span class="token operator">|</span> volume1                              <span class="token operator">|</span>
<span class="token operator">|</span> os-vol-host-attr:host          <span class="token operator">|</span> compute@lvm<span class="token comment">#LVM                      |</span>
<span class="token operator">|</span> os-vol-mig-status-attr:migstat <span class="token operator">|</span> None                                 <span class="token operator">|</span>
<span class="token operator">|</span> os-vol-mig-status-attr:name_id <span class="token operator">|</span> None                                 <span class="token operator">|</span>
<span class="token operator">|</span> os-vol-tenant-attr:tenant_id   <span class="token operator">|</span> c0cd683769ba4985bc58cc5d32aaebd9     <span class="token operator">|</span>
<span class="token operator">|</span> properties                     <span class="token operator">|</span>                                      <span class="token operator">|</span>
<span class="token operator">|</span> replication_status             <span class="token operator">|</span> None                                 <span class="token operator">|</span>
<span class="token operator">|</span> size                           <span class="token operator">|</span> <span class="token number">8</span>                                    <span class="token operator">|</span>
<span class="token operator">|</span> snapshot_id                    <span class="token operator">|</span> None                                 <span class="token operator">|</span>
<span class="token operator">|</span> source_volid                   <span class="token operator">|</span> None                                 <span class="token operator">|</span>
<span class="token operator">|</span> status                         <span class="token operator">|</span> available                            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token builtin class-name">type</span>                           <span class="token operator">|</span> __DEFAULT__                          <span class="token operator">|</span>
<span class="token operator">|</span> updated_at                     <span class="token operator">|</span> <span class="token number">2022</span>-05-01T17:20:13.000000           <span class="token operator">|</span>
<span class="token operator">|</span> user_id                        <span class="token operator">|</span> c54744d39bf94c9085026b2caaf26bfd     <span class="token operator">|</span>
+--------------------------------+--------------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>命令行、Horizon控制台创建、删除卷。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">openstack volume create
<span class="token punctuation">[</span>--size <span class="token operator">&lt;</span>大小<span class="token operator">></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>--type <span class="token operator">&lt;</span>卷类型<span class="token operator">></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>--image <span class="token operator">&lt;</span>镜像<span class="token operator">></span> <span class="token operator">|</span> <span class="token parameter variable">--snapshot</span> <span class="token operator">&lt;</span>快照<span class="token operator">></span> <span class="token operator">|</span> <span class="token parameter variable">--source</span> <span class="token operator">&lt;</span>卷<span class="token operator">></span> <span class="token punctuation">]</span>
<span class="token punctuation">[</span>--description <span class="token operator">&lt;</span>说明信息<span class="token operator">></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>--user <span class="token operator">&lt;</span>用户<span class="token operator">></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>--project <span class="token operator">&lt;</span>项目<span class="token operator">></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>--availability-zone <span class="token operator">&lt;</span>可用区域<span class="token operator">></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>--consistency-group <span class="token operator">&lt;</span>consistency-group<span class="token operator">></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>--property <span class="token operator">&lt;</span>键<span class="token operator">=</span>值<span class="token operator">></span> <span class="token punctuation">[</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">]</span>
<span class="token punctuation">[</span>--hint <span class="token operator">&lt;</span>键<span class="token operator">=</span>值<span class="token operator">></span> <span class="token punctuation">[</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">]</span>
<span class="token punctuation">[</span>--multi-attach<span class="token punctuation">]</span>
<span class="token punctuation">[</span>--bootable <span class="token operator">|</span> --non-bootable<span class="token punctuation">]</span>
<span class="token punctuation">[</span>--read-only <span class="token operator">|</span> --read-write<span class="token punctuation">]</span>
<span class="token operator">&lt;</span>卷名称<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack volume create --size 10 test_volume</span>
+---------------------+--------------------------------------+
<span class="token operator">|</span> Field               <span class="token operator">|</span> Value                                <span class="token operator">|</span>
+---------------------+--------------------------------------+
<span class="token operator">|</span> attachments         <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>                                   <span class="token operator">|</span>
<span class="token operator">|</span> availability_zone   <span class="token operator">|</span> nova                                 <span class="token operator">|</span>
<span class="token operator">|</span> bootable            <span class="token operator">|</span> <span class="token boolean">false</span>                                <span class="token operator">|</span>
<span class="token operator">|</span> consistencygroup_id <span class="token operator">|</span> None                                 <span class="token operator">|</span>
<span class="token operator">|</span> created_at          <span class="token operator">|</span> <span class="token number">2023</span>-11-08T05:58:29.000000           <span class="token operator">|</span>
<span class="token operator">|</span> description         <span class="token operator">|</span> None                                 <span class="token operator">|</span>
<span class="token operator">|</span> encrypted           <span class="token operator">|</span> False                                <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token function">id</span>                  <span class="token operator">|</span> 063025f5-172e-412f-9664-f111cc916ac0 <span class="token operator">|</span>
<span class="token operator">|</span> migration_status    <span class="token operator">|</span> None                                 <span class="token operator">|</span>
<span class="token operator">|</span> multiattach         <span class="token operator">|</span> False                                <span class="token operator">|</span>
<span class="token operator">|</span> name                <span class="token operator">|</span> test_volume                          <span class="token operator">|</span>
<span class="token operator">|</span> properties          <span class="token operator">|</span>                                      <span class="token operator">|</span>
<span class="token operator">|</span> replication_status  <span class="token operator">|</span> None                                 <span class="token operator">|</span>
<span class="token operator">|</span> size                <span class="token operator">|</span> <span class="token number">10</span>                                   <span class="token operator">|</span>
<span class="token operator">|</span> snapshot_id         <span class="token operator">|</span> None                                 <span class="token operator">|</span>
<span class="token operator">|</span> source_volid        <span class="token operator">|</span> None                                 <span class="token operator">|</span>
<span class="token operator">|</span> status              <span class="token operator">|</span> creating                             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token builtin class-name">type</span>                <span class="token operator">|</span> __DEFAULT__                          <span class="token operator">|</span>
<span class="token operator">|</span> updated_at          <span class="token operator">|</span> None                                 <span class="token operator">|</span>
<span class="token operator">|</span> user_id             <span class="token operator">|</span> c54744d39bf94c9085026b2caaf26bfd     <span class="token operator">|</span>
+---------------------+--------------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> 图形控制台界面创建卷：<code>项目</code>-&gt;<code>计算</code>-&gt;<code>卷</code>-&gt;<code>卷</code>创建卷。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/11/08/2023-11-08-1699423328.png" alt="1699423327655.png" title="1699423327655.png" />

<p> 命令行删除卷。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack volume delete volume1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>创建实例类型、网络、实例。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/09/15/2023-09-15-1694785336.png"/>

 <img src="https://vault.taojie.fun:28089/i/2023/11/06/2023-11-06-1699249390.png"/>

 <img src="https://vault.taojie.fun:28089/i/2023/11/06/2023-11-06-1699249465.png"/>

 <img src="https://vault.taojie.fun:28089/i/2023/11/06/2023-11-06-1699249486.png"/>
</li>
<li><p>卷和实例的连接和分离。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">openstack server <span class="token function">add</span> volume  <span class="token punctuation">[</span>--device <span class="token operator">&lt;</span>设备<span class="token operator">></span><span class="token punctuation">]</span>  <span class="token punctuation">[</span>--tag <span class="token operator">&lt;</span>标记<span class="token operator">></span><span class="token punctuation">]</span>  <span class="token operator">&lt;</span>实例<span class="token operator">></span>  <span class="token operator">&lt;</span>卷<span class="token operator">></span>
openstack server remove volume  <span class="token operator">&lt;</span>实例<span class="token operator">></span>  <span class="token operator">&lt;</span>卷<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack volume list</span>
+--------------------------------------+--------------+-----------+------+-------------+
<span class="token operator">|</span> ID                                   <span class="token operator">|</span> Name         <span class="token operator">|</span> Status    <span class="token operator">|</span> Size <span class="token operator">|</span> Attached to <span class="token operator">|</span>
+--------------------------------------+--------------+-----------+------+-------------+
<span class="token operator">|</span> e8e8b9e5-bb9b-46b1-b4e5-eceb43695853 <span class="token operator">|</span> test_volume2 <span class="token operator">|</span> available <span class="token operator">|</span>   <span class="token number">10</span> <span class="token operator">|</span>             <span class="token operator">|</span>
<span class="token operator">|</span> 063025f5-172e-412f-9664-f111cc916ac0 <span class="token operator">|</span> test_volume  <span class="token operator">|</span> available <span class="token operator">|</span>   <span class="token number">10</span> <span class="token operator">|</span>             <span class="token operator">|</span>
+--------------------------------------+--------------+-----------+------+-------------+
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack server add volume test test_volume</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack volume list</span>
+--------------------------------------+--------------+-----------+------+-------------------------------+
<span class="token operator">|</span> ID                                   <span class="token operator">|</span> Name         <span class="token operator">|</span> Status    <span class="token operator">|</span> Size <span class="token operator">|</span> Attached to                   <span class="token operator">|</span>
+--------------------------------------+--------------+-----------+------+-------------------------------+
<span class="token operator">|</span> e8e8b9e5-bb9b-46b1-b4e5-eceb43695853 <span class="token operator">|</span> test_volume2 <span class="token operator">|</span> available <span class="token operator">|</span>   <span class="token number">10</span> <span class="token operator">|</span>                               <span class="token operator">|</span>
<span class="token operator">|</span> 063025f5-172e-412f-9664-f111cc916ac0 <span class="token operator">|</span> test_volume  <span class="token operator">|</span> in-use    <span class="token operator">|</span>   <span class="token number">10</span> <span class="token operator">|</span> Attached to <span class="token builtin class-name">test</span> on /dev/vdb  <span class="token operator">|</span>
+--------------------------------------+--------------+-----------+------+-------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> 进入实例的控制台查看实例中的块设备信息，包含10G的块设备&#x2F;dev&#x2F;vdb。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/11/08/2023-11-08-1699425791.png" alt="1699425791258.png" title="1699425791258.png" />

<p> 使用Horizon控制台连接和分离卷。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/11/08/2023-11-08-1699427016.png" alt="1699427016306.png" title="1699427016306.png" />

 <img src="https://vault.taojie.fun:28089/i/2023/11/08/2023-11-08-1699427102.png" alt="1699427101926.png" title="1699427101926.png" />
</li>
<li><p>对于卷的容量可以进行扩展但是不能减少，在进行扩展前需要将卷和实例进行分离。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1.对实例和卷进行分离</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack server remove volume test test_volume</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p> 使用命令行进行卷扩展的命令格式：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">openstack volume <span class="token builtin class-name">set</span> <span class="token parameter variable">--size</span> <span class="token operator">&lt;</span>new_size<span class="token operator">></span> <span class="token operator">&lt;</span>volume_id<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1.对卷进行扩容，扩容到11G</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack volume set --size 11 test_volume</span>
<span class="token comment"># 2.查看扩容后的卷容量</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack volume show test_volume -c size -f value</span>
<span class="token number">11</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>-c size: 使用 -c 参数指定要显示的列。指定 size 列，对应卷的大小。<br>-f value: 使用 -f 参数指定输出格式。这里指定 value，以便只输出 size 列的值而不带有其他额外的格式。<br>作业2：查看扩容后的卷信息，截图上传。</p>
</blockquote>
</li>
<li><p>创建、管理卷的快照。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/11/08/2023-11-08-1699451224.png" alt="1699451224278.png" title="1699451224278.png" />

 <img src="https://vault.taojie.fun:28089/i/2023/11/08/2023-11-08-1699451342.png" alt="1699451341524.png" title="1699451341524.png" /></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/10/28/private_clouds/8.OpenStack%E8%99%9A%E6%8B%9F%E7%BD%91%E7%BB%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/28/private_clouds/8.OpenStack%E8%99%9A%E6%8B%9F%E7%BD%91%E7%BB%9C/" class="post-title-link" itemprop="url">OpenStack虚拟网络</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-28 19:18:37" itemprop="dateCreated datePublished" datetime="2023-10-28T19:18:37+08:00">2023-10-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-11-09 11:24:24" itemprop="dateModified" datetime="2023-11-09T11:24:24+08:00">2023-11-09</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="OpenStack虚拟网络结构"><a href="#OpenStack虚拟网络结构" class="headerlink" title="OpenStack虚拟网络结构"></a>OpenStack虚拟网络结构</h2><p>Neutron是一个用Python写的分布式软件项目，用来实现OpenStack中的虚拟网络服务，实现软件定义网络。</p>
<img src="https://vault.taojie.fun:28089/i/2023/10/30/2023-10-30-1698634048.png" alt="1698634048202.png" title="1698634048202.png" />

<p>OpenStack 提供了几种不同类型的网络，以满足不同的网络需求。以下是一些常见的 OpenStack 网络类型：</p>
<p>按照网络的实现原理：</p>
<ol>
<li><p>Flat Network（扁平网络）：这是最简单的网络类型，所有虚拟机实例共享同一个扁平的网络。在这种网络中，虚拟机实例通过虚拟交换机直接连接到物理网络。一般适用于简单的测试环境或不需要网络隔离的场景。</p>
<blockquote>
<p>Linux Bridge直接与物联网卡相连<br>每个Flat独占一个物理网卡</p>
</blockquote>
 <img src="https://vault.taojie.fun:28089/i/2023/10/30/2023-10-30-1698634701.png" alt="1698634700994.png" title="1698634700994.png" />
</li>
<li><p>VLAN Network（VLAN 网络）：VLAN 网络通过使用 VLAN 标签对虚拟机实例进行隔离。在这种网络中，物理网络上的不同 VLAN 标签对应不同的虚拟网络。虚拟机实例通过虚拟交换机连接到特定的 VLAN 网络，实现网络隔离。</p>
<blockquote>
<p>在基于linux bridge的vlan网络中，eht1物理网卡上创建了两个vlan接口，1.1连接到qbr1网桥，1.2连接到了qbr2网桥。在这种情况下vm通过eth1.1或者eth1.2发送到eth1的包会被打上各自的vlan id。此时vm2和vm3属于同一个network所以是互通的，vm与vm2和vm3不通。<br> <img src="https://vault.taojie.fun:28089/i/2023/10/30/2023-10-30-1698634722.png" alt="1698634722145.png" title="1698634722145.png" /></p>
</blockquote>
</li>
<li><p>VXLAN Network（VXLAN 网络）：VXLAN 网络使用 VXLAN 封装技术在底层物理网络上创建逻辑隧道，以实现虚拟机实例之间的隔离和通信。VXLAN 网络可以扩展到更大的规模，并提供更多的虚拟网络隔离。</p>
</li>
<li><p>GRE Network（GRE 网络）：GRE 网络使用通用路由封装（Generic Routing Encapsulation）协议在底层物理网络上创建隧道，以实现虚拟机实例之间的隔离和通信。GRE 网络可以在不同物理网络之间建立逻辑连接。</p>
</li>
</ol>
<p>按照网络的从属关系可以分为以下两类：</p>
<ol>
<li><p>Provider Network（提供者网络）：提供者网络是指与外部网络或互联网连接的网络。它可以是物理网络中的一个 VLAN 或直接连接到外部网络。提供者网络通常用于连接虚拟机实例到互联网或外部资源。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/10/30/2023-10-30-1698642331.png" alt="1698642331350.png" title="1698642331350.png" />

 <img src="https://vault.taojie.fun:28089/i/2023/10/30/2023-10-30-1698642247.png" alt="1698642246577.png" title="1698642246577.png" />
</li>
<li><p>Self-Service Network（自服务网络）：自服务网络是为虚拟机实例创建的私有网络。它可以通过路由器与提供者网络连接，使虚拟机实例能够访问外部网络。自服务网络通常用于为用户提供独立的、可管理的网络环境。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/10/30/2023-10-30-1698642266.png" alt="1698642265910.png" title="1698642265910.png" />

 <img src="https://vault.taojie.fun:28089/i/2023/10/30/2023-10-30-1698642316.png" alt="1698642315973.png" title="1698642315973.png" /></li>
</ol>
<h2 id="Neutron服务部署"><a href="#Neutron服务部署" class="headerlink" title="Neutron服务部署"></a>Neutron服务部署</h2><h3 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h3><ol>
<li><p>开启网卡的混杂模式。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># ifconfig ens34 promisc</span>
<span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># ifconfig ens34 promisc</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ol>
<h4 id="控制节点服务配置"><a href="#控制节点服务配置" class="headerlink" title="控制节点服务配置"></a>控制节点服务配置</h4><ol>
<li><p>安装网络组件。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># yum -y install openstack-neutron openstack-neutron-ml2  openstack-neutron-linuxbridge ebtables</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>创建数据库。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> CREATE DATABASE neutron<span class="token punctuation">;</span>
MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> GRANT ALL PRIVILEGES ON neutron.* TO <span class="token string">'neutron'</span>@<span class="token string">'localhost'</span> IDENTIFIED BY <span class="token string">'000000'</span><span class="token punctuation">;</span>
MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> GRANT ALL PRIVILEGES ON neutron.* TO <span class="token string">'neutron'</span>@<span class="token string">'%'</span> IDENTIFIED BY <span class="token string">'000000'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>加载admin用户的环境脚本完成身份认证。</p>
</li>
<li><p>创建Neutron服务的用户、分配角色、创建服务。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack user create --domain default --password 000000 neutron</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack role add --project project --user neutron admin</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack service create --name neutron network</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack endpoint create --region RegionOne  network public http://controller:9696</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack endpoint create --region RegionOne  network internal http://controller:9696</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack endpoint create --region RegionOne  network admin http://controller:9696</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>控制节点备份修改以下配置文件：</p>
<ul>
<li><p><code>/etc/neutron/neutron.conf</code>（neutron组件基础配置文件）：指定二层和三层的网络插件、配置消息队列和数据库、keystone认证信息。</p>
</li>
<li><p><code>/etc/neutron/plugins/ml2/ml2_config.ini</code>（二层插件配置文件）：配置类型驱动的类型、自服务网络的类型、机制驱动类型等。</p>
</li>
<li><p><code>/etc/neutron/plugins/ml2/linuxbridge_agent.ini</code>（机制驱动配置文件）：物理网络的映射、vxlan网络配置、启用安全组</p>
</li>
<li><p><code>/etc/neutron/dhcp-agent.ini</code>（dhcp配置文件）：指定接口驱动、DHCP驱动。</p>
</li>
<li><p><code>/etc/neutron/metadata_agent.ini</code>（元数据代理配置文件）。</p>
</li>
<li><p><code>/etc/nova/nova.conf</code>（nova服务配置文件）：设置neutron和nova的交互。</p>
</li>
</ul>
</li>
<li><p>初始化数据库。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># su -s /bin/sh -c "neutron-db-manage --config-file /etc/neutron/neutron.conf --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>重启控制节点nova，启动控制节点的Neutron服务。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart openstack-nova-api</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable neutron-server neutron-linuxbridge-agent neutron-dhcp-agent neutron-metadata-agent neutron-l3-agent</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># systemctl start neutron-server neutron-linuxbridge-agent neutron-dhcp-agent neutron-metadata-agent neutron-l3-agent</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>查看控制节点服务运行状态。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># systemctl status neutron-server</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
<h3 id="计算节点服务配置"><a href="#计算节点服务配置" class="headerlink" title="计算节点服务配置"></a>计算节点服务配置</h3><ol>
<li><p>安装所需软件包。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># yum -y install openstack-neutron-linuxbridge ebtables ipset</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>备份修改以下配置文件<code>/etc/neutron/neutron.conf</code>、<code>/etc/neutron/plugins/ml2/linuxbridge_agent.ini</code>。</p>
</li>
<li><p>检测Neutron状态。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># neutron-status upgrade check</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
<h2 id="Neutron网络应用"><a href="#Neutron网络应用" class="headerlink" title="Neutron网络应用"></a>Neutron网络应用</h2><h3 id="作业与实验环境"><a href="#作业与实验环境" class="headerlink" title="作业与实验环境"></a>作业与实验环境</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://wxstc.fanya.chaoxing.com/portal">超星网址</a><br><code>快照管理</code>：控制节点和计算节点选择均是默认的<code>项目12</code></p>
</blockquote>
<h3 id="基础环境准备"><a href="#基础环境准备" class="headerlink" title="基础环境准备"></a>基础环境准备</h3><ol>
<li><p>加载admin用户的环境脚本完成身份认证。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># source admin-login</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>实例类型创建。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack flavor create --public test_flavor --id auto --ram 256 --disk 5 --vcpus 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>桥接网络防火墙配置。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># echo 'net.bridge.bridge-nf-call-iptables=1' >> /etc/sysctl.conf</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># echo 'net.bridge.bridge-nf-call-ip6tables=1' >> /etc/sysctl.conf</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># modprobe br_netfilter</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># sysctl -p</span>
net.bridge.bridge-nf-call-iptables <span class="token operator">=</span> <span class="token number">1</span>
net.bridge.bridge-nf-call-ip6tables <span class="token operator">=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="自服务网络使用"><a href="#自服务网络使用" class="headerlink" title="自服务网络使用"></a>自服务网络使用</h3><ol>
<li><p>现有的环境不支持自服务网络，需要修改Neutron配置。</p>
<ol>
<li><p>修改控制节点<code>/etc/neutron/plugins/ml2/ml2_conf.ini</code></p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>DEFAULT<span class="token punctuation">]</span>
<span class="token punctuation">[</span>ml2<span class="token punctuation">]</span>
type_drivers <span class="token operator">=</span> flat,vlan,vxlan                      <span class="token comment"># 1.添加vlan,vxlan类型支持</span>
tenant_network_types <span class="token operator">=</span> vxlan                        <span class="token comment"># 2.添加自服务驱动的vxlan类型支持</span>
mechanism_drivers <span class="token operator">=</span> linuxbridge,l2population        <span class="token comment"># 3.启用l2population,简化网络通信拓扑，减少网络广播</span>
extension_drivers <span class="token operator">=</span> port_security

<span class="token punctuation">[</span>ml2_type_flat<span class="token punctuation">]</span>
flat_networks <span class="token operator">=</span> provider

<span class="token punctuation">[</span>ml2_type_vxlan<span class="token punctuation">]</span>                                    <span class="token comment"># 4.为私有网络配置VXLAN网络识别的网络范围</span>
vni_ranges <span class="token operator">=</span> <span class="token number">1</span>:1000

<span class="token punctuation">[</span>securitygroup<span class="token punctuation">]</span>
enable_ipset <span class="token operator">=</span> <span class="token boolean">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>修改控制节点<code>/etc/neutron/plugins/ml2/linuxbridge_agent.ini</code>。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>DEFAULT<span class="token punctuation">]</span>
<span class="token punctuation">[</span>linux_bridge<span class="token punctuation">]</span>
physical_interface_mappings <span class="token operator">=</span> provider:ens34

<span class="token punctuation">[</span>vxlan<span class="token punctuation">]</span>
enable_vxlan <span class="token operator">=</span> <span class="token boolean">true</span>                             <span class="token comment"># 1.使能vxlan</span>
local_ip <span class="token operator">=</span> <span class="token number">192.168</span>.10.10                        <span class="token comment"># 2.控制节点IP</span>
l2_population <span class="token operator">=</span> <span class="token boolean">true</span>                            <span class="token comment"># 3.使能l2_population</span>

<span class="token punctuation">[</span>securitygroup<span class="token punctuation">]</span>
enable_security_group <span class="token operator">=</span> <span class="token boolean">true</span>
firewall_driver <span class="token operator">=</span> neutron.agent.linux.iptables_firewall.IptablesFirewallDriver<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>重启控制节点服务。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart neutron-server.service neutron-linuxbridge-agent.service</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>修改计算节点<code>/etc/neutron/plugins/ml2/linuxbridge_agent.ini</code>。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>DEFAULT<span class="token punctuation">]</span>
<span class="token punctuation">[</span>linux_bridge<span class="token punctuation">]</span>
physical_interface_mappings <span class="token operator">=</span> provider:ens34

<span class="token punctuation">[</span>vxlan<span class="token punctuation">]</span>
enable_vxlan <span class="token operator">=</span> <span class="token boolean">true</span>                             <span class="token comment"># 1.使能vxlan</span>
local_ip <span class="token operator">=</span> <span class="token number">192.168</span>.10.20                        <span class="token comment"># 2.计算节点IP</span>
l2_population <span class="token operator">=</span> <span class="token boolean">true</span>                            <span class="token comment"># 3.使能l2_population</span>

<span class="token punctuation">[</span>securitygroup<span class="token punctuation">]</span>
enable_security_group <span class="token operator">=</span> <span class="token boolean">true</span>
firewall_driver <span class="token operator">=</span> neutron.agent.linux.iptables_firewall.IptablesFirewallDriver<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>重启计算节点服务。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart libvirtd openstack-nova-compute neutron-linuxbridge-agent</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
</li>
<li><p>登录<code>192.168.10.20</code>Horizon图形控制台，左侧<code>项目</code>-&gt;<code>网络</code>-&gt;<code>网络</code>创建自服务网络。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/11/06/2023-11-06-1699240176.png" alt="1699240174151.png" title="1699240174151.png" />

<p> 子网配置：</p>
 <img src="https://vault.taojie.fun:28089/i/2023/11/06/2023-11-06-1699240233.png" alt="1699240230610.png" title="1699240230610.png" />

<p> DNS服务器设置：</p>
 <img src="https://vault.taojie.fun:28089/i/2023/11/06/2023-11-06-1699245064.png" alt="1699245061523.png" title="1699245061523.png" />
</li>
<li><p>创建实例<code>instance1</code>，网络默认选择的是上文创建的自服务网络。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/11/06/2023-11-06-1699248275.png" alt="1699248275574.png" title="1699248275574.png" />
</li>
<li><p>使用相同的配置创建实例<code>instance2</code>，在实力列表中获取<code>instance2</code>IP地址，通过<code>instance1</code>ping包验证和<code>instance2</code>之间的网络连通。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/11/06/2023-11-06-1699248943.png" alt="1699248942408.png" title="1699248942408.png" />

<blockquote>
<p>作业1：上传两个实例之间的ping包的结果。</p>
</blockquote>
</li>
</ol>
<h2 id="提供者网络使用"><a href="#提供者网络使用" class="headerlink" title="提供者网络使用"></a>提供者网络使用</h2><ol>
<li><p>提供者网络涉及到物理网络，需要在管理员页面下才能创建，通过<code>管理员</code>-&gt;<code>网络</code>-&gt;<code>网络</code>创建提供者网络，配置如下。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/11/06/2023-11-06-1699249390.png" alt="1699249390076.png" title="1699249390076.png" />

<p> 子网配置：</p>
 <img src="https://vault.taojie.fun:28089/i/2023/11/06/2023-11-06-1699249465.png" alt="1699249465596.png" title="1699249465596.png" />

<p> DHCP、DNS配置：</p>
 <img src="https://vault.taojie.fun:28089/i/2023/11/06/2023-11-06-1699249486.png" alt="1699249486282.png" title="1699249486282.png" />
</li>
<li><p>创建实例并使用提供者网络。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/11/06/2023-11-06-1699249617.png" alt="1699249617251.png" title="1699249617251.png" />

<p> 查看当前环境的网络拓扑：</p>
 <img src="https://vault.taojie.fun:28089/i/2023/11/06/2023-11-06-1699250048.png" alt="1699250048445.png" title="1699250048445.png" />

<p> 进入实例<code>instance3</code>通过ping包验证实例之间的网络。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/11/06/2023-11-06-1699250223.png" alt="1699250223158.png" title="1699250223158.png" />

<blockquote>
<p>作业2：上传<code>instance3</code>ping包的结果。</p>
</blockquote>
</li>
</ol>
<h2 id="自服务网络使用虚拟路由连通外部网络"><a href="#自服务网络使用虚拟路由连通外部网络" class="headerlink" title="自服务网络使用虚拟路由连通外部网络"></a>自服务网络使用虚拟路由连通外部网络</h2><p>这个实验是通过创建虚拟路由连通自服务网络和提供者网络从而是自服务网络的主机能够连通外部网络。</p>
<ol>
<li><p>当前环境的路由功能是关闭的，需要重新配置<code>/etc/neutron/neutron.conf</code>启用路由功能。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>DEFAULT<span class="token punctuation">]</span>
core_plugin <span class="token operator">=</span> ml2
service_plugins <span class="token operator">=</span> router            <span class="token comment"># 1.启用三层路由插件</span>
transport_url <span class="token operator">=</span> rabbit://rabbitmq:000000@controller
auth_strategy <span class="token operator">=</span> keystone
notify_nova_on_port_status_changes <span class="token operator">=</span> <span class="token boolean">true</span>
notify_nova_on_port_data_changes <span class="token operator">=</span> <span class="token boolean">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>配置三层路由的接口驱动。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># echo "interface_driver = linuxbridge" >> /etc/neutron/l3_agent.ini</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>重启控制节点的Neutron组件，启动路由服务。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart neutron-server</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable neutron-l3-agent</span>
Created symlink from /etc/systemd/system/multi-user.target.wants/neutron-l3-agent.service to /usr/lib/systemd/system/neutron-l3-agent.service.
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># systemctl start neutron-l3-agent</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>配置计算节点<code>/etc/openstack-dashboard/local_settings</code>使得Horizon显示路由菜单。</p>
<p> 修改144行，将<code>&#39;enable_router&#39;: False,</code>改为<code>&#39;enable_router&#39;: True,</code></p>
</li>
<li><p>重启计算节点的Horizon组件后，刷新图形控制台。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart httpd</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>网络菜单中显示<code>路由</code>菜单。</p>
</li>
<li><p>新建路由，外部网络设置为上文创建的提供者网络。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/11/06/2023-11-06-1699251602.png" alt="1699251602303.png" title="1699251602303.png" />

<p> 当前的网络拓扑：</p>
 <img src="https://vault.taojie.fun:28089/i/2023/11/06/2023-11-06-1699251657.png" alt="1699251657914.png" title="1699251657914.png" />
</li>
<li><p>点击新建好的路由名称-&gt;接口，增加接口。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/11/06/2023-11-06-1699251700.png" alt="1699251700833.png" title="1699251700833.png" />
</li>
<li><p>增加接口时子网选择上文创建的自服务网络名称。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/11/06/2023-11-06-1699251814.png" alt="1699251814744.png" title="1699251814744.png" />
</li>
<li><p>查看当前的网络拓扑。</p>
<img src="https://vault.taojie.fun:28089/i/2023/11/06/2023-11-06-1699251876.png" alt="1699251876971.png" title="1699251876971.png" />
</li>
<li><p>在实例<code>instance1</code>中使用ping包验证外网的连通性。</p>
<img src="https://vault.taojie.fun:28089/i/2023/11/06/2023-11-06-1699252068.png" alt="1699252068962.png" title="1699252068962.png" />

<blockquote>
<p>作业3：上传实例<code>instance1</code>的ping包结果。</p>
</blockquote>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/10/20/private_clouds/7.OpenStack%E5%AE%9E%E4%BE%8B%E7%AE%A1%E7%90%86%EF%BC%88%E4%BA%8C%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/20/private_clouds/7.OpenStack%E5%AE%9E%E4%BE%8B%E7%AE%A1%E7%90%86%EF%BC%88%E4%BA%8C%EF%BC%89/" class="post-title-link" itemprop="url">OpenStack实例管理（二）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-20 20:46:04" itemprop="dateCreated datePublished" datetime="2023-10-20T20:46:04+08:00">2023-10-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-11-08 12:43:33" itemprop="dateModified" datetime="2023-11-08T12:43:33+08:00">2023-11-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="理解元数据"><a href="#理解元数据" class="headerlink" title="理解元数据"></a>理解元数据</h2><h3 id="元数据概念-Metadata"><a href="#元数据概念-Metadata" class="headerlink" title="元数据概念(Metadata)"></a>元数据概念(Metadata)</h3><p>在之前的课程中介绍了多种定制OpenStack镜像的方法，镜像是实例的模板，这些对镜像的定制都会体现在启动的实例中。针对镜像的定制主要是根据具体的场景对操作系统进行优化，实现资源的合理利用，除此之外还会完成一些特定需求的定制比如一些开发环境、用户界面、日志系统等。在实际应用中还有很多配置不适合配置在镜像中，比如ssh密钥、主机名、用户名、磁盘大小，这些配置更多是在实例启动的时候由用户以<code>元数据</code>的形式传递给实例，通常这个功能是由<code>Cloud-Init</code>实现（Windows中是<code>Cloudbase-Init</code>）。</p>
<p>OpenStack中的元数据根据数据类型可以分为两类：</p>
<ol>
<li><p>由系统所提供的结构化数据，以键值对的形式提供。</p>
</li>
<li><p>由用户所提供的非结构化数据，大多以命令、脚本、配置文件的形式提供。</p>
</li>
</ol>
<h3 id="元数据注入方式"><a href="#元数据注入方式" class="headerlink" title="元数据注入方式"></a>元数据注入方式</h3><p>元数据注入实例的方式分为两种：</p>
<ol>
<li><p>元数据服务</p>
<p>元数据服务为实例提供了一种可以通过REST API获实例特定的数据的方式，无论是用户提供的非结构化的数据还是系统提供的结构化数据都可以通过这种方式来访问（元数据服务要求实例先通过DHCP获取IP地址）。</p>
</li>
<li><p>配置驱动器</p>
<p> 配置驱动器是一种不需要通过DHCP向实例分配IP地址就能够向实例传递数据的一种方式，它是一种会随实例启动的特殊的驱动器。实例能够挂载该驱动器并从中读取出那些也可以通过元数据服务读取出的相同的消息。</p>
</li>
</ol>
<h2 id="元数据验证"><a href="#元数据验证" class="headerlink" title="元数据验证"></a>元数据验证</h2><h3 id="作业与实验环境"><a href="#作业与实验环境" class="headerlink" title="作业与实验环境"></a>作业与实验环境</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://wxstc.fanya.chaoxing.com/portal">超星网址</a><br><code>快照管理</code>：控制节点和计算节点选择均是默认的<code>项目12</code></p>
</blockquote>
<h3 id="创建虚拟机实例并注入元数据"><a href="#创建虚拟机实例并注入元数据" class="headerlink" title="创建虚拟机实例并注入元数据"></a>创建虚拟机实例并注入元数据</h3><ol>
<li><p>先利用上节课介绍的OpenStack管理命令创建虚拟机实例所需的虚拟网络、实例类型。</p>
<ol>
<li><p>虚拟网络、子网创建</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack network create --share --external --provider-network-type flat --provider-physical-network provider --project admin test_net</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack subnet create --network test_net --subnet-range 192.168.20.0/24 --gateway 192.168.20.2 --allocation-pool start=192.168.20.128,end=192.168.20.140 --dns-nameserver 114.114.114.114 test_subnet</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>实例类型创建</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack flavor create --public test_flavor --id auto --ram 2048 --disk 15 --vcpus 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>创建密钥并复制</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack keypair create test-key</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
</li>
<li><p>登录Horizon图形界面，使用创建镜像功能将本地D盘的<code>CentOS-7-x86_64-GenericCloud-2003.qcow2</code>镜像上传到OpenStack平台。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/10/23/2023-10-23-1698020758.png" alt="1698020757698.png" title="1698020757698.png" />
</li>
<li><p>创建实例、注入用户数据元数据，注意勾选<code>配置驱动</code>。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token function">passwd</span> centos<span class="token operator">&lt;&lt;</span><span class="token string">EOF
000000
000000
EOF</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

 <img src="https://vault.taojie.fun:28089/i/2023/11/02/2023-11-02-1698900341.png" alt="1698900341448.png" title="1698900341448.png" />

<p> 第二种方法因为镜像的原因无法实现，供参考：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#cloud-config</span>
chpasswd <span class="token builtin class-name">:</span>
list: <span class="token operator">|</span>
    centos: 000000
expire: <span class="token boolean">false</span>
ssh_pwauth: <span class="token boolean">true</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>上述用户数据元数据的导入同样可以通过命令实现，在创建实例的<code>openstack server create</code>命令中添加<code>--user-data</code>选项以及需要传入的YAML格式的Cloud-Init配置文件。</p>
</blockquote>
</li>
<li><p>实例启动后在计算节点配置密钥并登录到实例中。</p>
<ul>
<li>在<code>控制节点</code>使用实例管理命令获取实例的ip地址</li>
</ul>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack server show test</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>将之前的私钥复制并粘贴到<code>计算节点</code>的<code>/root/.ssh/demo-key.pem</code>，使用ssh命令免密登录</li>
</ul>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># touch ~/.ssh/demo-key.pem</span>
<span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># chmod 600 ~/.ssh/demo-key.pem</span>
<span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># ssh -i ~/.ssh/demo-key.pem centos@192.168.20.130</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>作业1：登陆后截图上传。</p>
</blockquote>
</li>
</ol>
<h3 id="设置虚拟机元数据"><a href="#设置虚拟机元数据" class="headerlink" title="设置虚拟机元数据"></a>设置虚拟机元数据</h3><p>不同于提供给Cloud-Init的用于初始化时注入的元数据，对于结构化的元数据可以实例创建之后在元数据选项卡中修改。</p>
<img src="https://vault.taojie.fun:28089/i/2023/10/23/2023-10-23-1698027310.png" alt="1698027308960.png" title="1698027308960.png" />

<h3 id="验证元数据服务"><a href="#验证元数据服务" class="headerlink" title="验证元数据服务"></a>验证元数据服务</h3><p>元数据服务为实例提供了一种通过<code>REST API</code>获取实例的特定数据的方法。实例通过 <code>169.254.169.254</code> 访问此服务，并且可以通过此服务访问所有类型的元数据，无论是用户、nova 还是供应商提供的元数据。</p>
<ol>
<li><p>通过发起一个GET请求到 <code>http://169.254.169.254/openstack</code> 来获取元数据API所支持的版本列表。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@test ~<span class="token punctuation">]</span>$ <span class="token function">curl</span> http://169.254.169.254/openstack
<span class="token number">2012</span>-08-10
<span class="token number">2013</span>-04-04
<span class="token number">2013</span>-10-17
<span class="token number">2015</span>-10-15
<span class="token number">2016</span>-06-30
<span class="token number">2016</span>-10-06
<span class="token number">2017</span>-02-22
<span class="token number">2018</span>-08-27
latest<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>如果请求执行失败可以在控制节点尝试执行<code>systemctl status neutron-metadata-agent.service</code>重启元数据服务后重试。</p>
</blockquote>
</li>
<li><p>在请求的地址中加上版本名可以获取指定版本的元数据目录。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@test ~<span class="token punctuation">]</span>$ <span class="token function">curl</span> http://169.254.169.254/openstack/latest
meta_data.json
user_data
password
vendor_data.json
network_data.json
vendor_data2.json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>继续在请求的地址中加上需要查看的元数据文件名并且通过python工具格式化输出。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@test ~<span class="token punctuation">]</span>$ <span class="token function">curl</span> http://169.254.169.254/openstack/latest/meta_data.json <span class="token operator">|</span>python <span class="token parameter variable">-m</span> json.tool<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> 通过<code>openstack server create</code>命令的<code>--property</code>选项卡所提供的元数据存储在meta键中。</p>
</li>
<li><p>查看用户数据元数据。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@test ~<span class="token punctuation">]</span>$ <span class="token function">curl</span> http://169.254.169.254/openstack/latest/user_data
<span class="token comment">#!/bin/bash</span>
<span class="token function">passwd</span> centos<span class="token operator">&lt;&lt;</span><span class="token string">EOF
000000
000000
EOF</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="验证配置驱动器"><a href="#验证配置驱动器" class="headerlink" title="验证配置驱动器"></a>验证配置驱动器</h3><p>配置驱动器是元数据服务的一种补充，任何可以挂载 ISO 9660 或者 VFALT 文件的系统都可以使用配置驱动器。</p>
<ol>
<li><p>使用root用户。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>centos@test ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">su</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>挂载配置驱动器到某个目录。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1.创建挂载点</span>
<span class="token punctuation">[</span>root@test ~<span class="token punctuation">]</span><span class="token comment"># mkdir -p /mnt/config</span>
<span class="token comment"># 2.挂载虚拟设备到挂载点上</span>
<span class="token punctuation">[</span>root@test ~<span class="token punctuation">]</span><span class="token comment"># mount /dev/disk/by-label/config-2 /mnt/config</span>
mount: /dev/sr0 is write-protected, mounting read-only<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>使用 <code>df -h</code> 命令查看当前系统的挂载情况。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@test ~<span class="token punctuation">]</span><span class="token comment"># df -h</span>
Filesystem      Size  Used Avail Use% Mounted on
devtmpfs        896M     <span class="token number">0</span>  896M   <span class="token number">0</span>% /dev
tmpfs           920M     <span class="token number">0</span>  920M   <span class="token number">0</span>% /dev/shm
tmpfs           920M   25M  895M   <span class="token number">3</span>% /run
tmpfs           920M     <span class="token number">0</span>  920M   <span class="token number">0</span>% /sys/fs/cgroup
/dev/vda1        15G  847M   15G   <span class="token number">6</span>% /
tmpfs           184M     <span class="token number">0</span>  184M   <span class="token number">0</span>% /run/user/1000
tmpfs           184M     <span class="token number">0</span>  184M   <span class="token number">0</span>% /run/user/0
/dev/sr0        492K  492K     <span class="token number">0</span> <span class="token number">100</span>% /mnt/config <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>查看驱动器目录中的内容，和通过元数据服务功能获取的元数据对比。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@test ~<span class="token punctuation">]</span><span class="token comment"># ls /mnt/config/openstack/latest</span>
meta_data.json     user_data          vendor_data.json
network_data.json  vendor_data2.json
<span class="token punctuation">[</span>root@test ~<span class="token punctuation">]</span><span class="token comment"># cat /mnt/config/openstack/latest/user_data</span>
<span class="token comment">#!/bin/bash</span>
<span class="token function">passwd</span> centos<span class="token operator">&lt;&lt;</span>EOF
000000
000000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>作业2：通过配置驱动查询到用户数据元数据后截图上传。</p>
</blockquote>
</li>
</ol>
<h2 id="增加计算节点"><a href="#增加计算节点" class="headerlink" title="增加计算节点"></a>增加计算节点</h2><blockquote>
<p>先关闭控制节点和计算节点</p>
</blockquote>
<ol>
<li><p><code>计算节点</code>右键-&gt; 管理 -&gt; 克隆，克隆一个计算节点。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/10/23/2023-10-23-1698028249.png" alt="1698028248479.png" title="1698028248479.png" />

 <img src="https://vault.taojie.fun:28089/i/2023/10/23/2023-10-23-1698028260.png" alt="1698028258928.png" title="1698028258928.png" />
</li>
<li><p>打开新的计算节点后登录，这一步修改新添加的计算节点的网络配置，主机名。</p>
<ol>
<li><p>修改主机名</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># hostnamectl set-hostname compute2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p><code>Ctrl + D</code>退出登录会话查看主机名</p>
</li>
<li><p>修改网卡<code>ens33</code>和<code>ens34</code>的网络配置，将IP地址改为<code>192.168.10.21</code>和<code>192.168.20.21</code></p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute2 ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/sysconfig/network-scripts/ifcfg-ens33</span>
<span class="token punctuation">[</span>root@compute2 ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/sysconfig/network-scripts/ifcfg-ens34</span>
<span class="token punctuation">[</span>root@compute2 ~<span class="token punctuation">]</span><span class="token comment"># ifdown ifcfg-ens33</span>
<span class="token punctuation">[</span>root@compute2 ~<span class="token punctuation">]</span><span class="token comment"># ifdown ifcfg-ens34</span>
<span class="token punctuation">[</span>root@compute2 ~<span class="token punctuation">]</span><span class="token comment"># ifup ifcfg-ens33</span>
<span class="token punctuation">[</span>root@compute2 ~<span class="token punctuation">]</span><span class="token comment"># ifup ifcfg-ens34</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>编辑<code>/etc/hosts</code>文件插入新的主机名映射</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
<span class="token number">192.168</span>.10.10   controller
<span class="token number">192.168</span>.10.20   compute
<span class="token number">192.168</span>.10.21   compute2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
</li>
<li><p><code>vi /etc/nova/nova.conf</code>修改<code>计算节点</code>的nova配置。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/10/23/2023-10-23-1698030590.png" alt="1698030589528.png" title="1698030589528.png" />
</li>
<li><p>重启两个计算节点的<code>计算服务</code>。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart libvirtd openstack-nova-compute</span>
<span class="token punctuation">[</span>root@compute2 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart libvirtd openstack-nova-compute</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>打开原有的<code>控制节点</code>和<code>计算节点</code>后在控制节点执行<code>su nova -s /bin/sh -c &quot;nova-manage cell_v2 discover_hosts --verbose&quot;</code>发现新的计算节点。</p>
</li>
<li><p>查看当前系统的计算节点信息。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack hypervisor list</span>
+----+---------------------+-----------------+---------------+-------+
<span class="token operator">|</span> ID <span class="token operator">|</span> Hypervisor Hostname <span class="token operator">|</span> Hypervisor Type <span class="token operator">|</span> Host IP       <span class="token operator">|</span> State <span class="token operator">|</span>
+----+---------------------+-----------------+---------------+-------+
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> compute             <span class="token operator">|</span> QEMU            <span class="token operator">|</span> <span class="token number">192.168</span>.10.20 <span class="token operator">|</span> up    <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> compute2           <span class="token operator">|</span> QEMU            <span class="token operator">|</span> <span class="token number">192.168</span>.10.21 <span class="token operator">|</span> up    <span class="token operator">|</span>
+----+---------------------+-----------------+---------------+-------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>作业3：列出计算节点信息后截图上传。</p>
</blockquote>
</li>
</ol>
<h2 id="实例迁移"><a href="#实例迁移" class="headerlink" title="实例迁移"></a>实例迁移</h2><ol>
<li><p>这一步设置两个计算节点之间的ssh免密访问，先在<code>compute</code>上配置。</p>
<ol>
<li><p>设置<code>nova</code>的登录功能。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/passwd</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> 找到nova用户，参考修改：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 修改：</span>
nova:x:162:162:OpenStack Nova Daemons:/var/lib/nova:/sbin/nologin
<span class="token comment"># 改为：</span>
nova:x:162:162:OpenStack Nova Daemons:/var/lib/nova:/bin/bash<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>将前一步所修改的配置发送到<code>compute2</code>。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># scp /etc/passwd root@compute2:/etc/passwd</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>设置nova密码，这一步在两个计算节点分别上设置。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># passwd nova</span>
<span class="token punctuation">[</span>root@compute2 ~<span class="token punctuation">]</span><span class="token comment"># passwd nova</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>在<code>compute</code>节点使用<code>su - nova</code>命令切换nova用户，生成密钥对。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">bash-4.2$ ssh-keygen <span class="token parameter variable">-t</span> rsa <span class="token parameter variable">-P</span> <span class="token string">''</span>
Generating public/private rsa key pair.
Enter <span class="token function">file</span> <span class="token keyword">in</span> <span class="token function">which</span> to save the key <span class="token punctuation">(</span>/var/lib/nova/.ssh/id_rsa<span class="token punctuation">)</span>: 回车<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>在<code>comptue2</code>节点重复第四步生成密钥对。</p>
</li>
<li><p>在<code>compute</code>节点执行<code>echo &#39;StrictHostKeyChecking no&#39; &gt;&gt; /var/lib/nova/.ssh/config</code>关闭严格主机密钥检查。</p>
</li>
<li><p>将前一步所修改的配置发送到<code>compute2</code>。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># scp /var/lib/nova/.ssh/config root@compute2:/var/lib/nova/.ssh/config</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>使用以下命令查看生成的公钥文件，把两台计算节点的公钥复制粘贴到对方的<code>/var/lib/nova/.ssh/authorized_keys</code>文件中。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">bash-4.2$ <span class="token function">cat</span> /var/lib/nova/.ssh/id_rsa.pub<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>在compute节点上验证ssh免密登录compute2。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">-bash-4.2$ <span class="token builtin class-name">echo</span> <span class="token environment constant">$HOSTNAME</span>
compute
-bash-4.2$ <span class="token function">ssh</span> nova@compute2
Last login: Wed Nov  <span class="token number">1</span> 01:22:32 <span class="token number">2023</span> from compute
SIOCSIFFLAGS: Operation not permitted
-bash-4.2$ <span class="token builtin class-name">echo</span> <span class="token environment constant">$HOSTNAME</span>
compute2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>在两台计算节点上<code>Ctrl + D</code>回到root用户，重启以下服务。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart libvirtd openstack-nova-compute</span>
<span class="token punctuation">[</span>root@compute2 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart libvirtd openstack-nova-compute neutron-linuxbridge-agent</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ol>
</li>
<li><p>虚拟机实例冷迁移。</p>
<ol>
<li><p>先查看实例当前的物理机：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack server show test</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>执行命令迁移后查看实例：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack server migrate test --wait</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack server show test</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ol>
<blockquote>
<p>作业4：显示实例迁移到新的物理机后截图上传。</p>
</blockquote>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/10/14/private_clouds/6.OpenStack%E5%AE%9E%E4%BE%8B%E7%AE%A1%E7%90%86%EF%BC%88%E4%B8%80%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/14/private_clouds/6.OpenStack%E5%AE%9E%E4%BE%8B%E7%AE%A1%E7%90%86%EF%BC%88%E4%B8%80%EF%BC%89/" class="post-title-link" itemprop="url">OpenStack实例管理（一）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-14 19:18:37" itemprop="dateCreated datePublished" datetime="2023-10-14T19:18:37+08:00">2023-10-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-11-07 10:51:16" itemprop="dateModified" datetime="2023-11-07T10:51:16+08:00">2023-11-07</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="理解Nova计算服务"><a href="#理解Nova计算服务" class="headerlink" title="理解Nova计算服务"></a>理解Nova计算服务</h2><h3 id="Nova计算服务简介"><a href="#Nova计算服务简介" class="headerlink" title="Nova计算服务简介"></a>Nova计算服务简介</h3><p>Nova 管理虚拟机实例的整个生命周期，包括创建、启动、停止、暂停、恢复和销毁等操作。它提供了丰富的API接口和命令行工具，方便用户进行实例管理和监控。</p>
<p>Nova 根据用户的请求和资源的可用性，通过Nova Scheduler进行资源调度和分配。它会选择合适的物理主机来部署虚拟机实例，以实现资源的优化利用和负载均衡。</p>
<p>Nova需要下列OpenStack服务的支持：</p>
<ul>
<li><p>Keystone：为所有的OpenStack服务提供身份管理和认证。</p>
</li>
<li><p>Glance：提供计算用的镜像库。</p>
</li>
<li><p>Neutron：负责配置管理计算实例启动时的虚拟或物理网络连接。</p>
</li>
<li><p>Placement：负责跟踪云中可用的资源库存。</p>
</li>
</ul>
<h3 id="Nova计算服务架构"><a href="#Nova计算服务架构" class="headerlink" title="Nova计算服务架构"></a>Nova计算服务架构</h3><img src="https://vault.taojie.fun:28089/i/2023/10/15/2023-10-15-1697380021.png" alt="1697380021376.png" title="1697380021376.png" />

<ul>
<li><p>DB：用于数据存储的SQL数据库。</p>
</li>
<li><p>API：接收 HTTP 请求、转换命令并通过 oslo.messaging 队列或 HTTP 与其他组件通信的组件。</p>
</li>
<li><p>Scheduler：决定哪个主机获取每个实例。</p>
</li>
<li><p>Compute：管理虚拟机和虚拟机的通信。</p>
</li>
<li><p>Conductor：处理需要协调（构建&#x2F;调整大小）的请求，充当数据库代理，或处理对象转换。</p>
</li>
</ul>
<h3 id="实例创建流程"><a href="#实例创建流程" class="headerlink" title="实例创建流程"></a>实例创建流程</h3><ol>
<li><p>用户发起创建请求：用户通过 Nova API 或控制台发起创建实例的请求，提供所需的实例配置信息，如镜像、规格（flavor）、网络等。</p>
</li>
<li><p>Nova Scheduler 进行资源调度：Nova Scheduler 根据实例的需求和当前资源的可用性，在可用的计算节点中选择最合适的物理主机来部署实例。它考虑诸如资源利用率、负载均衡和亲和性等因素进行决策。</p>
</li>
<li><p>Nova Compute 创建实例：一旦 Nova Scheduler 选择了目标计算节点，它会将创建实例的请求发送给相应的 Nova Compute 节点。Nova Compute 负责与底层的 Hypervisor 进行通信，通过创建虚拟机实例的 API 或命令来执行实际的创建操作。</p>
</li>
<li><p>实例启动和初始化：Nova Compute 在目标计算节点上启动虚拟机实例，并进行初始化配置。这包括分配计算资源、设置网络连接、加载所需的镜像和用户数据等。</p>
</li>
<li><p>实例状态更新：Nova Compute 在实例创建过程中会定期向 Nova Conductor 汇报实例的状态更新。这包括实例的创建进度、IP 地址分配和可用性等信息，以便 Nova Conductor 进行监控和管理。</p>
</li>
</ol>
<h2 id="Nova服务安装"><a href="#Nova服务安装" class="headerlink" title="Nova服务安装"></a>Nova服务安装</h2><h3 id="作业与实验环境"><a href="#作业与实验环境" class="headerlink" title="作业与实验环境"></a>作业与实验环境</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://wxstc.fanya.chaoxing.com/portal">超星网址</a><br><code>快照管理</code>：控制节点选择<code>项目8</code>，计算节点选择<code>5.3.9</code></p>
</blockquote>
<h3 id="安装配置控制节点上的Nova服务"><a href="#安装配置控制节点上的Nova服务" class="headerlink" title="安装配置控制节点上的Nova服务"></a>安装配置<code>控制节点</code>上的Nova服务</h3><ol>
<li><p>安装Nova软件包</p>
<ol>
<li><p>使用<code>yum -y install</code>在控制节点上安装四个软件包：openstack-nova-api openstack-nova-conductor openstack-nova-scheduler openstack-nova-novncproxy</p>
</li>
<li><p>安装<code>openstack-nova-api</code>时会创建名为“nova”的同名用户和用户组，使用以下命令检查：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/passwd |grep nova</span>
nova:x:162:162:OpenStack Nova Daemons:/var/lib/nova:/sbin/nologin
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/group |grep nova</span>
nobody:x:99:nova
nova:x:162:nova<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
</li>
<li><p>创建Nova数据库并授权</p>
<ol>
<li><p>进入数据库</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># mysql -uroot -p000000</span>
Welcome to the MariaDB monitor.  Commands end with <span class="token punctuation">;</span> or <span class="token punctuation">\</span>g.
Your MariaDB connection <span class="token function">id</span> is <span class="token number">9</span>
Server version: <span class="token number">10.3</span>.20-MariaDB MariaDB Server

Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2000</span>, <span class="token number">2018</span>, Oracle, MariaDB Corporation Ab and others.

Type <span class="token string">'help;'</span> or <span class="token string">'\h'</span> <span class="token keyword">for</span> help. Type <span class="token string">'\c'</span> to <span class="token function">clear</span> the current input statement.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>使用<code>CREATE DATABASE</code>命令新建“nova_api”，“nova_cell0”，“nova”三个数据库</p>
</li>
<li><p>使用以下命令进行数据库授权</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> GRANT ALL PRIVILEGES ON nova_api.* TO <span class="token string">'nova'</span>@<span class="token string">'localhost'</span> IDENTIFIED BY <span class="token string">'000000'</span><span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.000</span> sec<span class="token punctuation">)</span>

MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> GRANT ALL PRIVILEGES ON nova_api.* TO <span class="token string">'nova'</span>@<span class="token string">'%'</span> IDENTIFIED BY <span class="token string">'000000'</span><span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.000</span> sec<span class="token punctuation">)</span>

MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> GRANT ALL PRIVILEGES ON nova_cell0.* TO <span class="token string">'nova'</span>@<span class="token string">'localhost'</span> IDENTIFIED BY <span class="token string">'000000'</span><span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.000</span> sec<span class="token punctuation">)</span>

MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> GRANT ALL PRIVILEGES ON nova_cell0.* TO <span class="token string">'nova'</span>@<span class="token string">'%'</span> IDENTIFIED BY <span class="token string">'000000'</span><span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.000</span> sec<span class="token punctuation">)</span>

MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> GRANT ALL PRIVILEGES ON nova.* TO <span class="token string">'nova'</span>@<span class="token string">'localhost'</span> IDENTIFIED BY <span class="token string">'000000'</span><span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.000</span> sec<span class="token punctuation">)</span>

MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> GRANT ALL PRIVILEGES ON nova.* TO <span class="token string">'nova'</span>@<span class="token string">'%'</span> IDENTIFIED BY <span class="token string">'000000'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
</li>
<li><p>修改Nova配置文件</p>
<ol>
<li><p>去掉配置文件中的空行</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 备份配置文件</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># cp /etc/nova/nova.conf /etc/nova/nova.bak</span>
<span class="token comment"># 2. 去掉空行</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># grep -Ev '^$|#' /etc/nova/nova.bak > /etc/nova/nova.conf</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>配置连接“nova”和“nova_api”数据库</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>api_database<span class="token punctuation">]</span>
<span class="token assign-left variable">connection</span><span class="token operator">=</span>mysql+pymysql://nova:000000@controller/nova_api
<span class="token punctuation">[</span>database<span class="token punctuation">]</span>
<span class="token assign-left variable">connection</span><span class="token operator">=</span>mysql+pymysql://nova:000000@controller/nova<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>Keystone组件交互</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>api<span class="token punctuation">]</span>
auth_strategy <span class="token operator">=</span> keystone
<span class="token punctuation">[</span>keystone_authtoken<span class="token punctuation">]</span>
auth_url <span class="token operator">=</span> http://controller:5000
memcached_servers <span class="token operator">=</span> controller:11211
auth_type <span class="token operator">=</span> password
project_domain_name <span class="token operator">=</span> Default
user_domain_name <span class="token operator">=</span> Default
project_name <span class="token operator">=</span> project
username <span class="token operator">=</span> nova
password <span class="token operator">=</span> 000000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>Placement组件交互</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>placement<span class="token punctuation">]</span>
auth_url <span class="token operator">=</span> http://controller:5000
auth_type <span class="token operator">=</span> password
project_domain_name <span class="token operator">=</span> Default
user_domain_name <span class="token operator">=</span> Default
project_name <span class="token operator">=</span> project
username <span class="token operator">=</span> placement
password <span class="token operator">=</span> 000000
region_name <span class="token operator">=</span> RegionOne<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>Glance组件交互</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>glance<span class="token punctuation">]</span>
api_servers <span class="token operator">=</span> http://controller:9292<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>配置锁路径</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>oslo_concurrency<span class="token punctuation">]</span>
lock_path <span class="token operator">=</span> /var/lib/nova/tmp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>配置消息队列和防火墙</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>DEFAULT<span class="token punctuation">]</span>
enabled_apis <span class="token operator">=</span> osapi_compute,metadata
transport_url <span class="token operator">=</span> rabbit://rabbitmq:000000@controller:5672
my_ip <span class="token operator">=</span> <span class="token number">192.168</span>.10.10
use_neutron <span class="token operator">=</span> <span class="token boolean">true</span>
firewall_driver <span class="token operator">=</span> nova.virt.firewall.NoopFirewallDriver<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>配置VNC连接</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>vnc<span class="token punctuation">]</span>
enabled <span class="token operator">=</span> <span class="token boolean">true</span>
server_listen <span class="token operator">=</span> <span class="token variable">$my_ip</span>
server_proxyclient_address <span class="token operator">=</span> <span class="token variable">$my_ip</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
</li>
<li><p>初始化数据库</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 同步nova_api数据库</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># su nova -s /bin/sh -c "nova-manage api_db sync"</span>
<span class="token comment"># 创建cell1</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># su nova -s /bin/sh -c "nova-manage cell_v2 create_cell --name=cell1"</span>
<span class="token comment"># 数据库映射</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># su nova -s /bin/sh -c "nova-manage cell_v2 map_cell0"</span>
<span class="token comment"># 同步nova数据库</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># su nova -s /bin/sh -c "nova-manage db sync"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>验证单元注册</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># nova-manage cell_v2 list_cells</span>
+-------+--------------------------------------+----------------------------------------+-------------------------------------------------+----------+
<span class="token operator">|</span>  Name <span class="token operator">|</span>                 UUID                 <span class="token operator">|</span>             Transport URL              <span class="token operator">|</span>               Database Connection               <span class="token operator">|</span> Disabled <span class="token operator">|</span>
+-------+--------------------------------------+----------------------------------------+-------------------------------------------------+----------+
<span class="token operator">|</span> cell0 <span class="token operator">|</span> 00000000-0000-0000-0000-000000000000 <span class="token operator">|</span>                 none:/                 <span class="token operator">|</span> mysql+pymysql://nova:****@controller/nova_cell0 <span class="token operator">|</span>  False   <span class="token operator">|</span>
<span class="token operator">|</span> cell1 <span class="token operator">|</span> 0a7038d1-6f69-46ad-8b3f-bf8cadc831c5 <span class="token operator">|</span> rabbit://rabbitmq:****@controller:5672 <span class="token operator">|</span>    mysql+pymysql://nova:****@controller/nova    <span class="token operator">|</span>  False   <span class="token operator">|</span>
+-------+--------------------------------------+----------------------------------------+-------------------------------------------------+----------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>作业1：单元注册结果截图</p>
</blockquote>
</li>
</ol>
<h3 id="Nova组件初始化"><a href="#Nova组件初始化" class="headerlink" title="Nova组件初始化"></a>Nova组件初始化</h3><ol>
<li><p>创建Nova用户</p>
<ol>
<li><p>执行<code>source admin-login</code>导入环境变量进行登录</p>
</li>
<li><p>在“default”域中创建用户“nova”，密码为“000000”：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack user create --domain default --password 000000 nova</span>
+---------------------+----------------------------------+
<span class="token operator">|</span> Field               <span class="token operator">|</span> Value                            <span class="token operator">|</span>
+---------------------+----------------------------------+
<span class="token operator">|</span> domain_id           <span class="token operator">|</span> default                          <span class="token operator">|</span>
<span class="token operator">|</span> enabled             <span class="token operator">|</span> True                             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token function">id</span>                  <span class="token operator">|</span> 5e2fbfe049194a748f6d040686bef9f5 <span class="token operator">|</span>
<span class="token operator">|</span> name                <span class="token operator">|</span> nova                             <span class="token operator">|</span>
<span class="token operator">|</span> options             <span class="token operator">|</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>                               <span class="token operator">|</span>
<span class="token operator">|</span> password_expires_at <span class="token operator">|</span> None                             <span class="token operator">|</span>
+---------------------+----------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>这里所创建的用户和<code>nova.conf</code>配置文件中的[keystone_authtoken]配置的用户名密码一致</p>
</blockquote>
</li>
<li><p>分配“nova”用户在“project”项目中的“admin”角色</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack role add --project project --user nova admin</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
</li>
<li><p>创建Nova服务和端点</p>
<ol>
<li><p>创建名为“nova”，类型为“compute”的服务</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack service create --name nova compute</span>
+---------+----------------------------------+
<span class="token operator">|</span> Field   <span class="token operator">|</span> Value                            <span class="token operator">|</span>
+---------+----------------------------------+
<span class="token operator">|</span> enabled <span class="token operator">|</span> True                             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token function">id</span>      <span class="token operator">|</span> b6028ad5a1e545a992dcdeaff3e0f7a6 <span class="token operator">|</span>
<span class="token operator">|</span> name    <span class="token operator">|</span> nova                             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token builtin class-name">type</span>    <span class="token operator">|</span> compute                          <span class="token operator">|</span>
+---------+----------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>创建服务端点</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 公众用户端点</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack endpoint create --region RegionOne nova public http://controller:8774/v2.1</span>
<span class="token comment"># 2. 内部组件端点</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack endpoint create --region RegionOne nova internal http://controller:8774/v2.1</span>
<span class="token comment"># 3. admin用户端点</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack endpoint create --region RegionOne compute admin http://controller:8774/v2.1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
</li>
<li><p>启动控制节点的Nova服务</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 设置开机启动</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable openstack-nova-api openstack-nova-conductor openstack-nova-scheduler openstack-nova-novncproxy</span>
<span class="token comment"># 2. 设置立即启动</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># systemctl start openstack-nova-api openstack-nova-conductor openstack-nova-scheduler openstack-nova-novncproxy</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>检查Nova组件的运行</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># netstat -nutpl|grep 877</span>
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:8774            <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">6531</span>/python2
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:8775            <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">6531</span>/python2
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::8778                 :::*                    LISTEN      <span class="token number">1035</span>/httpd
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack compute service list</span>
+----+----------------+------------+----------+---------+-------+----------------------------+
<span class="token operator">|</span> ID <span class="token operator">|</span> Binary         <span class="token operator">|</span> Host       <span class="token operator">|</span> Zone     <span class="token operator">|</span> Status  <span class="token operator">|</span> State <span class="token operator">|</span> Updated At                 <span class="token operator">|</span>
+----+----------------+------------+----------+---------+-------+----------------------------+
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> nova-conductor <span class="token operator">|</span> controller <span class="token operator">|</span> internal <span class="token operator">|</span> enabled <span class="token operator">|</span> up    <span class="token operator">|</span> <span class="token number">2023</span>-10-16T00:33:33.000000 <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span> nova-scheduler <span class="token operator">|</span> controller <span class="token operator">|</span> internal <span class="token operator">|</span> enabled <span class="token operator">|</span> up    <span class="token operator">|</span> <span class="token number">2023</span>-10-16T00:33:26.000000 <span class="token operator">|</span>
+----+----------------+------------+----------+---------+-------+----------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>作业2：Nova组件运行截图</p>
</blockquote>
</li>
</ol>
<h3 id="安装配置计算节点上的Nova服务"><a href="#安装配置计算节点上的Nova服务" class="headerlink" title="安装配置计算节点上的Nova服务"></a>安装配置<code>计算节点</code>上的Nova服务</h3><ol>
<li><p>安装Nova软件包</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># yum -y install openstack-nova-compute</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>验证系统内是否有名为“nova”的用户和用户组</p>
</blockquote>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/passwd |grep nova</span>
nova:x:162:162:OpenStack Nova Daemons:/var/lib/nova:/sbin/nologin
<span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/group |grep nova</span>
nobody:x:99:nova
qemu:x:107:nova
libvirt:x:991:nova
nova:x:162:nova<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>修改Nova配置文件<code>/etc/nova/nova.conf</code></p>
<ol>
<li><p>去掉配置文件中的空行</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 备份配置文件</span>
<span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># cp /etc/nova/nova.conf /etc/nova/nova.bak</span>
<span class="token comment"># 2. 去掉空行</span>
<span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># grep -Ev '^$|#' /etc/nova/nova.bak > /etc/nova/nova.conf</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>Keystone组件交互</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>api<span class="token punctuation">]</span>
auth_strategy <span class="token operator">=</span> keystone
<span class="token punctuation">[</span>keystone_authtoken<span class="token punctuation">]</span>
auth_url <span class="token operator">=</span> http://controller:5000
memcached_servers <span class="token operator">=</span> controller:11211
auth_type <span class="token operator">=</span> password
project_domain_name <span class="token operator">=</span> Default
user_domain_name <span class="token operator">=</span> Default
project_name <span class="token operator">=</span> project
username <span class="token operator">=</span> nova
password <span class="token operator">=</span> 000000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>Placement组件交互</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>placement<span class="token punctuation">]</span>
auth_url <span class="token operator">=</span> http://controller:5000
auth_type <span class="token operator">=</span> password
project_domain_name <span class="token operator">=</span> Default
user_domain_name <span class="token operator">=</span> Default
project_name <span class="token operator">=</span> project
username <span class="token operator">=</span> placement
password <span class="token operator">=</span> 000000
region_name <span class="token operator">=</span> RegionOne<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>Glance组件交互</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>glance<span class="token punctuation">]</span>
api_servers <span class="token operator">=</span> http://controller:9292<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>配置锁路径</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>oslo_concurrency<span class="token punctuation">]</span>
lock_path <span class="token operator">=</span> /var/lib/nova/tmp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>配置消息队列和防火墙</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>DEFAULT<span class="token punctuation">]</span>
enabled_apis <span class="token operator">=</span> osapi_compute,metadata
transport_url <span class="token operator">=</span> rabbit://rabbitmq:000000@controller:5672
my_ip <span class="token operator">=</span> <span class="token number">192.168</span>.10.20
use_neutron <span class="token operator">=</span> <span class="token boolean">true</span>
firewall_driver <span class="token operator">=</span> nova.virt.firewall.NoopFirewallDriver<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>配置VNC连接</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>vnc<span class="token punctuation">]</span>
enabled <span class="token operator">=</span> <span class="token boolean">true</span>
server_listen <span class="token operator">=</span> <span class="token number">0.0</span>.0.0
server_proxyclient_address <span class="token operator">=</span> <span class="token variable">$my_ip</span>
novncproxy_base_url <span class="token operator">=</span> http://192.168.10.10:6080/vnc_auto.html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>配置<code>[libvirt]</code>部分，设置虚拟化类型<code>qemu</code></p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>libvirt<span class="token punctuation">]</span>
virt_type <span class="token operator">=</span> qemu<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>启动计算节点的Nova服务</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable libvirtd openstack-nova-compute</span>
Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-compute.service to /usr/lib/systemd/system/openstack-nova-compute.service.
<span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># systemctl start libvirtd openstack-nova-compute</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li>
</ol>
</li>
</ol>
<h3 id="发现计算节点并检验"><a href="#发现计算节点并检验" class="headerlink" title="发现计算节点并检验"></a>发现计算节点并检验</h3><blockquote>
<p>下面的命令在控制节点执行</p>
</blockquote>
<ol>
<li><p>执行<code>source admin-login</code>导入环境变量登录</p>
</li>
<li><p>发现新的计算节点</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># su nova -s /bin/sh -c "nova-manage cell_v2 discover_hosts --verbose"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>设置<code>/etc/nova/nova.conf</code>配置自动发现计算节点</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>scheduler<span class="token punctuation">]</span>
discover_hosts_in_cells_internal <span class="token operator">=</span> <span class="token number">60</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 重启nova-api服务使配置生效</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart openstack-nova-api</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>验证nova模块的状态</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看模块的运行状态</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack compute service list</span>
+----+----------------+------------+----------+---------+-------+----------------------------+
<span class="token operator">|</span> ID <span class="token operator">|</span> Binary         <span class="token operator">|</span> Host       <span class="token operator">|</span> Zone     <span class="token operator">|</span> Status  <span class="token operator">|</span> State <span class="token operator">|</span> Updated At                 <span class="token operator">|</span>
+----+----------------+------------+----------+---------+-------+----------------------------+
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> nova-conductor <span class="token operator">|</span> controller <span class="token operator">|</span> internal <span class="token operator">|</span> enabled <span class="token operator">|</span> up    <span class="token operator">|</span> <span class="token number">2023</span>-10-16T01:22:53.000000 <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span> nova-scheduler <span class="token operator">|</span> controller <span class="token operator">|</span> internal <span class="token operator">|</span> enabled <span class="token operator">|</span> up    <span class="token operator">|</span> <span class="token number">2023</span>-10-16T01:22:57.000000 <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">5</span> <span class="token operator">|</span> nova-compute   <span class="token operator">|</span> compute    <span class="token operator">|</span> nova     <span class="token operator">|</span> enabled <span class="token operator">|</span> up    <span class="token operator">|</span> <span class="token number">2023</span>-10-16T01:22:57.000000 <span class="token operator">|</span>
+----+----------------+------------+----------+---------+-------+----------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用状态检测工具验证，应该显示4个success</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># nova-status upgrade check</span>
+--------------------------------+
<span class="token operator">|</span> Upgrade Check Results          <span class="token operator">|</span>
+--------------------------------+
<span class="token operator">|</span> Check: Cells v2                <span class="token operator">|</span>
<span class="token operator">|</span> Result: Success                <span class="token operator">|</span>
<span class="token operator">|</span> Details: None                  <span class="token operator">|</span>
+--------------------------------+
<span class="token operator">|</span> Check: Placement API           <span class="token operator">|</span>
<span class="token operator">|</span> Result: Success                <span class="token operator">|</span>
<span class="token operator">|</span> Details: None                  <span class="token operator">|</span>
+--------------------------------+
<span class="token operator">|</span> Check: Ironic Flavor Migration <span class="token operator">|</span>
<span class="token operator">|</span> Result: Success                <span class="token operator">|</span>
<span class="token operator">|</span> Details: None                  <span class="token operator">|</span>
+--------------------------------+
<span class="token operator">|</span> Check: Cinder API              <span class="token operator">|</span>
<span class="token operator">|</span> Result: Success                <span class="token operator">|</span>
<span class="token operator">|</span> Details: None                  <span class="token operator">|</span>
+--------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>作业3：Nova模块检测结果截图</p>
</blockquote>
</li>
</ol>
<h2 id="Nova实例管理"><a href="#Nova实例管理" class="headerlink" title="Nova实例管理"></a>Nova实例管理</h2><h3 id="实例创建前提"><a href="#实例创建前提" class="headerlink" title="实例创建前提"></a>实例创建前提</h3><p>执行以下命令查看所需的前提条件：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">openstack flavor list       <span class="token comment"># 列出可用的实例类型</span>
openstack image list        <span class="token comment"># 列出可用的镜像</span>
openstack network list      <span class="token comment"># 列出可用的网络</span>
openstack keypair list      <span class="token comment"># 列出可用的密钥对</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后执行实例创建命令<code>openstack server create</code>，具体格式如下：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">openstack server create --flavor &lt;flavor> --image &lt;image> --key-name &lt;key_pair> --network &lt;network> [--security-group &lt;security_group>] [--user-data &lt;user_data>] &lt;instance_name>
命令中的参数说明如下：

--flavor &lt;flavor>：指定虚拟机实例的规格（flavor），例如 m1.small。
--image &lt;image>：指定虚拟机实例的镜像，可以是映像名称、ID或URL。
--key-name &lt;key_pair>：指定用于 SSH 访问虚拟机实例的密钥对的名称。
--network &lt;network>：指定虚拟机实例连接到的网络，可以是网络名称或ID。
--security-group &lt;security_group>（可选）：指定用于虚拟机实例的安全组，可以是安全组名称或ID。
--user-data &lt;user_data>（可选）：指定启动虚拟机实例时要传递给实例的自定义用户数据（通常是启动脚本）。
&lt;instance_name>：指定要创建的虚拟机实例的名称。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>命令行实例管理常用命令：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 列出虚拟机实例</span>
openstack server list
<span class="token comment"># 查看实例的详细信息</span>
openstack server show <span class="token operator">&lt;</span>instance_id_or_name<span class="token operator">></span>
<span class="token comment"># 启动虚拟机实例</span>
openstack server start <span class="token operator">&lt;</span>instance_id_or_name<span class="token operator">></span>
<span class="token comment"># 停止虚拟机实例</span>
openstack server stop <span class="token operator">&lt;</span>instance_id_or_name<span class="token operator">></span>
<span class="token comment"># 重启虚拟机实例</span>
openstack server <span class="token function">reboot</span> <span class="token operator">&lt;</span>instance_id_or_name<span class="token operator">></span>
<span class="token comment"># 调整虚拟机实例的实例类型</span>
openstack server resize <span class="token operator">&lt;</span>instance_id_or_name<span class="token operator">></span> <span class="token parameter variable">--flavor</span> <span class="token operator">&lt;</span>new_flavor<span class="token operator">></span>
<span class="token comment"># 删除虚拟机实例</span>
openstack server delete <span class="token operator">&lt;</span>instance_id_or_name<span class="token operator">></span>
<span class="token comment"># 迁移虚拟机实例到其他计算节点</span>
openstack server migrate <span class="token operator">&lt;</span>instance_id_or_name<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="虚拟机实例创建流程"><a href="#虚拟机实例创建流程" class="headerlink" title="虚拟机实例创建流程"></a>虚拟机实例创建流程</h3><ol>
<li><p>创建密钥对</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack keypair create test-key</span>
-----BEGIN RSA PRIVATE KEY-----
MIIEpgIBAAKCAQEA4ezhYShGObIS2GsCMyepBz+beVnJbs5ngIkNor2okw2pNcwW
kFVf4XUYgAPk8UgzJWVjlbFzPYfYzmrGO/4DthjpnV9udkahIIn+IsfPajvbWn/n
aOjrncva99YvqpsLOaasaO5fS0k+YLQaWeVzhLW43pndT+e3BRa120msvItqIuK5
Fs4eCtjtAYeYBOlN/AReymXf6m2Et3TIk8tATk4De0q3u7p2TIfGYdbh22HiOWI4
2J1Q9y2sC2Jj/idV9+407iLbMN/CfdVDu6Wm2Z0Ec3z5a3nGqHsRHJwK2eAS8eQD
2AUksTMCBGBQDdgFTXnvXha8pjGz981kAjlYhQIDAQABAoIBAQDU56Z9KLcFKAsa
Z71q97USX57kfPiWs2xWdNGky5ZQ/k63o9yfp9TzYqXz/beCqceJNkLijpdLJPnr
jDPD1V0p/dApvgUa8PRm9aPIowOT2VSdtGsfMmDYE4QGipHg9LtfWPKg8AJdsGhY
OWGb1d9G8PmGzPkClBqlcQFv5b4i7nlkgNlqKMAxTTpYuw8VQ1bcekae1AMX4LJh
hObxjF2jrAwzKnX7oZtWpkKMNohbPoe4FnvPIbmwEWl6P9ewBqCUukGEYIu8C3u0
42nkCEzdjjsD4PQ7sQRABeFM045RVUVbWjWo+JhvnIrJYmpi1vMaqiaKnD+DF2nb
DKvTLNABAoGBAPc/lscQCW95kHvhhxVB3kwwTeUUz5fvMX6kyGfZp0C1oFc1Zp40
tHSdroZW7t0USJNAdPQXeBGmd3feM/8VsR09VOuaJCTTl0vvIq41JtU7jY6lk4a7
dkeomB8Dn8yswccvZ22id7CAsd378VKf3KklZQJiTRNaQwxHTsBVUBjRAoGBAOns
Ey7dHAzmpiv+Ws7UvaBN5Yz4l/9gbMsrpXICnbOGmVAW+WrP4Qloip8SGQLY2Csy
oj47UcdVLPISe0ChgUtzZCMh+u58fY3mpKlkEMnEahX2HommCzCJhwTa9G/lm/Js
I2Fnf+siwVzpeR8ZWbXh7NzZBhq1a67oglMpfjF1AoGBAL2shprHbrWZ6IFgjiR8
l3CTTe6DfI3t7WZeO2+PxYMa0pqUWNjdTeJ4ZL6iSjRHrzVnqVDoADBqKBRI3lK9
7VWlC1SCt1+ZAuQ5270RAW1rdjkMRJSDk0V9zNVeDmUR0sZfU1UD4hYBZHILKSJd
iQYprceaac6C3BS7T2q1B/FBAoGBALY8I/Wua9vhFDPRxAy9z7zC8sIQKNna1Oay
6gEX6KOjiGzMeSKtMDOULeoevz1okX+Vwq+Ypu0TfiBYJY0ERSXyj2CPaF3Cvk1+
EWmley60xbC2PLQflzgI7BbsPOGvjv4dILMRXqZgPSOU/7cqmKkJiO3EZO0JyQpK
OL1w5c7BAoGBALZI9+hh82MuOLLl9cd7EhgiNPos+HI4TZJLAlypd55v9cOIkjr+
olyRV9KLnHZiV086FRihPWbGxXMVg167efPciztS7Qlc+likocWztyIVll++A71M
547dAnIA4iw30MFMzQxs917RbRv++dJkuyvBLULGzMFOjCb48CzvR9q+
-----END RSA PRIVATE KEY-----<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>其他密钥管理命令</li>
</ul>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 列出密钥</span>
openstack keypair list
<span class="token comment"># 查看密钥详细信息</span>
openstack keypair show <span class="token operator">&lt;</span>密钥对名称<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>创建实例类型</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack flavor create --public test_flavor --id auto --ram 256 --disk 5 --vcpus 1</span>
+----------------------------+--------------------------------------+
<span class="token operator">|</span> Field                      <span class="token operator">|</span> Value                                <span class="token operator">|</span>
+----------------------------+--------------------------------------+
<span class="token operator">|</span> OS-FLV-DISABLED:disabled   <span class="token operator">|</span> False                                <span class="token operator">|</span>
<span class="token operator">|</span> OS-FLV-EXT-DATA:ephemeral  <span class="token operator">|</span> <span class="token number">0</span>                                    <span class="token operator">|</span>
<span class="token operator">|</span> disk                       <span class="token operator">|</span> <span class="token number">0</span>                                    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token function">id</span>                         <span class="token operator">|</span> 205ecf42-35b2-4f79-b928-c56c063cdbc2 <span class="token operator">|</span>
<span class="token operator">|</span> name                       <span class="token operator">|</span> test_flavor                          <span class="token operator">|</span>
<span class="token operator">|</span> os-flavor-access:is_public <span class="token operator">|</span> True                                 <span class="token operator">|</span>
<span class="token operator">|</span> properties                 <span class="token operator">|</span>                                      <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token function">ram</span>                        <span class="token operator">|</span> <span class="token number">256</span>                                  <span class="token operator">|</span>
<span class="token operator">|</span> rxtx_factor                <span class="token operator">|</span> <span class="token number">1.0</span>                                  <span class="token operator">|</span>
<span class="token operator">|</span> swap                       <span class="token operator">|</span>                                      <span class="token operator">|</span>
<span class="token operator">|</span> vcpus                      <span class="token operator">|</span> <span class="token number">1</span>                                    <span class="token operator">|</span>
+----------------------------+--------------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>其他实例类型管理命令</li>
</ul>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">openstack flavor list
openstack flavor show <span class="token operator">&lt;</span>实例类型ID<span class="token operator">></span>
openstack flavor delete <span class="token operator">&lt;</span>实例类型ID<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>创建网络</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack network create --share --external --provider-network-type flat --provider-physical-network provider --project admin test_net</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack subnet create --network test_net --subnet-range 192.168.20.0/24 --gateway 192.168.20.2 --allocation-pool start=192.168.20.128,end=192.168.20.140 --dns-nameserver 114.114.114.114 test_subnet</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>创建实例</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack server create --flavor test_flavor --network test_net --key-name test-key --image cirros cirros-VM1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p><code>计算节点</code>免密登录</p>
<ul>
<li>在<code>控制节点</code>使用实例管理命令获取实例的ip地址</li>
</ul>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack server show cirror-VM1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>将之前的私钥复制并粘贴到<code>计算节点</code>的<code>/root/.ssh/demo-key.pem</code>，使用ssh命令免密登录</li>
</ul>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># chmod 600 ~/.ssh/demo-key.pem</span>
<span class="token punctuation">[</span>root@compute ~<span class="token punctuation">]</span><span class="token comment"># ssh -i ~/.ssh/demo-key.pem cirros@192.168.20.130</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<blockquote>
<p>作业4：计算节点免密登录实例截图</p>
</blockquote>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/10/06/private_clouds/5.OpenStack%E9%95%9C%E5%83%8F%E5%88%B6%E4%BD%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/06/private_clouds/5.OpenStack%E9%95%9C%E5%83%8F%E5%88%B6%E4%BD%9C/" class="post-title-link" itemprop="url">OpenStack镜像管理与制作（二）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-06 11:00:09" itemprop="dateCreated datePublished" datetime="2023-10-06T11:00:09+08:00">2023-10-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-11-06 14:36:00" itemprop="dateModified" datetime="2023-11-06T14:36:00+08:00">2023-11-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="虚拟机镜像制作方法"><a href="#虚拟机镜像制作方法" class="headerlink" title="虚拟机镜像制作方法"></a>虚拟机镜像制作方法</h2><p>OpenStack平台所使用的镜像文件是一种虚拟机镜像，我们简称为镜像。而虚拟机镜像本质上是一个包含虚拟磁盘的单个文件，该虚拟磁盘上安装了可引导的操作系统。</p>
<p>上一节课已经介绍了通过下载官方预制的虚拟机镜像，这种途径获取到的镜像文件大都默认禁用SSH密码身份验证，同时包含<code>cloud-init</code>来支持SSH密钥对和用户数据的注入。通过密钥实现登录之后可以做进一步的定制，最后通过创建快照重新生成新的虚拟机镜像。</p>
<p>以上这种获取、修改、生成新的镜像的方法容易理解、实现过程简单，适用于需要进行轻度定制的场景。如果需要进行深度的定制或者需要定制特定平台的镜像文件时可以通过更多的途径制作镜像。</p>
<p>其他制作虚拟机镜像的方法：</p>
<ul>
<li>通过工具（Guestfish,guestmount）修改虚拟机镜像</li>
<li>通过工具（Diskimage-builder）创建虚拟机镜像</li>
<li>手动创建虚拟机镜像</li>
</ul>
<h2 id="获取实验资源"><a href="#获取实验资源" class="headerlink" title="获取实验资源"></a>获取实验资源</h2><blockquote>
<p>这一步从教师机获取实验所用的镜像。</p>
</blockquote>
<p>Windows + E打开文件资源管理器在搜索栏输入<code>\\192.168.3.47</code>打开后将文件<code>CentOS-7-x86_64-GenericCloud-2003.qcow2</code>拉取到Windows本地目录<code>D:\\镜像\</code>覆盖目录下的同名文件。</p>
<img src="https://vault.taojie.fun:28089/i/2023/10/11/2023-10-11-1696954122.png" alt="1696954122919.png" title="1696954122919.png" />

<h2 id="实验环境准备"><a href="#实验环境准备" class="headerlink" title="实验环境准备"></a>实验环境准备</h2><blockquote>
<p>设置<code>控制节点</code>快照版本<code>5.3.8</code></p>
</blockquote>
<ul>
<li><p>右键虚拟机<code>控制节点</code> -&gt; 设置 -&gt; 处理器，将<code>虚拟化引擎</code>里的勾全部取消，启动<code>控制节点</code>。</p>
  <img src="https://vault.taojie.fun:28089/i/2023/10/11/2023-10-11-1696954933.png" alt="1696954933617.png" title="1696954933617.png" />
</li>
<li><p>使用WinSCP工具将需要定制的镜像上传到<code>控制节点</code>，将文件从左侧的windows本地拖动到右侧的虚拟机内部。</p>
  <img src="https://vault.taojie.fun:28089/i/2023/10/11/2023-10-11-1696956085.png" alt="1696956085852.png" title="1696956085852.png" /></li>
</ul>
<h2 id="Guestfish使用"><a href="#Guestfish使用" class="headerlink" title="Guestfish使用"></a>Guestfish使用</h2><p>Guestfish是一个用于访问和修改虚拟机磁盘镜像的工具，它提供了一种交互式方式来浏览、修改虚拟机的文件系统。</p>
<h3 id="Guestfish安装配置"><a href="#Guestfish安装配置" class="headerlink" title="Guestfish安装配置"></a>Guestfish安装配置</h3><ul>
<li><p>Guestfish软件包安装</p>
  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># yum -y install libguestfs-tools</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>执行命令安装<code>libvirt</code>服务。</p>
  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># yum -y install libvirt</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>修改libvirt配置<code>vi /etc/libvirt/qemu.conf</code>。</p>
  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/libvirt/qemu.conf</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

  <img src="https://vault.taojie.fun:28089/i/2023/10/10/2023-10-10-1696912516.png" alt="1696912515114.png" title="1696912515114.png" />
</li>
<li><p>启动libvirt服务。</p>
  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># systemctl start libvirtd</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ul>
<h3 id="镜像定制"><a href="#镜像定制" class="headerlink" title="镜像定制"></a>镜像定制</h3><blockquote>
<p>定制内容是设置centos镜像的root和centos账户的直接登录、开启bash后利用字符打印一个图案。</p>
</blockquote>
<ol>
<li><p>安装openssl，生成加密的字符串并<code>复制</code>用于设置root密码。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># yum -y install openssl</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openssl passwd -1 123123</span>
<span class="token variable">$1</span><span class="token variable">$vNor7zoi</span><span class="token variable">$MrzvyJiIETqxfoO</span>.zxgIL0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>需要修改的虚拟机镜像文件名为<code>CentOS-7-x86_64-GenericCloud-2003.qcow2</code>，通过以下命令以root身份挂载为读写模式：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># guestfish --rw -a CentOS-7-x86_64-GenericCloud-2003.qcow2</span>

Welcome to Guestfish, the libguestfs filesystem interactive shell <span class="token keyword">for</span>
editing virtual machine filesystems.

Type: <span class="token string">'help'</span> <span class="token keyword">for</span> <span class="token builtin class-name">help</span> on commands
<span class="token string">'man'</span> to <span class="token builtin class-name">read</span> the manual
<span class="token string">'quit'</span> to quit the shell

<span class="token operator">></span><span class="token operator">&lt;</span>fs<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>此时进入Guestfish的会话，提示符为<code>&gt;&lt;fs&gt;</code></p>
</blockquote>
 <img src="https://vault.taojie.fun:28089/i/2023/10/11/2023-10-11-1696954607.png" alt="1696954607319.png" title="1696954607319.png" />
</li>
<li><p>首先在Guestfish提示符下使用<code>run</code>命令启动一个虚拟机才能执行其他操作，该虚拟机将用于执行所有文件操作。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">></span><span class="token operator">&lt;</span>fs<span class="token operator">></span> run<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>通过list-filesystems命令查看文件系统。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">></span><span class="token operator">&lt;</span>fs<span class="token operator">></span> list-filesystems<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>作业1：上传显示的镜像分区信息。</p>
</blockquote>
</li>
<li><p>挂载包含根目录的分区并修改文件<code>/etc/shadow</code>用来给root账户设置密码。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">></span><span class="token operator">&lt;</span>fs<span class="token operator">></span> <span class="token function">mount</span> /dev/sda1 /<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">></span><span class="token operator">&lt;</span>fs<span class="token operator">></span> <span class="token function">vi</span> /etc/shadow<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>在文件的第一行的第一、二个冒号中间插入之前复制的所生成的root密码。</p>
</blockquote>
 <img src="https://vault.taojie.fun:28089/i/2023/10/11/2023-10-11-1696956445.png" alt="1696956445209.png" title="1696956445209.png" />
</li>
<li><p>修改<code>/etc/cloud/cloud.cfg</code>文件。</p>
<p> 在第58行下添加<code>plain_text_passwd: &#39;000000&#39;</code>字段用来给centos用户设置初始密码<code>000000</code>。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/10/09/2023-10-09-1696817530.png" alt="1696817529748.png" title="1696817529748.png" />
</li>
<li><p>使用<code>vi</code>修改<code>/root/.bashrc</code>文件，设置bash自启动命令，添加以下命令到最后。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">'....................................................................................................'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'....................................................................................................'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'....................................................................................................'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'..........................:*@@@@@@#=...........:-=====--:...........................................'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'........................:#@@@@@@@@@@@-.:+*#%%+-:.........:-+#*=......:+#%%#*:.......................'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'.......................:@@@@@@@@@@@@@@%-.......................:*%:+@@@@@@@@@@*.....................'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'.......................#@@@@@@@@@@@@@-..........  .................#@@@@@@@@@@@@=...................'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'......................=@@@@@@@@@@@-...................................%@@@@@@@@@@...................'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'......................=@@@@@@@@@%:.....................................%@@@@@@@@@:..................'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'........................%@@@@@@#.......................................-@@@@@@@@@...................'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'...............#@#.......*@@@@%.........................................-@@@@@@@+...................'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'........+@@+..#@@%........:*@@-..........................................=@@@@%-........+*:.........'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'........*@@%..%@@#..........:*............................................%#=:.........+@@%.........'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'........-@@@..@@@=..........*.............................................-+......#@@=.=@@%.........'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'.....=%%@@@@#*@@@..........*-..............................................#:.....#@@@%@@@%.........'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'....-@@@@@@@@@@@#.........=*...............................................++......=%@@@@@@@@@@=....'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'....-@@@@@@@@@@@@-........%:...............................................=*.......:@@@@@@@@@@@#...'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'.....@@@@@@@@@@@@........-*................................................:#........@@@@@@@@@@@@*..'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'.....#@@@@@@@@@@#......:%@=.................................................@*......:@@@@@@@@@@@@+..'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'......@@@@@@@@@@*.....#@@@:.................................................@@#......#@@@@@@@@@@-...'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'......@@@@@@@@@@%-...:@@@@+.................................................@@@%:......+@@@@@@@@-...'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'......*@@@@@@@@@@@*=.:@@@@%:................................................@@@@@......+@@@@@@@%:...'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'......-@@@@@@@@@@@@@@@@@@@@%:..............................................+@@@@@%.....=@@@@@@@%....'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'.......%@@@@@@@@@@@@@@@@@@@@@*............................................=@@@@@@@@@@@@@@@@@@@@#....'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'.......:@@@@@@@@@@@@@@@@@@@@@@@=........................................:#@@@@@@@@@@@@@@@@@@@@@#....'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'........+@@@@@@@@@@@@@@@@@@@@@@@@%-...................................:#@@@@@@@@@@@@@@@@@@@@@@@%....'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'.........%@@@@@@@@@@@@@@@@@@@@@@@@@@+.............................:=#@@@@@@@@@@@@@@@@@@@@@@@@@@=....'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'..........=@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*-:..................-+%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@=.....'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'............=@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@####%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*.......'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'................:-=+##%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@@@@@@%%%%%%%%%%%%%%@@@@@@@@@@@@@@@@%*=:.........'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'....................................................................................................'</span>
<span class="token builtin class-name">echo</span> <span class="token string">'....................................................................................................'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>卸载挂载点、退出guestfish视图</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">></span><span class="token operator">&lt;</span>fs<span class="token operator">></span> <span class="token function">umount</span> /
<span class="token operator">></span><span class="token operator">&lt;</span>fs<span class="token operator">></span> <span class="token builtin class-name">exit</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="验证定制结果"><a href="#验证定制结果" class="headerlink" title="验证定制结果"></a>验证定制结果</h3><ol>
<li><p>通过WinSCP将修改好的<code>CentOS-7-x86_64-GenericCloud-2003.qcow2</code>传输回本地的Windows桌面。</p>
</li>
<li><p>关闭<code>控制节点</code>虚拟机、将<code>控制节点</code>设置为快照<code>项目12</code>、启动<code>控制节点</code>和<code>计算节点</code>，登录<code>192.168.10.20</code>控制台。</p>
</li>
<li><p>在镜像菜单上传上文修改好的镜像<code>CentOS-7-x86_64-GenericCloud-2003.qcow2</code>到OpenStack。</p>
</li>
<li><p>创建<code>网络</code>，<code>实例类型</code>，不会的参考前面的笔记。</p>
</li>
<li><p>创建Centos实例并使用root账户登录（密码是上文配置的123123）验证结果，应该会显示下图所示的屏保动画。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/10/13/2023-10-13-1697171723.png" alt="1697171722897.png" title="1697171722897.png" /></li>
</ol>
<blockquote>
<p>作业2:上传登录后的截图</p>
</blockquote>
<h2 id="Guestmount使用"><a href="#Guestmount使用" class="headerlink" title="Guestmount使用"></a>Guestmount使用</h2><p><code>Guestmount</code>是一个用于挂载虚拟机磁盘镜像的工具，它允许在宿主机上将虚拟机磁盘镜像挂载为宿主机文件系统的一部分，从而可以直接访问和修改虚拟机镜像中的文件。Guestmount可以在不启动虚拟机的情况下进行操作，提供了对镜像中文件的读写访问权限。通过Guestmount，可以像操作本地文件系统一样，使用标准的文件操作命令（例如cp、mv、rm 等）</p>
<ul>
<li><p>Guestmount用法示例</p>
<ol>
<li><p>假设需要修改的虚拟机镜像文件名为<code>centos63_desktop.img</code>，从该文件中挂载根分区到<code>/mnt</code>目录。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># guestmount -a centos63_desktop.qcow2 -m /dev/vg_centosbase/lv_root --rw /mnt</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>当预先不知道具体的挂载点时可以通过选项<code>-i</code>自动决定所用的挂载点。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># guestmount -a centos63_desktop.qcow2 -i --rw /mnt</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>修改完成后卸载挂载点。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># umount /mnt</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
</li>
</ul>
<h2 id="Diskimage-builder使用"><a href="#Diskimage-builder使用" class="headerlink" title="Diskimage-builder使用"></a>Diskimage-builder使用</h2><p>Diskimage-builder（DIB）是一个用于创建定制化操作系统磁盘镜像的工具。它是一个开源项目，旨在帮助开发者和系统管理员构建适合特定用途的操作系统镜像，例如用于虚拟机、容器、云平台等环境。</p>
<ol>
<li><p>Diskimage-builder安装。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># yum -y install diskimage-builder</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>创建一个通用的Ubuntu虚拟磁盘镜像。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># disk-image-create ubuntu vm</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>还可以通过设置命令行选项或者环境变量实现其他镜像的构造。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># disk-image-create -a armhf ubuntu vm</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>除此之外还可以通过YAML文件描述需要构造的镜像。</p>
 <pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 元素列表，表示构建镜像时要包含的元素</span>
<span class="token key atrule">elements</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> centos7<span class="token punctuation">-</span>minimal
<span class="token punctuation">-</span> install<span class="token punctuation">-</span>packages

<span class="token comment"># 镜像类型，指定生成的镜像格式</span>
<span class="token key atrule">image_types</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> qcow2
<span class="token punctuation">-</span> raw

<span class="token comment"># 操作系统发行版和版本</span>
<span class="token key atrule">release</span><span class="token punctuation">:</span> centos7

<span class="token comment"># 构建参数和配置</span>
<span class="token key atrule">properties</span><span class="token punctuation">:</span>
<span class="token comment"># 用户名和密码</span>
<span class="token key atrule">user</span><span class="token punctuation">:</span> myuser
<span class="token key atrule">password</span><span class="token punctuation">:</span> mypassword<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h2 id="手动定制虚拟磁盘镜像"><a href="#手动定制虚拟磁盘镜像" class="headerlink" title="手动定制虚拟磁盘镜像"></a>手动定制虚拟磁盘镜像</h2><p>除了可以通过上述的工具在已有的虚拟磁盘文件的基础上进行修改以外还可以手动定制虚拟磁盘镜像，这个过程需要通过ISO CD文件安装操作系统后通过VNC远程安装windows-server虚拟机完成定制。主要分为以下几步：</p>
<ol>
<li><p>通过<code>kvm+qemu</code>方案安装操作系统虚拟机。</p>
</li>
<li><p>通过<code>vnc</code>连接虚拟机后实现进一步配置、定制。</p>
</li>
<li><p>上传定制好的系统镜像到OpenStack平台完成验证。</p>
</li>
</ol>
<h3 id="作业与实验环境"><a href="#作业与实验环境" class="headerlink" title="作业与实验环境"></a>作业与实验环境</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://wxstc.fanya.chaoxing.com/portal">超星网址</a><br>虚拟机使用<code>xnode1</code>，登录账户：root，密码：000000</p>
</blockquote>
<h3 id="系统资源准备"><a href="#系统资源准备" class="headerlink" title="系统资源准备"></a>系统资源准备</h3><ol>
<li><p>在安装系统之前需要删除部分<code>C盘</code>内容，获取系统安装包、VirtIO驱动，参考第一节从共享文件中拉取文件到桌面上<code>cn_windows_server_2012_r2_with_update_x64_dvd_6052725.iso</code>、<code>virtio-win-0.1.185.iso</code>、<code>WinSCP.exe</code>。</p>
</li>
<li><p>打开虚拟机<code>xnode1</code>，使用vmware控制台登录。</p>
</li>
<li><p>修改网口配置文件<code>/etc/sysconfig/network-scripts/ifcfg-eno16777736</code>，设置DHCP，删除后面配置的静态IP。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">TYPE</span><span class="token operator">=</span>Ethernet
<span class="token assign-left variable">BOOTPROTO</span><span class="token operator">=</span>dhcp      <span class="token comment"># dhcp设置</span>
<span class="token assign-left variable">DEFROUTE</span><span class="token operator">=</span>yes
<span class="token assign-left variable">PEERDNS</span><span class="token operator">=</span>yes
<span class="token assign-left variable">PEERROUTES</span><span class="token operator">=</span>yes
<span class="token assign-left variable">IPV4_FAILURE_FATAL</span><span class="token operator">=</span>no
<span class="token assign-left variable">IPV6INIT</span><span class="token operator">=</span>yes
<span class="token assign-left variable">IPV6_AUTOCONF</span><span class="token operator">=</span>yes
<span class="token assign-left variable">IPV6_DEFROUTE</span><span class="token operator">=</span>yes
<span class="token assign-left variable">IPV6_PEERDNS</span><span class="token operator">=</span>yes
<span class="token assign-left variable">IPV6_PEERROUTES</span><span class="token operator">=</span>yes
<span class="token assign-left variable">IPV6_FAILURE_FATAL</span><span class="token operator">=</span>no
<span class="token assign-left variable">NAME</span><span class="token operator">=</span>eno16777736
<span class="token assign-left variable">UUID</span><span class="token operator">=</span>0c189275-81a1-4c21-84b8-e72af745cb09
<span class="token assign-left variable">DEVICE</span><span class="token operator">=</span>eno16777736
<span class="token assign-left variable">ONBOOT</span><span class="token operator">=</span>yes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>执行<code>ifdown &lt;网口名&gt;</code> + <code>ifup &lt;网口名&gt;</code>使配置生效。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@xnode1 ~<span class="token punctuation">]</span><span class="token comment"># ifdown eno16777736</span>
<span class="token punctuation">[</span>root@xnode1 ~<span class="token punctuation">]</span><span class="token comment"># ifup eno16777736</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>使用<code>ip addr</code>命令查看新的IP地址，ping下百度的域名检查外网连接状态。</p>
</li>
<li><p>安装虚拟化相关的软件包。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># virt-install 是一个命令行工具，用于在虚拟化环境中创建和安装虚拟机</span>
<span class="token punctuation">[</span>root@xnode1 ~<span class="token punctuation">]</span><span class="token comment"># yum install -y qemu-kvm libvirt virt-install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>使用WinScp工具连接<code>xnode1</code>所分配的IP地址、登录会话将<code>cn_windows_server_2012_r2_with_update_x64_dvd_6052725.iso</code>、<code>virtio-win-0.1.185.iso</code>两个文件从windows本地上传到<code>xnode1</code>虚拟机内。</p>
</li>
<li><p>修改<code>/etc/libvirt/qemu.conf</code>，设置libvirt <code>root</code>权限和<code>VNC</code>远程虚拟机配置。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/10/17/2023-10-17-1697515973.png" alt="1697515972974.png" title="1697515972974.png" />

 <img src="https://vault.taojie.fun:28089/i/2023/10/17/2023-10-17-1697515692.png" alt="1697515691473.png" title="1697515691473.png" />
</li>
<li><p>启动libvirt服务，关闭防火墙服务。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@xnode1 ~<span class="token punctuation">]</span><span class="token comment"># systemctl disable firewalld</span>
<span class="token punctuation">[</span>root@xnode1 ~<span class="token punctuation">]</span><span class="token comment"># systemctl stop firewalld</span>
<span class="token punctuation">[</span>root@xnode1 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable libvirtd</span>
<span class="token punctuation">[</span>root@xnode1 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start libvirtd</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>创建大小为20G的qcow2格式的虚拟磁盘文件。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@xnode1 ~<span class="token punctuation">]</span><span class="token comment"># qemu-img create -f qcow2 ws2012.qcow2 20G</span>
Formatting <span class="token string">'ws2012.qcow2'</span>, <span class="token assign-left variable">fmt</span><span class="token operator">=</span>qcow2 <span class="token assign-left variable">cluster_size</span><span class="token operator">=</span><span class="token number">65536</span> <span class="token assign-left variable">extended_l2</span><span class="token operator">=</span>off <span class="token assign-left variable">compression_type</span><span class="token operator">=</span>zlib <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">21474836480</span> <span class="token assign-left variable">lazy_refcounts</span><span class="token operator">=</span>off <span class="token assign-left variable">refcount_bits</span><span class="token operator">=</span><span class="token number">16</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="windows-server系统安装"><a href="#windows-server系统安装" class="headerlink" title="windows-server系统安装"></a>windows-server系统安装</h3><ol>
<li><p>执行virt-install命令启动Win-server操作系统。</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">virt-install <span class="token parameter variable">--connect</span> qemu:///system <span class="token punctuation">\</span>
<span class="token parameter variable">--name</span> ws2012 <span class="token parameter variable">--ram</span> <span class="token number">2048</span> <span class="token parameter variable">--vcpus</span> <span class="token number">2</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--network</span> <span class="token assign-left variable">network</span><span class="token operator">=</span>default,model<span class="token operator">=</span>virtio <span class="token punctuation">\</span>
<span class="token parameter variable">--disk</span> <span class="token assign-left variable">path</span><span class="token operator">=</span>ws2012.qcow2,format<span class="token operator">=</span>qcow2,device<span class="token operator">=</span>disk,bus<span class="token operator">=</span>virtio <span class="token punctuation">\</span>
<span class="token parameter variable">--cdrom</span> cn_windows_server_2012_r2_with_update_x64_dvd_6052725.iso <span class="token punctuation">\</span>
<span class="token parameter variable">--disk</span> <span class="token assign-left variable">path</span><span class="token operator">=</span>virtio-win-0.1.185.iso,device<span class="token operator">=</span>cdrom <span class="token punctuation">\</span>
<span class="token parameter variable">--graphics</span> vnc,listen<span class="token operator">=</span><span class="token number">0.0</span>.0.0 --os-type windows --os-variant win2k12 <span class="token punctuation">\</span>
<span class="token parameter variable">--boot</span> cdrom,menu<span class="token operator">=</span>on<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>其他虚拟机管理命令</p>
<ol>
<li><p>列出虚拟机：<code>virsh list --all</code></p>
</li>
<li><p>强制停止虚拟机：<code>virsh destroy &lt;虚拟机名字&gt;</code></p>
</li>
<li><p>删除虚拟机：<code>virsh undefine &lt;虚拟机名字&gt;</code></p>
</li>
<li><p>关闭虚拟机：<code>virsh shutdown &lt;虚拟机名字&gt;</code></p>
</li>
<li><p>重启虚拟机：<code>virsh reboot &lt;虚拟机名字&gt;</code></p>
</li>
</ol>
</li>
</ul>
</li>
<li><p>打开<code>RealNVC</code>工具，在地址栏输入虚拟机的<code>ip:&lt;端口&gt;</code>通过VNC远程登录启动的windows server虚拟机。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/10/17/2023-10-17-1697516315.png" alt="1697516314212.png" title="1697516314212.png" />

 <img src="https://vault.taojie.fun:28089/i/2023/10/17/2023-10-17-1697517646.png" alt="1697517645685.png" title="1697517645685.png" />

<blockquote>
<p>作业3：在系统安装界面截图上传。</p>
</blockquote>
</li>
<li><p>如果没有看到系统安装界面，在远程窗口中点击发送<code>ctrl+alt+delete</code>重启虚拟机，选择CD-ROM所在分区启动。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/10/17/2023-10-17-1697517878.png" alt="1697517877178.png" title="1697517877178.png" />

<blockquote>
<p>系统密钥：NB4WH-BBBYV-3MPPC-9RCMV-46XCB<br>安装系统时选择第二个带GUI桌面的标准版，安装方式选择第二个。</p>
</blockquote>
 <img src="https://vault.taojie.fun:28089/i/2023/10/17/2023-10-17-1697517975.png" alt="1697517974873.png" title="1697517974873.png" />

 <img src="https://vault.taojie.fun:28089/i/2023/10/17/2023-10-17-1697518046.png" alt="1697518045888.png" title="1697518045888.png" />
</li>
<li><p>选择<code>加载驱动程序</code>-&gt;<code>浏览</code>从以下路径加载scsi和网络驱动。</p>
<blockquote>
<p>D:\virtio-win-0.1.185\viostor\2k12r2\amd64<br>D:\virtio-win-0.1.185\NETKVM\2k12r2\amd64</p>
</blockquote>
 <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696737650.png" alt="1696737648562.png" title="1696737648562.png" />
</li>
<li><p>选择<code>驱动器0</code>、点下一步安装系统等系统安装完成后重启。</p>
</li>
<li><p>如果没有看到系统安装界面，在远程窗口中点击发送<code>ctrl+alt+delete</code>重启虚拟机，选择<code>Virtio disk</code>所在分区启动。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/10/17/2023-10-17-1697518237.png" alt="1697518236332.png" title="1697518236332.png" />
</li>
<li><p>进入系统后使用<code>win+x</code>进入系统-&gt;更改设置-&gt;远程，按下图配置允许远程登录。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/10/16/2023-10-16-1697463773.png" alt="1697463771888.png" title="1697463771888.png" />

 <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696739234.png" alt="1696739233738.png" title="1696739233738.png" />
</li>
<li><p>回到windows虚拟机下载Cloudbase-Init并安装。</p>
<p> 开始菜单打开IE浏览器，地址栏输入<code>https://cloudbase.it/downloads/CloudbaseInitSetup_1_1_2_x64.msi</code>下载软件后运行。</p>
</li>
<li><p>启动安装向导后设置初始化选项、完成安装。</p>
 <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696739848.png" alt="1696739847088.png" title="1696739847088.png" />

 <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696739861.png" alt="1696739859425.png" title="1696739859425.png" />

 <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696739904.png" alt="1696739903072.png" title="1696739903072.png" />

 <img src="https://vault.taojie.fun:28089/i/2023/10/08/2023-10-08-1696739923.png" alt="1696739922332.png" title="1696739922332.png" />
</li>
<li><p><code>xnode1</code>虚拟机查看<code>ws2012</code>的运行状态。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@xnode1 ~<span class="token punctuation">]</span><span class="token comment"># virsh list --all</span>
Id    Name                           State
----------------------------------------------------
-     ws2012                         shut off<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="验证windows-server定制结果"><a href="#验证windows-server定制结果" class="headerlink" title="验证windows-server定制结果"></a>验证windows-server定制结果</h3><ol>
<li><p>将生成的<code>ws2012.qcow2</code>传到Windows本地桌面、然后关闭<code>xnode1</code>。</p>
</li>
<li><p>打开控制节点和计算节点，上传<code>ws2012.qcow2</code>镜像到OpenStack。</p>
</li>
<li><p>执行<code>source admin-login</code>命令行登录，在控制节点上执行以下命令创建虚拟网络、子网、实例类型。</p>
<ol>
<li><p>创建网络</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack network create --share --external --provider-network-type flat --provider-physical-network provider --project admin test_net</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>创建子网</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack subnet create --network test_net --subnet-range 192.168.20.0/24 --gateway 192.168.20.2 --allocation-pool start=192.168.20.128,end=192.168.20.140 --dns-nameserver 114.114.114.114 test_subnet</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>创建实例类型</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack flavor create --public test_flavor --id auto --ram 2048 --disk 20 --vcpus 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
</li>
<li><p>登录图形界面创建实例查看控制台。</p>
</li>
</ol>
<img src="https://vault.taojie.fun:28089/i/2023/10/17/2023-10-17-1697509897.png" alt="1697509896041.png" title="1697509896041.png" />

<blockquote>
<p>作业3：windows实例启动并登录后截图上传。</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/20/private_clouds/4.OpenStack%E9%95%9C%E5%83%8F%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/09/20/private_clouds/4.OpenStack%E9%95%9C%E5%83%8F%E7%AE%A1%E7%90%86/" class="post-title-link" itemprop="url">OpenStack镜像管理与制作（一）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-09-20 20:00:51" itemprop="dateCreated datePublished" datetime="2023-09-20T20:00:51+08:00">2023-09-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-06 15:52:23" itemprop="dateModified" datetime="2023-10-06T15:52:23+08:00">2023-10-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Glance服务介绍"><a href="#Glance服务介绍" class="headerlink" title="Glance服务介绍"></a>Glance服务介绍</h2><p>Glance服务是OpenStack平台的镜像服务，它提供了管理虚拟机镜像的功能。</p>
<p>在OpenStack Glance组件中，镜像（Image）是指虚拟机的模板，包含了预先配置的操作系统和应用程序。镜像是创建和部署虚拟机实例的基础。</p>
<ul>
<li><p>Glance主要特点和功能：</p>
<ol>
<li><p>镜像存储和管理：Glance提供了一个可靠的存储系统，用于持久化保存虚拟机镜像。它支持多种后端存储选项，如本地文件系统、分布式文件系统和对象存储。用户可以通过Glance API上传、删除、更新和查询镜像。</p>
</li>
<li><p>镜像加速和缓存：Glance支持镜像的加速和缓存，以提高虚拟机实例的启动速度和性能。通过将常用的镜像缓存在计算节点上，可以减少下载和传输时间。</p>
</li>
<li><p>镜像格式支持：Glance支持多种虚拟机镜像格式，包括常见的格式如QCOW2、VHD、VMDK和RAW等。这使得用户可以使用不同的镜像格式来满足其特定的需求。</p>
</li>
<li><p>元数据管理：Glance允许用户为每个镜像添加自定义元数据，包括镜像名称、描述、操作系统类型、版本等信息。这些元数据可以帮助用户更好地组织和搜索镜像库。</p>
</li>
<li><p>镜像共享：Glance支持镜像的共享功能，允许用户将自己的镜像分享给其他项目或用户。这样可以避免重复创建相同的镜像，提高资源的共享和重用。</p>
</li>
</ol>
</li>
</ul>
<img src="https://vault.taojie.fun:28089/i/2023/09/20/2023-09-20-1695216464.png" alt="1695216462264.png" title="1695216462264.png" />

<h3 id="Glance架构"><a href="#Glance架构" class="headerlink" title="Glance架构"></a>Glance架构</h3><img src="https://vault.taojie.fun:28089/i/2023/09/20/2023-09-20-1695214714.png" alt="1695214713001.png" title="1695214713001.png" />

<ul>
<li><p>Glance API：用户与 Glance 服务交互的接口，通过 RESTful API 提供了镜像管理的各种功能。用户可以通过 API 执行镜像的上传、下载、删除等操作。</p>
</li>
<li><p>Glance Registry：用于存储和管理镜像的元数据，如名称、格式、大小等。</p>
</li>
<li><p>Glance Store：Glance 的后端存储组件，负责实际的镜像文件的存储。它可以支持多种后端存储类型，如本地文件系统、Swift、Ceph、S3 等。根据配置，镜像可以存储在不同的后端存储中。</p>
</li>
<li><p>Database：数据库用于存储 Glance 服务的持久化数据，包括镜像的元数据、权限信息等。</p>
</li>
</ul>
<h2 id="Glance服务安装"><a href="#Glance服务安装" class="headerlink" title="Glance服务安装"></a>Glance服务安装</h2><h3 id="作业与实验环境"><a href="#作业与实验环境" class="headerlink" title="作业与实验环境"></a>作业与实验环境</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://wxstc.fanya.chaoxing.com/portal">超星网址</a><br><code>快照管理</code>：控制节点选择<code>快照项目6</code>，计算节点不需要设置</p>
</blockquote>
<h3 id="安装与配置"><a href="#安装与配置" class="headerlink" title="安装与配置"></a>安装与配置</h3><ol>
<li><p>执行命令安装Glance软件包：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># yum -y install openstack-glance</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> 安装结束后能够通过以下命令查看系统中的同名用户和用户组表示Glance组件安装完成：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/passwd |grep glance       # 1. 查看glance用户</span>
glance:x:161:161:OpenStack Glance Daemons:/var/lib/glance:/sbin/nologin
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/group |grep glance        # 2. 查看glance用户组</span>
glance:x:161:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>创建数据库并授权：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 进入数据库</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># mysql -uroot -p000000</span>
Welcome to the MariaDB monitor.  Commands end with <span class="token punctuation">;</span> or <span class="token punctuation">\</span>g.
Your MariaDB connection <span class="token function">id</span> is <span class="token number">64</span>
Server version: <span class="token number">10.3</span>.20-MariaDB MariaDB Server

Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2000</span>, <span class="token number">2018</span>, Oracle, MariaDB Corporation Ab and others.

Type <span class="token string">'help;'</span> or <span class="token string">'\h'</span> <span class="token keyword">for</span> help. Type <span class="token string">'\c'</span> to <span class="token function">clear</span> the current input statement.

<span class="token comment"># 2. 创建glance数据库</span>
MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> CREATE DATABASE glance<span class="token punctuation">;</span>
Query OK, <span class="token number">1</span> row affected <span class="token punctuation">(</span><span class="token number">0.000</span> sec<span class="token punctuation">)</span>

<span class="token comment"># 3. 为glance数据库授予本地登录用户的权限</span>
MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> GRANT ALL PRIVILEGES ON glance.* TO <span class="token string">'glance'</span>@<span class="token string">'localhost'</span> IDENTIFIED BY <span class="token string">'000000'</span><span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.001</span> sec<span class="token punctuation">)</span>

<span class="token comment"># 4. 为glance数据库授予远程登录用户的权限</span>
MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> GRANT ALL PRIVILEGES ON glance.* TO <span class="token string">'glance'</span>@<span class="token string">'%'</span> IDENTIFIED BY <span class="token string">'000000'</span><span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.000</span> sec<span class="token punctuation">)</span>
<span class="token comment"># 5. 退出</span>
MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> quit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>修改配置文件：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 备份配置文件</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># cp /etc/glance/glance-api.conf /etc/glance/glance-api.bak</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 删除配置文件中的空行和注释行</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># grep -Ev '^$|#' /etc/glance/glance-api.bak > /etc/glance/glance-api.conf</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p> 打开配置文件依次编辑以下字段：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 数据库地址</span>
<span class="token punctuation">[</span>database<span class="token punctuation">]</span>
connection <span class="token operator">=</span> mysql+pymysql://glance:000000@controller/glance<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 身份凭证配置</span>
<span class="token punctuation">[</span>keystone_authtoken<span class="token punctuation">]</span>
auth_url <span class="token operator">=</span> http://controller:5000
memcached_servers <span class="token operator">=</span> controller:11211
auth_type <span class="token operator">=</span> password
username <span class="token operator">=</span> glance
password <span class="token operator">=</span> 000000
project_name <span class="token operator">=</span> project
user_domain_name <span class="token operator">=</span> Default
project_domain_name <span class="token operator">=</span> Default<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 身份凭证配置</span>
<span class="token punctuation">[</span>paste_deploy<span class="token punctuation">]</span>
flavor <span class="token operator">=</span> keystone<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 后端存储配置</span>
<span class="token punctuation">[</span>glance_store<span class="token punctuation">]</span>
stores <span class="token operator">=</span> <span class="token function">file</span>
default_store <span class="token operator">=</span> <span class="token function">file</span>
filesystem_store_datadir <span class="token operator">=</span> /var/lib/glance/images/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>初始化Glance数据库</p>
<ul>
<li><p>数据库同步</p>
  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># su glance -s /bin/sh -c "glance-manage db_sync"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>查看同步后的数据表</p>
  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># mysql -uroot -p000000      # 1. 数据库登录</span>
Welcome to the MariaDB monitor.  Commands end with <span class="token punctuation">;</span> or <span class="token punctuation">\</span>g.
Your MariaDB connection <span class="token function">id</span> is <span class="token number">270</span>
Server version: <span class="token number">10.3</span>.20-MariaDB MariaDB Server

Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2000</span>, <span class="token number">2018</span>, Oracle, MariaDB Corporation Ab and others.

Type <span class="token string">'help;'</span> or <span class="token string">'\h'</span> <span class="token keyword">for</span> help. Type <span class="token string">'\c'</span> to <span class="token function">clear</span> the current input statement.

MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> use glance<span class="token punctuation">;</span>                   <span class="token comment"># 2. 进入glance数据库</span>
Reading table information <span class="token keyword">for</span> completion of table and <span class="token function">column</span> names
You can turn off this feature to get a quicker startup with <span class="token parameter variable">-A</span>

Database changed
MariaDB <span class="token punctuation">[</span>glance<span class="token punctuation">]</span><span class="token operator">></span> show tables<span class="token punctuation">;</span>                  <span class="token comment"># 3. 显示数据表</span>
+----------------------------------+
<span class="token operator">|</span> Tables_in_glance                 <span class="token operator">|</span>
+----------------------------------+
<span class="token operator">|</span> alembic_version                  <span class="token operator">|</span>
<span class="token operator">|</span> image_locations                  <span class="token operator">|</span>
<span class="token operator">|</span> image_members                    <span class="token operator">|</span>
<span class="token operator">|</span> image_properties                 <span class="token operator">|</span>
<span class="token operator">|</span> image_tags                       <span class="token operator">|</span>
<span class="token operator">|</span> images                           <span class="token operator">|</span>
<span class="token operator">|</span> metadef_namespace_resource_types <span class="token operator">|</span>
<span class="token operator">|</span> metadef_namespaces               <span class="token operator">|</span>
<span class="token operator">|</span> metadef_objects                  <span class="token operator">|</span>
<span class="token operator">|</span> metadef_properties               <span class="token operator">|</span>
<span class="token operator">|</span> metadef_resource_types           <span class="token operator">|</span>
<span class="token operator">|</span> metadef_tags                     <span class="token operator">|</span>
<span class="token operator">|</span> migrate_version                  <span class="token operator">|</span>
<span class="token operator">|</span> task_info                        <span class="token operator">|</span>
<span class="token operator">|</span> tasks                            <span class="token operator">|</span>
+----------------------------------+
<span class="token number">15</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.000</span> sec<span class="token punctuation">)</span>
MariaDB <span class="token punctuation">[</span>glance<span class="token punctuation">]</span><span class="token operator">></span> quit                          <span class="token comment"># 4. 退出</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<blockquote>
<p>作业1：显示数据表后后截图上传</p>
</blockquote>
</li>
</ol>
<h3 id="Glance初始化"><a href="#Glance初始化" class="headerlink" title="Glance初始化"></a>Glance初始化</h3><ol>
<li><p>创建Glance用户、分配角色</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 利用环境变量登录</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># source admin-login</span>
<span class="token comment"># 2. 创建用户</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack user create --domain default --password 000000 glance</span>
+---------------------+----------------------------------+
<span class="token operator">|</span> Field               <span class="token operator">|</span> Value                            <span class="token operator">|</span>
+---------------------+----------------------------------+
<span class="token operator">|</span> domain_id           <span class="token operator">|</span> default                          <span class="token operator">|</span>
<span class="token operator">|</span> enabled             <span class="token operator">|</span> True                             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token function">id</span>                  <span class="token operator">|</span> 504c914efe01478a9da5968a88dad987 <span class="token operator">|</span>

<span class="token operator">|</span> options             <span class="token operator">|</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>                               <span class="token operator">|</span>
<span class="token operator">|</span> password_expires_at <span class="token operator">|</span> None                             <span class="token operator">|</span>
+---------------------+----------------------------------+
<span class="token comment"># 3. 添加角色</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack role add --project project --user glance admin</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>创建服务和端点</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 创建服务</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack service create --name glance image</span>
+---------+----------------------------------+
<span class="token operator">|</span> Field   <span class="token operator">|</span> Value                            <span class="token operator">|</span>
+---------+----------------------------------+
<span class="token operator">|</span> enabled <span class="token operator">|</span> True                             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token function">id</span>      <span class="token operator">|</span> da84735108944b6690cbcf9fab56f5fd <span class="token operator">|</span>
<span class="token operator">|</span> name    <span class="token operator">|</span> glance                           <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token builtin class-name">type</span>    <span class="token operator">|</span> image                            <span class="token operator">|</span>
+---------+----------------------------------+
<span class="token comment"># 2. 创建公共用户使用的端点</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack endpoint create --region RegionOne glance public http://controller:9292</span>
+--------------+----------------------------------+
<span class="token operator">|</span> Field        <span class="token operator">|</span> Value                            <span class="token operator">|</span>
+--------------+----------------------------------+
<span class="token operator">|</span> enabled      <span class="token operator">|</span> True                             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token function">id</span>           <span class="token operator">|</span> a344eb651ebc41f7ae2b1b74b3e8fda3 <span class="token operator">|</span>
<span class="token operator">|</span> interface    <span class="token operator">|</span> public                           <span class="token operator">|</span>
<span class="token operator">|</span> region       <span class="token operator">|</span> RegionOne                        <span class="token operator">|</span>
<span class="token operator">|</span> region_id    <span class="token operator">|</span> RegionOne                        <span class="token operator">|</span>
<span class="token operator">|</span> service_id   <span class="token operator">|</span> da84735108944b6690cbcf9fab56f5fd <span class="token operator">|</span>
<span class="token operator">|</span> service_name <span class="token operator">|</span> glance                           <span class="token operator">|</span>
<span class="token operator">|</span> service_type <span class="token operator">|</span> image                            <span class="token operator">|</span>
<span class="token operator">|</span> url          <span class="token operator">|</span> http://controller:9292           <span class="token operator">|</span>
+--------------+----------------------------------+
<span class="token comment"># 3. 创建内部组件用户使用的端点</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack endpoint create --region RegionOne glance internal http://controller:9292</span>
+--------------+----------------------------------+
<span class="token operator">|</span> Field        <span class="token operator">|</span> Value                            <span class="token operator">|</span>
+--------------+----------------------------------+
<span class="token operator">|</span> enabled      <span class="token operator">|</span> True                             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token function">id</span>           <span class="token operator">|</span> f1b7a33ab36047209e0130debf4dc500 <span class="token operator">|</span>
<span class="token operator">|</span> interface    <span class="token operator">|</span> internal                         <span class="token operator">|</span>
<span class="token operator">|</span> region       <span class="token operator">|</span> RegionOne                        <span class="token operator">|</span>
<span class="token operator">|</span> region_id    <span class="token operator">|</span> RegionOne                        <span class="token operator">|</span>
<span class="token operator">|</span> service_id   <span class="token operator">|</span> da84735108944b6690cbcf9fab56f5fd <span class="token operator">|</span>
<span class="token operator">|</span> service_name <span class="token operator">|</span> glance                           <span class="token operator">|</span>
<span class="token operator">|</span> service_type <span class="token operator">|</span> image                            <span class="token operator">|</span>
<span class="token operator">|</span> url          <span class="token operator">|</span> http://controller:9292           <span class="token operator">|</span>
+--------------+----------------------------------+
<span class="token comment"># 4. 创建admin用户使用的端点</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack endpoint create --region RegionOne glance admin http://controller:9292</span>
+--------------+----------------------------------+
<span class="token operator">|</span> Field        <span class="token operator">|</span> Value                            <span class="token operator">|</span>
+--------------+----------------------------------+
<span class="token operator">|</span> enabled      <span class="token operator">|</span> True                             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token function">id</span>           <span class="token operator">|</span> c176c6ff1caa4eba9083105bd2b41261 <span class="token operator">|</span>
<span class="token operator">|</span> interface    <span class="token operator">|</span> admin                            <span class="token operator">|</span>
<span class="token operator">|</span> region       <span class="token operator">|</span> RegionOne                        <span class="token operator">|</span>
<span class="token operator">|</span> region_id    <span class="token operator">|</span> RegionOne                        <span class="token operator">|</span>
<span class="token operator">|</span> service_id   <span class="token operator">|</span> da84735108944b6690cbcf9fab56f5fd <span class="token operator">|</span>
<span class="token operator">|</span> service_name <span class="token operator">|</span> glance                           <span class="token operator">|</span>
<span class="token operator">|</span> service_type <span class="token operator">|</span> image                            <span class="token operator">|</span>
<span class="token operator">|</span> url          <span class="token operator">|</span> http://controller:9292           <span class="token operator">|</span>
+--------------+----------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>启动Glance服务并验证</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 设置开机自启</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable openstack-glance-api</span>
Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-glance-api.service to /usr/lib/systemd/system/openstack-glance-api.service.
<span class="token comment"># 2. 启动服务</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># systemctl start openstack-glance-api</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token comment"># 3. 查看服务状态</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># systemctl status openstack-glance-api</span>
● openstack-glance-api.service - OpenStack Image Service <span class="token punctuation">(</span>code-named Glance<span class="token punctuation">)</span> API server
Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/openstack-glance-api.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Wed <span class="token number">2023</span>-09-20 <span class="token number">11</span>:18:59 EDT<span class="token punctuation">;</span> 13s ago
Main PID: <span class="token number">5068</span> <span class="token punctuation">(</span>glance-api<span class="token punctuation">)</span>
CGroup: /system.slice/openstack-glance-api.service
        ├─5068 /usr/bin/python2 /usr/bin/glance-api
        ├─5080 /usr/bin/python2 /usr/bin/glance-api
        └─5081 /usr/bin/python2 /usr/bin/glance-api

Sep <span class="token number">20</span> <span class="token number">11</span>:18:59 controller systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Started OpenStack Image Service <span class="token punctuation">(</span>code-named Glance<span class="token punctuation">)</span> API server.
Sep <span class="token number">20</span> <span class="token number">11</span>:18:59 controller glance-api<span class="token punctuation">[</span><span class="token number">5068</span><span class="token punctuation">]</span>: /usr/lib/python2.7/site-packages/paste/deploy/loadwsgi.py:22: PkgRe<span class="token punctuation">..</span>.tely.
Sep <span class="token number">20</span> <span class="token number">11</span>:18:59 controller glance-api<span class="token punctuation">[</span><span class="token number">5068</span><span class="token punctuation">]</span>: <span class="token builtin class-name">return</span> pkg_resources.EntryPoint.parse<span class="token punctuation">(</span><span class="token string">"x="</span> + s<span class="token punctuation">)</span>.load<span class="token punctuation">(</span>False<span class="token punctuation">)</span>
Hint: Some lines were ellipsized, use <span class="token parameter variable">-l</span> to show <span class="token keyword">in</span> full.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>创建镜像</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 获取镜像文件到本地</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># curl -O http://download.cirros-cloud.net/0.5.1/cirros-0.5.1-x86_64-disk.img</span>
% Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                Dload  Upload   Total   Spent    Left  Speed
<span class="token number">100</span>   <span class="token number">273</span>  <span class="token number">100</span>   <span class="token number">273</span>    <span class="token number">0</span>     <span class="token number">0</span>     <span class="token number">40</span>      <span class="token number">0</span>  <span class="token number">0</span>:00:06  <span class="token number">0</span>:00:06 --:--:--    <span class="token number">65</span>
<span class="token comment"># 2. 创建镜像</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack image create --file cirros-0.5.1-x86_64-disk.img --disk-format raw --container-format bare --public cirros</span>
<span class="token comment"># 3. 查看镜像列表</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack image list</span>
+--------------------------------------+--------+--------+
<span class="token operator">|</span> ID                                   <span class="token operator">|</span> Name   <span class="token operator">|</span> Status <span class="token operator">|</span>
+--------------------------------------+--------+--------+G
<span class="token operator">|</span> cfd3a7d5-3339-4d11-8c18-18c6d703c03b <span class="token operator">|</span> cirros <span class="token operator">|</span> active <span class="token operator">|</span>
+--------------------------------------+--------+--------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>作业2：显示镜像列表后截图上传</p>
</blockquote>
</li>
</ol>
<h2 id="基于预制镜像定制OpenStack镜像"><a href="#基于预制镜像定制OpenStack镜像" class="headerlink" title="基于预制镜像定制OpenStack镜像"></a>基于预制镜像定制OpenStack镜像</h2><h3 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h3><blockquote>
<p>控制节点和计算节点都是<code>快照项目12</code></p>
</blockquote>
<h3 id="Centos镜像创建"><a href="#Centos镜像创建" class="headerlink" title="Centos镜像创建"></a>Centos镜像创建</h3><ol>
<li><p>设置虚拟机和宿主机共享</p>
<ul>
<li><p>控制节点关机状态右键-&gt;设置，选择选项-&gt;共享文件夹-&gt;总是启用并添加本地D盘内的镜像文件所在目录</p>
  <img src="https://vault.taojie.fun:28089/i/2023/09/21/2023-09-21-1695229069.png" alt="1695229067851.png" title="1695229067851.png" />
</li>
<li><p>安装vm-tools并挂载设备</p>
  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># yum -y install open-vm-tools</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># vmhgfs-fuse .host:/ /mnt/hgfs -o subtype=vmhgfs-fuse,allow_other</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># file /mnt/hgfs/镜像/CentOS-7-x86_64-GenericCloud-2003.qcow2</span>
/mnt/hgfs/镜像/CentOS-7-x86_64-GenericCloud-2003.qcow2: QEMU QCOW Image <span class="token punctuation">(</span>v3<span class="token punctuation">)</span>, <span class="token number">8589934592</span> bytes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
</li>
<li><p>创建镜像</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack image create --disk-format qcow2 --container-format bare   --public --file /mnt/hgfs/镜像/CentOS-7-x86_64-GenericCloud-2003.qcow2 centos7</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
<h3 id="创建虚拟机实例"><a href="#创建虚拟机实例" class="headerlink" title="创建虚拟机实例"></a>创建虚拟机实例</h3><ol>
<li><p>通过浏览器<code>192.168.10.20</code>访问Horizon服务的界面，设置域名<code>Default</code>、用户名<code>admin</code>、密码<code>000000</code>登录。</p>
</li>
<li><p>创建实例类型、网络。</p>
<blockquote>
<p>创建<code>实例类型</code>和<code>网络</code>时设置项目为admin，否则没有权限。可参考<a target="_blank" rel="noopener" href="https://abc.taojie.fun/2023/09/08/private_clouds/2.openstack%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/#%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%AE%9E%E4%BE%8B">创建虚拟机实例</a>创建网络。</p>
</blockquote>
 <img src="https://vault.taojie.fun:28089/i/2023/09/21/2023-09-21-1695230412.png" alt="1695230410573.png" title="1695230410573.png" />
</li>
<li><p>设置<code>配置</code>菜单后完成实例创建：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token function">passwd</span> centos<span class="token operator">&lt;&lt;</span><span class="token string">EOF
000000
000000
EOF</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>这里配置的脚本用来在实例启动时设置centos账户的密码，否则不能登录控制台</p>
</blockquote>
 <img src="https://vault.taojie.fun:28089/i/2023/09/21/2023-09-21-1695233149.png" alt="1695233147185.png" title="1695233147185.png" /></li>
</ol>
<h3 id="定制镜像"><a href="#定制镜像" class="headerlink" title="定制镜像"></a>定制镜像</h3><ol>
<li><p>在实例控制台中完成配置：</p>
<blockquote>
<p>使用账号：centos；密码：000000登录控制台</p>
</blockquote>
<ol>
<li><p><code>sudo su</code>命令切换root用户</p>
</li>
<li><p><code>passwd root</code>命令设置密码000000</p>
</li>
<li><p>编辑文件<code>/etc/cloud/cloud.cfg</code>修改第四行为<code>disable_root:0</code></p>
</li>
<li><p>重启实例使用root用户登录。</p>
</li>
</ol>
</li>
<li><p>创建快照后基于新的快照创建实例，验证root用户直接登录控制台</p>
 <img src="https://vault.taojie.fun:28089/i/2023/09/21/2023-09-21-1695235685.png" alt="1695235684061.png" title="1695235684061.png" />

 <img src="https://vault.taojie.fun:28089/i/2023/09/21/2023-09-21-1695235198.png" alt="1695235196457.png" title="1695235196457.png" />

 <img src="https://vault.taojie.fun:28089/i/2023/09/21/2023-09-21-1695235388.png" alt="1695235386127.png" title="1695235386127.png" />

<blockquote>
<p>作业3：登录控制台后截图上传</p>
</blockquote>
</li>
<li><p>实例快照转换成镜像</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 查看镜像列表获取ID</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack image list</span>
+--------------------------------------+-------------+--------+
<span class="token operator">|</span> ID                                   <span class="token operator">|</span> Name        <span class="token operator">|</span> Status <span class="token operator">|</span>
+--------------------------------------+-------------+--------+
<span class="token operator">|</span> 87b290e8-57c9-4c27-bb77-9d312c6d96c2 <span class="token operator">|</span> centos7     <span class="token operator">|</span> active <span class="token operator">|</span>
<span class="token operator">|</span> 26b59df3-4fbe-4368-abd9-a5e5b58efe50 <span class="token operator">|</span> centos_test <span class="token operator">|</span> active <span class="token operator">|</span>
<span class="token operator">|</span> 3a211d53-30e2-4d42-a7cf-ee55786b176a <span class="token operator">|</span> cirros      <span class="token operator">|</span> active <span class="token operator">|</span>
+--------------------------------------+-------------+--------+
<span class="token comment"># 2. 将本地快照文件转换成镜像</span>
<span class="token punctuation">[</span>root@controller ~<span class="token punctuation">]</span><span class="token comment"># openstack image create centos_test_image --file /var/lib/glance/images/26b59df3-4fbe-4368-abd9-a5e5b58efe50  --disk-format qcow2 --container-format bare</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/source/index.md/page/2/">2</a><a class="page-number" href="/source/index.md/page/3/">3</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/source/index.md/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder"></span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
